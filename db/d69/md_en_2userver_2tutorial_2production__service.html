<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: Production configs and best practices</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('db/d69/md_en_2userver_2tutorial_2production__service.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Production configs and best practices</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md783"></a> A good production ready service should have functionality for various cases:</p><ul>
<li>Overload<ul>
<li>Service should respond with HTTP 429 codes to some requests while still being able to handle the rest</li>
</ul>
</li>
<li>Debugging of a running service<ul>
<li>inspect logs</li>
<li>get more logs from the suspiciously behaving service and then turn the logging level back</li>
<li>profile memory usage</li>
<li>see requests in flight</li>
</ul>
</li>
<li>Experiments<ul>
<li>Should be a way to turn on/off arbitrary functionality without restarting the service</li>
</ul>
</li>
<li>Metrics and Logs</li>
<li>Functional testing</li>
</ul>
<p>This tutorial shows a configuration of a typical production ready service. For information about service interactions with other utilities and services in container see <a class="el" href="../../d2/d58/md_en_2userver_2deploy__env.html">Deploy Environment Specific Configurations</a>.</p>
<h1><a class="anchor" id="autotoc_md784"></a>
Before you start</h1>
<p>Make sure that you can compile and run core tests and read a basic example <a class="el" href="../../da/d16/md_en_2userver_2tutorial_2hello__service.html">Writing your first HTTP server</a>.</p>
<h1><a class="anchor" id="autotoc_md785"></a>
int main</h1>
<p><a class="el" href="../../d6/d84/namespaceutils.html#a5047c1275f53e699e26869c045ad3697">utils::DaemonMain</a> initializes and starts the component system with the provided command line arguments:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;userver/alerts/handler.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d1/d1c/common__component__list_8hpp.html" title="Returns the most common list of components with runtime config updates and HTTP client.">userver/components/common_component_list.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../dc/dec/common__server__component__list_8hpp.html" title="Returns the most common list of components to start a fully functional server.">userver/components/common_server_component_list.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d8/d39/ping_8hpp.html" title="Handler that returns HTTP 200 if the service is OK and able to process requests.">userver/server/handlers/ping.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../dd/d60/core_2include_2userver_2storages_2secdist_2component_8hpp.html" title="Component that stores security related data (keys, passwords, ...).">userver/storages/secdist/component.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;userver/storages/secdist/provider_component.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d7/de0/daemon__run_8hpp.html" title="Functions to start a daemon with specified components list.">userver/utils/daemon_run.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> component_list = <a class="code hl_class" href="../../dc/df0/classcomponents_1_1ComponentList.html" title="A list to keep a unique list of components to start with components::Run(), utils::DaemonMain() or co...">components::ComponentList</a>()</div>
<div class="line">                                    .<a class="code hl_function" href="../../dc/df0/classcomponents_1_1ComponentList.html#ab2c7efc43f9cc35cd2bfe3729a1064fc" title="Merges components from other into *this.">AppendComponentList</a>(<a class="code hl_function" href="../../dd/d1c/group__userver__components.html#ga447b5378f8d2a465ce2d6b25da09b44c" title="Returns the most common list of components with runtime config updates and HTTP client.">components::CommonComponentList</a>())</div>
<div class="line">                                    .<a class="code hl_function" href="../../dc/df0/classcomponents_1_1ComponentList.html#ab2c7efc43f9cc35cd2bfe3729a1064fc" title="Merges components from other into *this.">AppendComponentList</a>(<a class="code hl_function" href="../../dd/d1c/group__userver__components.html#gaad51991fd3cbb1c5463c9cda8e41cdbb" title="Returns the most common list of components to start a fully functional server.">components::CommonServerComponentList</a>())</div>
<div class="line">                                    .<a class="code hl_function" href="../../dc/df0/classcomponents_1_1ComponentList.html#aac1091016f393791732a7da6aaf27f48" title="Appends a component with default component name Component::kName.">Append</a>&lt;<a class="code hl_class" href="../../da/dc7/classcomponents_1_1Secdist.html" title="Component that stores security related data (keys, passwords, ...).">components::Secdist</a>&gt;()</div>
<div class="line">                                    .Append&lt;components::DefaultSecdistProvider&gt;()</div>
<div class="line">                                    .Append&lt;<a class="code hl_class" href="../../d7/d6d/classserver_1_1handlers_1_1Ping.html" title="Handler that returns HTTP 200 if the service is OK and able to process requests.">server::handlers::Ping</a>&gt;()</div>
<div class="line">                                    .Append&lt;alerts::Handler&gt;()</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Put your handlers and components here</span></div>
<div class="line">        ;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_function" href="../../d6/d84/namespaceutils.html#a5047c1275f53e699e26869c045ad3697">utils::DaemonMain</a>(argc, argv, component_list);</div>
<div class="line">}</div>
</div><!-- fragment --><p>A path to the static config file should be passed from a command line to start the service:</p>
<div class="fragment"><div class="line">bash</div>
<div class="line">./samples/userver-samples-production_service --config /etc/production-service/static_config.yaml</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md786"></a>
Static config</h1>
<p>Full static config could be seen at <a class="el" href="../../df/d22/samples_2production_service_2static_config_8yaml-example.html">samples/production_service/static_config.yaml</a></p>
<p>Important parts are described down below.</p>
<h2><a class="anchor" id="autotoc_md787"></a>
Variables</h2>
<p>Static configs tend to become quite big, so it is a good idea to move changing parts of it into variables. To do that, declare a <code>config_vars</code> field in the static config and point it to a file with variables.</p>
<div class="fragment"><div class="line"># yaml</div>
<div class="line">config_vars: /etc/production_service/config_vars.yaml</div>
</div><!-- fragment --><p>A file with config variables could look <a class="el" href="../../d8/de0/samples_2production_service_2config_vars_8yaml-example.html">like this</a>.</p>
<p>Now in static config you could use <code>$variable-name</code> to refer to a variable, <code>*#fallback</code> fields are used if there is no variable with such name in the config variables file:</p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        http-client:</div>
<div class="line">            fs-task-processor: fs-task-processor</div>
<div class="line">            user-agent: $server-name</div>
<div class="line">            user-agent#fallback: &#39;userver-based-service 1.0&#39;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md788"></a>
Task processors</h2>
<p>A good practice is to have at least 3 different task processors:</p>
<div class="fragment"><div class="line">    # yaml</div>
<div class="line">    task_processors:</div>
<div class="line">        fs-task-processor:       # for blocking operations</div>
<div class="line">            thread_name: fs-worker</div>
<div class="line">            worker_threads: $fs_worker_threads</div>
<div class="line">            worker_threads#fallback: 2</div>
<div class="line">        main-task-processor:     # for nonblocking operations</div>
<div class="line">            thread_name: main-worker</div>
<div class="line">            worker_threads: $main_worker_threads</div>
<div class="line">            worker_threads#fallback: 6</div>
<div class="line">        monitor-task-processor:  # for monitoring</div>
<div class="line">            thread_name: mon-worker</div>
<div class="line">            worker_threads: $monitor_worker_threads</div>
<div class="line">            worker_threads#fallback: 1</div>
<div class="line">    event_thread_pool:           # ev pools to deal with OS events</div>
<div class="line">        threads: $event_threads</div>
<div class="line">        threads#fallback: 2</div>
</div><!-- fragment --><p>Moving blocking operations into a separate task processor improves responsiveness and CPU usage of your service. Monitor task processor helps to get statistics and diagnostics from server under heavy load or from a server with a deadlocked threads in the main task processor.</p>
<dl class="section warning"><dt>Warning</dt><dd>This setup is for an abstract service on an abstract 8 core machine. Benchmark your service on your hardware and hand-tune the thread numbers to get optimal performance.</dd></dl>
<h2><a class="anchor" id="autotoc_md789"></a>
Listeners/Monitors</h2>
<p>Note the <a class="el" href="../../d0/d0b/classcomponents_1_1Server.html" title="Component that listens for incoming requests, manages incoming connections and passes the requests to...">components::Server</a> configuration:</p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        server:</div>
<div class="line">            listener:</div>
<div class="line">                # If your service is behind nginx or some other local proxy, it is</div>
<div class="line">                # efficient to accepts incoming requests from unix-socket</div>
<div class="line">                #</div>
<div class="line">                # unix-socket: /var/run/production_service/service.socket</div>
<div class="line">                port: $server-port</div>
<div class="line">                port#fallback: 8085</div>
<div class="line">                connection:</div>
<div class="line">                    in_buffer_size: 32768</div>
<div class="line">                    requests_queue_size_threshold: 100</div>
<div class="line">                task_processor: main-task-processor</div>
<div class="line">            listener-monitor:</div>
<div class="line">                # Listen on localhost:8085 for developer/utility requests</div>
<div class="line">                port: $monitor-server-port</div>
<div class="line">                port#fallback: 8086</div>
<div class="line">                connection:</div>
<div class="line">                    in_buffer_size: 32768</div>
<div class="line">                    requests_queue_size_threshold: 100</div>
<div class="line">                task_processor: monitor-task-processor</div>
<div class="line">            logger_access: &#39;&#39;</div>
<div class="line">            logger_access_tskv: &#39;&#39;</div>
<div class="line">            max_response_size_in_flight: 1000000000</div>
<div class="line">            server-name: $server-name</div>
</div><!-- fragment --><p>In this example we have two listeners. it is done to separate clients and utility/diagnostic handlers to listen on different ports or even interfaces.</p>
<p><a class="anchor" id="sample_prod_service_utility_handlers"></a></p>
<h2><a class="anchor" id="autotoc_md790"></a>
Utility handlers</h2>
<p>Your server has the following utility handlers:</p><ul>
<li>to <a class="el" href="../../d8/d7b/md_en_2userver_2requests__in__flight.html">inspect in-flight request</a> - <a class="el" href="../../d8/d67/classserver_1_1handlers_1_1InspectRequests.html" title="Handler that returns information about all in-flight requests.">server::handlers::InspectRequests</a></li>
<li>to <a class="el" href="../../d4/d1a/md_en_2userver_2memory__profile__running__service.html">profile memory usage</a> - <a class="el" href="../../d2/d34/classserver_1_1handlers_1_1Jemalloc.html" title="Handler that controls the jemalloc allocator.">server::handlers::Jemalloc</a></li>
<li>to <a class="el" href="../../d1/de2/md_en_2userver_2log__level__running__service.html">change logging level at runtime</a> - <a class="el" href="../../da/da0/classserver_1_1handlers_1_1LogLevel.html" title="Handler that controls logging levels of all the loggers.">server::handlers::LogLevel</a> and <a class="el" href="../../dd/dea/classserver_1_1handlers_1_1DynamicDebugLog.html" title="Handler for forcing specific lines logging. Feature also known as dynamic debug logging.">server::handlers::DynamicDebugLog</a></li>
<li>to reopen log files after log rotation (you can also use <a class="el" href="../../df/d4e/md_en_2userver_2os__signals.html">signals</a>) - <a class="el" href="../../dc/dde/classserver_1_1handlers_1_1OnLogRotate.html" title="Handler that controls logging levels of all the loggers.">server::handlers::OnLogRotate</a></li>
<li>to <a class="el" href="../../dc/d72/md_en_2userver_2dns__control.html">control the DNS resolver</a> - <a class="el" href="../../d1/d48/classserver_1_1handlers_1_1DnsClientControl.html" title="Handlers that controls the DNS client.">server::handlers::DnsClientControl</a></li>
<li>to <a class="el" href="../../d9/dac/md_en_2userver_2service__monitor.html">get statistics</a> from the service - <a class="el" href="../../dc/d10/classserver_1_1handlers_1_1ServerMonitor.html" title="Handler that returns statistics data.">server::handlers::ServerMonitor</a></li>
</ul>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        handler-inspect-requests:</div>
<div class="line">            path: /service/inspect-requests</div>
<div class="line">            method: GET</div>
<div class="line">            task_processor: monitor-task-processor</div>
<div class="line">        handler-jemalloc:</div>
<div class="line">            path: /service/jemalloc/prof/{command}</div>
<div class="line">            method: POST</div>
<div class="line">            task_processor: monitor-task-processor</div>
<div class="line">        handler-log-level:</div>
<div class="line">            path: /service/log-level/{level}</div>
<div class="line">            method: GET,PUT</div>
<div class="line">            task_processor: monitor-task-processor</div>
<div class="line">        handler-on-log-rotate:</div>
<div class="line">            path: /service/on-log-rotate/</div>
<div class="line">            method: POST</div>
<div class="line">            task_processor: monitor-task-processor</div>
<div class="line">        handler-dynamic-debug-log:</div>
<div class="line">            path: /service/log/dynamic-debug</div>
<div class="line">            method: GET,PUT,DELETE</div>
<div class="line">            task_processor: monitor-task-processor</div>
<div class="line">        handler-dns-client-control:</div>
<div class="line">            path: /service/dnsclient/{command}</div>
<div class="line">            method: POST</div>
<div class="line">            task_processor: monitor-task-processor</div>
<div class="line">        handler-server-monitor:</div>
<div class="line">            path: /service/monitor</div>
<div class="line">            method: GET</div>
<div class="line">            task_processor: monitor-task-processor</div>
<div class="line">        handler-fired-alerts:</div>
<div class="line">            path: /service/fired-alerts</div>
<div class="line">            method: GET</div>
<div class="line">            task_processor: monitor-task-processor</div>
</div><!-- fragment --><p>All those handlers live on a separate <code>components.server.listener-monitor</code> address, so you have to request them using the <code>listener-monitor</code> credentials:</p>
<div class="fragment"><div class="line">bash</div>
<div class="line">$ curl http://localhost:8085/service/log-level/</div>
<div class="line">{&quot;init-log-level&quot;:&quot;info&quot;,&quot;current-log-level&quot;:&quot;info&quot;}</div>
<div class="line"> </div>
<div class="line">$ curl -X PUT &#39;http://localhost:8085/service/log-level/warning&#39;</div>
<div class="line">{&quot;init-log-level&quot;:&quot;info&quot;,&quot;current-log-level&quot;:&quot;warning&quot;}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md791"></a>
Ping</h2>
<p>This is a <a class="el" href="../../d7/d6d/classserver_1_1handlers_1_1Ping.html" title="Handler that returns HTTP 200 if the service is OK and able to process requests.">server::handlers::Ping</a> handle that returns 200 if the service is OK, 500 otherwise. Useful for balancers, that would stop sending traffic to the server if it responds with codes other than 200.</p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        handler-ping:</div>
<div class="line">            path: /ping</div>
<div class="line">            method: GET</div>
<div class="line">            task_processor: main-task-processor  # !!!</div>
<div class="line">            throttling_enabled: false</div>
<div class="line">            url_trailing_slash: strict-match</div>
</div><!-- fragment --><p>Note that the ping handler lives on the task processor of all the other handlers. Smart balancers may measure response times and send less traffic to the heavy loaded services.</p>
<div class="fragment"><div class="line">bash</div>
<div class="line">$ curl --unix-socket service.socket http://localhost/ping -i</div>
<div class="line">HTTP/1.1 200 OK</div>
<div class="line">Date: Thu, 01 Jul 2021 12:46:07 UTC</div>
<div class="line">Content-Type: text/html; charset=utf-8</div>
<div class="line">X-YaRequestId: 39e3f54b86984b8ca5235876dc566b27</div>
<div class="line">Server: sample-production-service 1.0</div>
<div class="line">X-YaTraceId: 4d7f8aa03e2d4e4d80a92a3ccecfbe6d</div>
<div class="line">Connection: keep-alive</div>
<div class="line">Content-Length: 0</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md792"></a>
Dynamic configs</h2>
<p>Here's a configuration of a dynamic config related components <a class="el" href="../../d8/d1f/classcomponents_1_1DynamicConfigClient.html" title="Component that starts a clients::dynamic_config::Client client.">components::DynamicConfigClient</a>, <a class="el" href="../../dd/d1a/classcomponents_1_1DynamicConfig.html" title="Component that stores the dynamic config.">components::DynamicConfig</a>, <a class="el" href="../../d3/da0/classcomponents_1_1DynamicConfigClientUpdater.html" title="Component that does a periodic update of runtime configs.">components::DynamicConfigClientUpdater</a>.</p>
<p>Service starts with some dynamic config values from <code>dynamic-config.fs-cache-path</code> file and updates dynamic values from a <a class="el" href="../../d4/d95/md_en_2userver_2tutorial_2config__service.html">configs service</a> at startup.</p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        dynamic-config:</div>
<div class="line">            updates-enabled: true</div>
<div class="line">            fs-cache-path: $config-cache</div>
<div class="line">            fs-task-processor: fs-task-processor</div>
<div class="line">        dynamic-config-client:</div>
<div class="line">            config-url: $config-server-url</div>
<div class="line">            http-retries: 5</div>
<div class="line">            http-timeout: 20s</div>
<div class="line">            service-name: $service-name</div>
<div class="line">        dynamic-config-client-updater:</div>
<div class="line">            config-settings: false</div>
<div class="line">            first-update-fail-ok: true</div>
<div class="line">            full-update-interval: 1m</div>
<div class="line">            update-interval: 5s</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Dynamic configs is an essential part of a reliable service with high availability. Those could be used as an emergency switch for new functionality, selector for experiments, limits/timeouts/log-level setup, proxy setup. See <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html">Dynamic config schemas</a> for more info and <a class="el" href="../../d4/d95/md_en_2userver_2tutorial_2config__service.html">Writing your own configs server</a> for insights on how to implement such service.</dd></dl>
<h2><a class="anchor" id="autotoc_md793"></a>
Congestion Control</h2>
<p>See <a class="el" href="../../d0/d44/md_en_2userver_2congestion__control.html">Congestion Control</a>.</p>
<p><a class="el" href="../../de/dac/classcongestion__control_1_1Component.html" title="Component to limit too active requests, also known as CC.">congestion_control::Component</a> limits the active requests count. In case of overload it responds with HTTP 429 codes to some requests, allowing your service to properly process handle the rest.</p>
<p>All the significant parts of the component are configured by dynamic config options <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html#USERVER_RPS_CCONTROL">USERVER_RPS_CCONTROL</a> and <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html#USERVER_RPS_CCONTROL_ENABLED">USERVER_RPS_CCONTROL_ENABLED</a></p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        congestion-control:</div>
<div class="line">            fake-mode: $testsuite-enabled</div>
<div class="line">            load-enabled: true</div>
</div><!-- fragment --><p>It is a good idea to disable it in unit tests to avoid getting HTTP 429 on an overloaded CI server.</p>
<p><a class="anchor" id="tutorial_metrics"></a></p>
<h2><a class="anchor" id="autotoc_md794"></a>
Metrics</h2>
<p>Metrics is a convenient way to monitor the health of your service.</p>
<p>Typical setup of <a class="el" href="../../df/df4/classcomponents_1_1SystemStatisticsCollector.html" title="Component for system resource usage statistics collection.">components::SystemStatisticsCollector</a> and <a class="el" href="../../d8/daf/classcomponents_1_1StatisticsStorage.html" title="Component that keeps a utils::statistics::Storage storage for metrics.">components::StatisticsStorage</a> is quite trivial:</p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        system-statistics-collector:</div>
<div class="line">            fs-task-processor: fs-task-processor</div>
</div><!-- fragment --><p>With such setup you could poll the metrics from handler <a class="el" href="../../dc/d10/classserver_1_1handlers_1_1ServerMonitor.html" title="Handler that returns statistics data.">server::handlers::ServerMonitor</a> that we've configured in <a class="el" href="#sample_prod_service_utility_handlers">previous section</a>. However a much more mature approach is to write a component that pushes the metrics directly into the remote metrics aggregation service or to write a handler that provides the metrics in the native aggregation service format.</p>
<p>To produce metrics in declarative style use the <a class="el" href="../../d7/d33/classutils_1_1statistics_1_1MetricTag.html" title="Metric description.">utils::statistics::MetricTag</a> or register your metrics writer in <a class="el" href="../../d5/d18/classutils_1_1statistics_1_1Storage.html">utils::statistics::Storage</a> via RegisterWriter to produce metrics on per component basis. To test metrics refer to the <a class="el" href="../../df/d07/md_en_2userver_2functional__testing.html#TESTSUITE_METRICS_TESTING">testsuite metrics testing</a>.</p>
<p>List of userver built-in metrics could be found at <a class="el" href="../../d9/dac/md_en_2userver_2service__monitor.html">Service Statistics and Metrics (Prometheus/Graphite/...)</a>.</p>
<h1><a class="anchor" id="autotoc_md795"></a>
Alerts</h1>
<p>Alerts is a way to propagate critical errors from your service to a monitoring system.</p>
<p>When the code identifies that something bad happened and a user should be notified about that, <code>alert_storage.FireAlert()</code> is called with the appropriate arguments. Then the alert subsystem notifies an external monitoring system (or a user) about the alert event though the specific HTTP handler.</p>
<h3><a class="anchor" id="autotoc_md796"></a>
Secdist - secrets distributor</h3>
<p>Storing sensitive data aside from the configs is a good practice that allows you to set different access rights for the two files.</p>
<p><a class="el" href="../../da/dc7/classcomponents_1_1Secdist.html" title="Component that stores security related data (keys, passwords, ...).">components::Secdist</a> configuration is straightforward:</p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        secdist:</div>
<div class="line">            provider: default-secdist-provider</div>
<div class="line">        default-secdist-provider:</div>
<div class="line">            config: $secdist-path</div>
</div><!-- fragment --><p>Refer to the <a class="el" href="../../de/d15/classstorages_1_1secdist_1_1SecdistConfig.html" title="Client to retrieve credentials from the components::Secdist.">storages::secdist::SecdistConfig</a> config for more information on the data retrieval.</p>
<p><a class="anchor" id="prod_service_testsuite_related_components"></a></p>
<h3><a class="anchor" id="autotoc_md797"></a>
Testsuite related components</h3>
<p><a class="el" href="../../d5/ded/classserver_1_1handlers_1_1TestsControl.html" title="Handler that allows to control the behavior of server from tests, and functional tests with testsuite...">server::handlers::TestsControl</a> is a handle that allows controlling the service from test environments. That handle is used by the testsuite from <a class="el" href="../../df/d07/md_en_2userver_2functional__testing.html">functional tests</a> to mock time, invalidate caches, testpoints and many other things. This component should be disabled in production environments.</p>
<p><a class="el" href="../../d9/de2/classcomponents_1_1TestsuiteSupport.html" title="Testsuite support component.">components::TestsuiteSupport</a> is a lightweight storage to keep minor testsuite data. This component is required by many high-level components and it is safe to use this component in production environments.</p>
<h2><a class="anchor" id="autotoc_md798"></a>
Dynamic config</h2>
<p>Dynamic configs are described in details at <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html">Dynamic config schemas</a> .</p>
<h3><a class="anchor" id="autotoc_md799"></a>
Build</h3>
<p>This sample requires <a class="el" href="../../d4/d95/md_en_2userver_2tutorial_2config__service.html">configs service</a>, so we build and start one from our previous tutorials.</p>
<div class="fragment"><div class="line">bash</div>
<div class="line">mkdir build_release</div>
<div class="line">cd build_release</div>
<div class="line">cmake -DCMAKE_BUILD_TYPE=Release ..</div>
<div class="line"> </div>
<div class="line">make userver-samples-config_service</div>
<div class="line">./samples/userver-samples-config_service &amp;</div>
<div class="line"> </div>
<div class="line">make userver-samples-production_service</div>
<div class="line">python3 ../samples/tests/prepare_production_configs.py</div>
<div class="line">./samples/userver-samples-production_service --config /tmp/userver/production_service/static_config.yaml</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md800"></a>
Functional testing</h3>
<p><a class="el" href="../../df/d07/md_en_2userver_2functional__testing.html">Functional tests</a> are used to make sure that the service is working fine and implements the required functionality. A recommended practice is to build the service in Debug and Release modes and tests both of them, then deploy the Release build to the production, disabling all the tests related handlers.</p>
<p>Debug builds of the userver provide numerous assertions that validate the framework usage and help to detect bugs at early stages.</p>
<p>Typical functional tests for a service consist of a <code>conftest.py</code> file with mocks+configs for the sereffectivelyvice and a bunch of <code>test_*.py</code> files with actual tests. Such approach allows to reuse mocks and configurations in different tests.</p>
<h2><a class="anchor" id="autotoc_md801"></a>
Full sources</h2>
<p>See the full example at</p><ul>
<li><a class="el" href="../../d8/d8a/samples_2production_service_2production_service_8cpp-example.html">samples/production_service/production_service.cpp</a></li>
<li><a class="el" href="../../df/d22/samples_2production_service_2static_config_8yaml-example.html">samples/production_service/static_config.yaml</a></li>
<li><a class="el" href="../../d8/de0/samples_2production_service_2config_vars_8yaml-example.html">samples/production_service/config_vars.yaml</a></li>
<li><a class="el" href="../../db/dec/samples_2production_service_2CMakeLists_8txt-example.html">samples/production_service/CMakeLists.txt</a></li>
<li><a class="el" href="../../d4/db8/samples_2production_service_2tests_2conftest_8py-example.html">samples/production_service/tests/conftest.py</a></li>
<li><a class="el" href="../../dc/d17/samples_2production_service_2tests_2test_ping_8py-example.html">samples/production_service/tests/test_ping.py</a></li>
<li><a class="el" href="../../d6/d5a/samples_2production_service_2tests_2test_production_8py-example.html">samples/production_service/tests/test_production.py</a></li>
</ul>
<hr  />
<p> <div class="bottom-nav">  ⇦ <a class="el" href="../../d4/d95/md_en_2userver_2tutorial_2config__service.html">Writing your own configs server</a> | <a class="el" href="../../dc/d93/md_en_2userver_2tutorial_2tcp__service.html">TCP half-duplex server with static configs validation</a> ⇨  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:56:00 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
