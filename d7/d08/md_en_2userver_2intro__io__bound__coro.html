<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: I/O-bound Applications and Coroutines</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d7/d08/md_en_2userver_2intro__io__bound__coro.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">I/O-bound Applications and Coroutines</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md341"></a> </p>
<h1><a class="anchor" id="autotoc_md342"></a>
Microservices and other I/O-bound applications</h1>
<p>For <a href="https://en.wikipedia.org/wiki/Microservices">microservices</a> waiting for I/O is typical: often the response of a microservice is formed from several responses from other microservices and databases.</p>
<p>The problem of efficient waits for I/O in the classical approach is solved by callbacks: a function (called a callback) is passed to the method that performs I/O, the callback is called by the method when the wait is complete. If you need to perform several I/O operations sequentially, the callback from the first I/O method calls the method for the next I/O and passes the next callback to it. As a result, you get code that is unpleasant to write and difficult to maintain due to the many nested functions and non-obvious control flow.</p>
<p>The userver framework with stackful coroutines comes to the rescue.</p>
<p>For the user of the framework, <b>the code becomes simple and linear, but everything works efficiently</b>:</p>
<div class="fragment"><div class="line">Response View::Handle(Request&amp;&amp; request, <span class="keyword">const</span> Dependencies&amp; dependencies) {</div>
<div class="line">  <span class="keyword">auto</span> cluster = dependencies.pg-&gt;GetCluster();                             <span class="comment">// ðŸš€</span></div>
<div class="line">  <span class="keyword">auto</span> trx = cluster-&gt;Begin(<a class="code hl_enumvalue" href="../../de/d6d/namespacestorages_1_1postgres.html#a112991762e57633e6213c2cbbce7d62fad4720c3695455d7cf5bce1b2c7bcecdf">storages::postgres::ClusterHostType::kMaster</a>);  <span class="comment">// ðŸš€</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span>* statement = <span class="stringliteral">&quot;SELECT ok, baz FROM some WHERE id = $1 LIMIT 1&quot;</span>;</div>
<div class="line">  <span class="keyword">auto</span> row = psql::Execute(trx, statement, request.id)[0];                  <span class="comment">// ðŸš€</span></div>
<div class="line">  <span class="keywordflow">if</span> (!row[<span class="stringliteral">&quot;ok&quot;</span>].As&lt;bool&gt;()) {</div>
<div class="line">    <a class="code hl_define" href="../../dd/de6/universal_2include_2userver_2logging_2log_8hpp.html#a9d0a09bf4292af456e282867b32d7d5e" title="Evaluates a message and logs it to the default logger if its level is below or equal to logging::Leve...">LOG_DEBUG</a>() &lt;&lt; request.id &lt;&lt; <span class="stringliteral">&quot; is not OK of &quot;</span></div>
<div class="line">                &lt;&lt; GetSomeInfoFromDb();                                     <span class="comment">// ðŸš€</span></div>
<div class="line">    <span class="keywordflow">return</span> Response400();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  psql::Execute(trx, queries::kUpdateRules, request.foo, request.bar);      <span class="comment">// ðŸš€</span></div>
<div class="line">  trx.Commit();                                                             <span class="comment">// ðŸš€</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> Response200{row[<span class="stringliteral">&quot;baz&quot;</span>].As&lt;std::string&gt;()};</div>
<div class="line">}</div>
</div><!-- fragment --><p>For the simplicity of the example, all lines where the coroutine can be paused are marked as <code>// ðŸš€</code>. In other frameworks or programming languages it is often necessary to explicitly mark the context switch of the coroutine. In those languages in each line with the comment <code>// ðŸš€</code>, you would have to write a keyword like <code>await</code>. In userver you do not need to do this, switching occurs automatically and you do not need to think about the implementation details of various methods of the framework.</p>
<p>Unlike in the Python, <b>in userver multiple coroutines can be executed simultaneously on different processor cores</b>. For example the <code>View::Handle</code> may be called in parallel for different requests.</p>
<p>Now compare the above userver code with the classic callback approach: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> View::Handle(Request&amp;&amp; request, <span class="keyword">const</span> Dependencies&amp; dependencies, Response response) {</div>
<div class="line">  dependencies.pg-&gt;GetCluster(</div>
<div class="line">    [request = std::move(request), response](<span class="keyword">auto</span> cluster)</div>
<div class="line">  {</div>
<div class="line">    cluster-&gt;Begin(<a class="code hl_enumvalue" href="../../de/d6d/namespacestorages_1_1postgres.html#a112991762e57633e6213c2cbbce7d62fad4720c3695455d7cf5bce1b2c7bcecdf">storages::postgres::ClusterHostType::kMaster</a>,</div>
<div class="line">      [request = std::move(request), response](<span class="keyword">auto</span>&amp; trx)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">char</span>* statement = <span class="stringliteral">&quot;SELECT ok, baz FROM some WHERE id = $1 LIMIT 1&quot;</span>;</div>
<div class="line">      psql::Execute(trx, statement, request.id,</div>
<div class="line">        [request = std::move(request), response, trx = std::move(trx)](<span class="keyword">auto</span>&amp; res)</div>
<div class="line">      {</div>
<div class="line">        auto row = res[0];</div>
<div class="line">        if (!row[<span class="stringliteral">&quot;ok&quot;</span>].As&lt;bool&gt;()) {</div>
<div class="line">          if (LogDebug()) {</div>
<div class="line">              GetSomeInfoFromDb([id = request.id](auto info) {</div>
<div class="line">                  LOG_DEBUG() &lt;&lt; id &lt;&lt; <span class="stringliteral">&quot; is not OK of &quot;</span> &lt;&lt; info;</div>
<div class="line">              });</div>
<div class="line">          }</div>
<div class="line">          *response = Response400{};</div>
<div class="line">        }</div>
<div class="line">        psql::Execute(trx, queries::kUpdateRules, request.foo, request.bar,</div>
<div class="line">          [row = std::move(row), trx = std::move(trx), response]()</div>
<div class="line">        {</div>
<div class="line">          trx.Commit([row = std::move(row), response]() {</div>
<div class="line">            *response = Response200{row[<span class="stringliteral">&quot;baz&quot;</span>].As&lt;std::string&gt;()};</div>
<div class="line">          });</div>
<div class="line">        });</div>
<div class="line">      });</div>
<div class="line">    });</div>
<div class="line">  });</div>
<div class="line">}</div>
</div><!-- fragment --><p>The classical approach is almost twice as long, and it is difficult to read and maintain because of the deep nesting of the lambda functions. Moreover, the time-consuming error codes handling is completely omitted, while in the first example all the errors are automatically reported through the exception mechanism.</p>
<h1><a class="anchor" id="autotoc_md343"></a>
Coroutines</h1>
<p>In simple terms, coroutines are lightweight threads that are managed by the application itself, not by the operating system.</p>
<p>Coroutines provide an additional benefit in high-load applications:</p><ul>
<li>The OS does not need to know about coroutines, and therefore does not need to use complex and heavy logic to manage them and spend additional system resources.</li>
<li>The application knows how and when it is best to pause or start the coroutine, thus the engine avoids some of the heavy OS context switches.</li>
<li>Switching between coroutines is an easy operation that usually does not require system calls or other heavy operations.</li>
</ul>
<p>However, there is a disadvantage of a cooperative multitasking:</p><ul>
<li>Coroutine scheduler is not preemptive. Poorly written coroutine payloads could occupy the system threads and make the other coroutines starve, but in most cases there are means to make them cooperate better with minimal code changes.</li>
</ul>
<p>The user of the framework does not work directly with the coroutines, but rather works with tasks that are executed on the coroutines. It is very expensive to create and destroy coroutines for each asynchronous operation, so coroutines are reused between tasks. When a new task is starting, a free coroutine is selected to host it. After the task is finished, the coroutine is released, and can be used by another task.</p>
<h1><a class="anchor" id="autotoc_md344"></a>
Performance</h1>
<p>The main purpose of userver is to be an effective solution for IO-bound applications. Coroutines help to achieve that purpose.</p>
<p>It takes less than 1us to invoke and wait for a noop task <code>engine::Async([] () {}).Wait()</code>. In this case, the task execution time will be automatically measured inside the <code>engine::Async()</code>, the task will be linked to the parent task to simplify <a class="el" href="../../df/d0c/md_en_2userver_2logging.html">tracing, all information will be recorded in logs</a>.</p>
<p>For comparison, <code>std::thread ([] () {}).join()</code> takes ~17us and does not provide or log any information.</p>
<p>The userver synchronization primitives are comparable in performance to standard primitives, and we are constantly working to improve them. For example <a class="el" href="../../d3/dfa/core_2src_2engine_2mutex_benchmark_8cpp-example.html">concurrent `lock()` and `unlock()` of the same mutex from different threads on a 2 core system with Hyper-threading</a> produce the following timings:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Competing threads   </th><th class="markdownTableHeadNone"><code>std::mutex</code>   </th><th class="markdownTableHeadNone"><code>Mutex</code>    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">22 ns   </td><td class="markdownTableBodyNone">19 ns    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">205 ns   </td><td class="markdownTableBodyNone">154 ns    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">403 ns   </td><td class="markdownTableBodyNone">669 ns   </td></tr>
</table>
<hr  />
<p> <div class="bottom-nav">  | <a class="el" href="../../d8/d00/md_en_2userver_2intro.html">The Basics</a> â‡¨  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:55:59 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
