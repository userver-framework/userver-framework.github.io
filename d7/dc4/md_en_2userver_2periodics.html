<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: Periodics and DistLocks</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d7/dc4/md_en_2userver_2periodics.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Periodics and DistLocks</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md429"></a> Basic information on functions and classes that execute some code triggered by some non-IO event.</p>
<h2><a class="anchor" id="autotoc_md430"></a>
PeriodicTask</h2>
<p><a class="el" href="../../d6/d10/classutils_1_1PeriodicTask.html" title="Task that periodically runs a user callback. Callback is started after the previous callback executio...">utils::PeriodicTask</a>, as the name implies, regularly calls user code. Keep in mind that the task is called on every machine in the cluster.</p>
<p>Well suited for:</p><ul>
<li>background actions within the component</li>
<li>cheap idempotent database cleanup, provided that repeated cleaning is very cheap for the database; if this is not the case, then use <a class="el" href="../../db/d9d/classdist__lock_1_1DistLockedTask.html" title="A task that tries to acquire a distributed lock and runs user callback once while the lock is held.">dist_lock::DistLockedTask</a>.</li>
</ul>
<p>Poorly suited for:</p><ul>
<li>Regularly receiving data from another service for caching purposes. To do this, it is better to use specially designed <a class="el" href="../../d5/d2d/md_en_2userver_2caches.html">caches</a>.</li>
<li>Background DB accesses for periodic changes. Use instead <a class="el" href="../../db/d9d/classdist__lock_1_1DistLockedTask.html" title="A task that tries to acquire a distributed lock and runs user callback once while the lock is held.">dist_lock::DistLockedTask</a>.</li>
</ul>
<p>The update period can be changed without stopping the periodic task using <a class="el" href="../../d6/d10/classutils_1_1PeriodicTask.html#a3979114cddcf72a8eb2c1ea55fc5cc5e" title="Set all settings except flags. All flags must be set at the start.">utils::PeriodicTask::SetSettings()</a>.</p>
<p>Sample: </p><div class="fragment"><div class="line">Component::Component(...)</div>
<div class="line">{</div>
<div class="line">  std::chrono::seconds interval{40}; <span class="comment">// every 40 seconds</span></div>
<div class="line">  PeriodicTask::Settings settings{interval};</div>
<div class="line">  syncer_.Start(<span class="stringliteral">&quot;task_name&quot;</span>, settings, [<span class="keyword">this</span>]{ DoSomeWork(); });</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Register itself in testsuite</span></div>
<div class="line">  periodic_task_.RegisterInTestsuite(</div>
<div class="line">      context.FindComponent&lt;<a class="code hl_class" href="../../d9/de2/classcomponents_1_1TestsuiteSupport.html" title="Testsuite support component.">::components::TestsuiteSupport</a>&gt;()</div>
<div class="line">          .GetPeriodicTaskControl());</div>
<div class="line">}</div>
</div><!-- fragment --><p>See <a class="el" href="../../df/d07/md_en_2userver_2functional__testing.html#TESTSUITE_TASKS">Testsuite tasks</a> for information about functional testing of such tasks.</p>
<h2><a class="anchor" id="autotoc_md431"></a>
DistLock</h2>
<p>A family of tools for background task execution on only one machine in a cluster. When dist lock starts, the lock worker tries to take a lock in the loop. If succeeded, a task is launched that executes the user code. In the background, dist lock tries to extend the lock. In case of loss of the lock, the user task is canceled.</p>
<p>The implementation has some protection against brain split (more than one instance believes that they hold the lock, and do work that requires a lock). Watchdog periodically checks whether we were able to extend the lock, and in case of an imminent loss of the lock, cancels the user task. The user task itself is responsible for stopping the work in case of cancellation (via <a class="el" href="../../d2/d64/namespaceengine_1_1current__task.html#aed8fc1cdfd588f3973f5c9bc503c9986">engine::current_task::ShouldCancel()</a>). If the task continues to work despite the cancellation, then a brain split will happen and the task will start to execute on multiple instances at the same time.</p>
<p>Lock implementation options:</p><ul>
<li>via Postgres using <a class="el" href="../../d2/d55/classstorages_1_1postgres_1_1DistLockComponentBase.html" title="Base class for postgres-based distlock worker components.">storages::postgres::DistLockComponentBase</a>.</li>
<li>via Mongo using <a class="el" href="../../db/df7/classstorages_1_1mongo_1_1DistLockComponentBase.html" title="Base class for mongo-based distlock worker components.">storages::mongo::DistLockComponentBase</a>.</li>
<li>through some special service using the <a class="el" href="../../d4/d24/classdist__lock_1_1DistLockedWorker.html">dist_lock::DistLockedWorker</a> component.</li>
</ul>
<p>It is well suited for:</p><ul>
<li>heavy operation that is performed for a long time, while you do not want to execute it on two or more cluster machines at once</li>
<li>operations that cannot be executed concurrently on several machines (for example, a distributed transaction in several databases).</li>
</ul>
<p>Poorly suited if:</p><ul>
<li>strict guarantees for parallel startup are not required</li>
<li>brain split is categorically unacceptable</li>
<li>an explicit synchronization point in the form of a lock storage is not suitable due to reliability / performance / adding a bottleneck.</li>
<li>Execution of a non periodic task that should hold a distributed lock. Use <a class="el" href="../../db/d9d/classdist__lock_1_1DistLockedTask.html" title="A task that tries to acquire a distributed lock and runs user callback once while the lock is held.">dist_lock::DistLockedTask</a> instead.</li>
</ul>
<p>Sample: </p><div class="fragment"><div class="line"><span class="keyword">class </span>Worker: <span class="keyword">public</span> <a class="code hl_class" href="../../d2/d55/classstorages_1_1postgres_1_1DistLockComponentBase.html" title="Base class for postgres-based distlock worker components.">::storages::postgres::DistLockComponentBase</a> { ... }</div>
<div class="line"> </div>
<div class="line">Worker::Worker(...)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">auto</span>&amp; testsuite_tasks = <a class="code hl_function" href="../../d3/d56/namespacetestsuite.html#a66b38b3d8afe9b7f27f89451165da6db" title="Get reference to TestsuiteTasks instance.">testsuite::GetTestsuiteTasks</a>(context);</div>
<div class="line">  <span class="keywordflow">if</span> (testsuite_tasks.IsEnabled()) {</div>
<div class="line">    testsuite_tasks.RegisterTask(kName, [<span class="keyword">this</span>] { DoWork(); });</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    AutostartDistLock();</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> Worker::DoWork() {</div>
<div class="line">  <span class="comment">// do a periodic work step</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>See <a class="el" href="../../df/d07/md_en_2userver_2functional__testing.html#TESTSUITE_TASKS">Testsuite tasks</a> for information bout functional testing of such tasks.</p>
<h3><a class="anchor" id="autotoc_md432"></a>
Recommendations on DoWork implementation</h3>
<p>If work in <code>DoWork</code> takes a long time, then it is necessary to check for task cancellation at least once in <code>lock-ttl</code> via <a class="el" href="../../d2/d64/namespaceengine_1_1current__task.html#aed8fc1cdfd588f3973f5c9bc503c9986">engine::current_task::ShouldCancel()</a>. Synchronization primitives <a class="el" href="../../dc/d3f/namespaceengine.html#a19462f750672c6fa7f5f690c2575b9f6">engine::InterruptibleSleepFor</a>, <a class="el" href="../../d8/d87/classengine_1_1SingleConsumerEvent.html" title="A multiple-producers, single-consumer event.">engine::SingleConsumerEvent</a>, <a class="el" href="../../d8/d67/classengine_1_1Future.html" title="std::future replacement for asynchronous tasks that works in pair with engine::Promise">engine::Future</a>, userver queues, requests to clients - support cancellations, that interrupt waiting when the task is canceled. After such a wait, you need to check whether the task has been canceled - synchronization primitives throw an exception or return <code>false</code> from a wait operation, depending on the primitive. After <a class="el" href="../../dc/d3f/namespaceengine.html#a19462f750672c6fa7f5f690c2575b9f6">engine::InterruptibleSleepFor</a> you should call <a class="el" href="../../d2/d64/namespaceengine_1_1current__task.html#aed8fc1cdfd588f3973f5c9bc503c9986">engine::current_task::ShouldCancel()</a> manually.</p>
<p>In 'DoWork<code>you can perform one step of the operation, or you can write a loop </code>while (!ShouldCancel())`. You can choose an approach based on this principle:</p>
<dl class="section note"><dt>Note</dt><dd>If it is important to perform a distlock on the same host, then write a loop <code>DoWork</code>, otherwise perform a single iteration.</dd></dl>
<p>More detailed:</p><ul>
<li>If switching the host is cheap, then it is better not to write a loop in <code>DoWork</code>, then the work has a chance to be distributed among the hosts (although there is no guarantee). If in doubt, it is better not to write a loop in &lsquo;DoWork&rsquo;.</li>
<li>In some cases, the distlock performs one big task with interruptions via <a class="el" href="../../dc/d3f/namespaceengine.html#a19462f750672c6fa7f5f690c2575b9f6">engine::InterruptibleSleepFor</a> to not overload the CPU and/or the database. Then you need to write a loop inside DoWork. Or if the host needs an expensive setup before starting the work on a distlock task, then you can also write a loop.</li>
</ul>
<p>DistLocks create a single <a class="el" href="../../d7/d1a/classtracing_1_1Span.html" title="Measures the execution time of the current code block, links it with the parent tracing::Spans and st...">tracing::Span</a> for the whole lifetime of worker. If a shorter Trace ID lifetime is required, then use <a class="el" href="../../d7/d1a/classtracing_1_1Span.html#a111d4e51041fd55f5bb4baa8ba79e5e9">tracing::Span::MakeSpan()</a> to create a new Span inside the Worker::DoWork() loop iteration.</p>
<h3><a class="anchor" id="autotoc_md433"></a>
Guarantees provided</h3>
<p>The custom coroutine that runs DoWork is always the same. If the cancellation is not processed, then another DoWork-coroutine is not launched.</p>
<hr  />
<p> <div class="bottom-nav">  ⇦ <a class="el" href="../../db/d90/md_en_2userver_2task__processors__guide.html">Guide on TaskProcessor Usage</a> | <a class="el" href="../../d4/d70/md_en_2userver_2testing.html">Unit Tests and Benchmarks</a> ⇨  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:55:59 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
