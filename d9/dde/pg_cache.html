<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: Caching Component for PostgreSQL</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d9/dde/pg_cache.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Caching Component for PostgreSQL</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A typical <a class="el" href="../../d2/d8d/classcomponents_1_1PostgreCache.html" title="Caching component for PostgreSQL. See Caching Component for PostgreSQL.">components::PostgreCache</a> usage consists of trait definition:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>PostgresTrivialPolicy {</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> std::string_view kName = <span class="stringliteral">&quot;my-pg-cache&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using </span>ValueType = MyStructure;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">auto</span> kKeyMember = &amp;MyStructure::id;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* kQuery = <span class="stringliteral">&quot;SELECT a, b, updated FROM test.data&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* kUpdatedField = <span class="stringliteral">&quot;updated&quot;</span>;</div>
<div class="line">    <span class="keyword">using </span>UpdatedFieldType = <a class="code hl_struct" href="../../d7/dde/structstorages_1_1postgres_1_1TimePointTz.html" title="Corresponds to TIMESTAMP WITH TIME ZONE database type.">storages::postgres::TimePointTz</a>;</div>
<div class="line">};</div>
</div><!-- fragment --><p>and registration of the component in <a class="el" href="../../dc/df0/classcomponents_1_1ComponentList.html" title="A list to keep a unique list of components to start with components::Run(), utils::DaemonMain() or co...">components::ComponentList</a>:</p>
<div class="fragment"></div><!-- fragment --><p>See <a class="el" href="../../d5/d2d/md_en_2userver_2caches.html">Basics of Caches</a> for introduction into caches.</p>
<h1><a class="anchor" id="pg_cc_configuration"></a>
Configuration</h1>
<p><a class="el" href="../../d2/d8d/classcomponents_1_1PostgreCache.html" title="Caching component for PostgreSQL. See Caching Component for PostgreSQL.">components::PostgreCache</a> static configuration file should have a PostgreSQL component name specified in <code>pgcomponent</code> configuration parameter.</p>
<p>Optionally the operation timeouts for cache loading can be specified.</p>
<h3><a class="anchor" id="autotoc_md1034"></a>
Avoiding memory leaks</h3>
<p><a class="el" href="../../df/dd1/classcomponents_1_1CachingComponentBase.html" title="Base class for caching components.">components::CachingComponentBase</a></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Description   </th><th class="markdownTableHeadNone">Default value    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">full-update-op-timeout   </td><td class="markdownTableBodyNone">timeout for a full update   </td><td class="markdownTableBodyNone">1m    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">incremental-update-op-timeout   </td><td class="markdownTableBodyNone">timeout for an incremental update   </td><td class="markdownTableBodyNone">1s    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">update-correction   </td><td class="markdownTableBodyNone">incremental update window adjustment   </td><td class="markdownTableBodyNone">- (0 for caches with defined GetLastKnownUpdated)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">chunk-size   </td><td class="markdownTableBodyNone">number of rows to request from PostgreSQL via portals, 0 to fetch all rows in one request without portals   </td><td class="markdownTableBodyNone">1000   </td></tr>
</table>
<h1><a class="anchor" id="pg_cc_cache_policy"></a>
Cache policy</h1>
<p>Cache policy is the template argument of <a class="el" href="../../d2/d8d/classcomponents_1_1PostgreCache.html" title="Caching component for PostgreSQL. See Caching Component for PostgreSQL.">components::PostgreCache</a> component. Please see the following code snippet for documentation.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>example {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>MyStructure {</div>
<div class="line">    <span class="keywordtype">int</span> <span class="keywordtype">id</span> = 0;</div>
<div class="line">    std::string bar{};</div>
<div class="line">    <a class="code hl_struct" href="../../de/d03/structstorages_1_1postgres_1_1TimePointWithoutTz.html" title="Corresponds to TIMESTAMP WITHOUT TIME ZONE database type.">storages::postgres::TimePointWithoutTz</a> updated;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> get_id()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> id; }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>PostgresExamplePolicy {</div>
<div class="line">    <span class="comment">// Name of caching policy component.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Required: **yes**</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> std::string_view kName = <span class="stringliteral">&quot;my-pg-cache&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Object type.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Required: **yes**</span></div>
<div class="line">    <span class="keyword">using </span>ValueType = MyStructure;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Key by which the object must be identified in cache.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// One of:</span></div>
<div class="line">    <span class="comment">// - A pointer-to-member in the object</span></div>
<div class="line">    <span class="comment">// - A pointer-to-member-function in the object that returns the key</span></div>
<div class="line">    <span class="comment">// - A pointer-to-function that takes the object and returns the key</span></div>
<div class="line">    <span class="comment">// - A lambda that takes the object and returns the key</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Required: **yes**</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">auto</span> kKeyMember = &amp;MyStructure::id;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Data retrieve query.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// The query should not contain any clauses after the `from` clause. Either</span></div>
<div class="line">    <span class="comment">// `kQuery` or `GetQuery` static member function must be defined.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Required: **yes**</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* kQuery = <span class="stringliteral">&quot;select id, bar, updated from test.my_data&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Name of the field containing timestamp of an object.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// To turn off incremental updates, set the value to `nullptr`.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Required: **yes**</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* kUpdatedField = <span class="stringliteral">&quot;updated&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Type of the field containing timestamp of an object.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Specifies whether updated field should be treated as a timestamp</span></div>
<div class="line">    <span class="comment">// with or without timezone in database queries.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Required: **yes** if incremental updates are used.</span></div>
<div class="line">    <span class="keyword">using </span>UpdatedFieldType = <a class="code hl_struct" href="../../d7/dde/structstorages_1_1postgres_1_1TimePointTz.html" title="Corresponds to TIMESTAMP WITH TIME ZONE database type.">storages::postgres::TimePointTz</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Where clause of the query. Either `kWhere` or `GetWhere` can be defined.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Required: no</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* kWhere = <span class="stringliteral">&quot;id &gt; 10&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Cache container type.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// It can be of any map type. The default is `unordered_map`, it is not</span></div>
<div class="line">    <span class="comment">// necessary to declare the DataType alias if you are OK with</span></div>
<div class="line">    <span class="comment">// `unordered_map`.</span></div>
<div class="line">    <span class="comment">// The key type must match the type of kKeyMember.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Required: no</span></div>
<div class="line">    <span class="keyword">using </span>CacheContainer = std::unordered_map&lt;int, MyStructure&gt;;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Cluster host selection flags to use when retrieving data.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Default value is storages::postgres::ClusterHostType::kSlave, at least one</span></div>
<div class="line">    <span class="comment">// cluster role must be present in flags.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Required: no</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">auto</span> kClusterHostType = <a class="code hl_enumvalue" href="../../de/d6d/namespacestorages_1_1postgres.html#a112991762e57633e6213c2cbbce7d62fa711876d1003646469de6eb5a7811927b">storages::postgres::ClusterHostType::kSlave</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Whether Get() is expected to return nullptr.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Default value is false, Get() will throw an exception instead of</span></div>
<div class="line">    <span class="comment">// returning nullptr.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Required: no</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keywordtype">bool</span> kMayReturnNull = <span class="keyword">false</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace example</span></div>
</div><!-- fragment --><p>The query can be a std::string. But due to non-guaranteed order of static data members initialization, std::string should be returned from a static member function, please see the following code snippet.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>PostgresExamplePolicy4 {</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> std::string_view kName = <span class="stringliteral">&quot;my-pg-cache&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using </span>ValueType = MyStructure;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">auto</span> kKeyMember = &amp;MyStructure::id;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> std::string GetQuery() { <span class="keywordflow">return</span> <span class="stringliteral">&quot;select id, bar, updated from test.my_data&quot;</span>; }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* kUpdatedField = <span class="stringliteral">&quot;updated&quot;</span>;</div>
<div class="line">    <span class="comment">// no time zone (should be avoided)</span></div>
<div class="line">    <span class="keyword">using </span>UpdatedFieldType = <a class="code hl_struct" href="../../de/d03/structstorages_1_1postgres_1_1TimePointWithoutTz.html" title="Corresponds to TIMESTAMP WITHOUT TIME ZONE database type.">storages::postgres::TimePointWithoutTz</a>;</div>
<div class="line">};</div>
</div><!-- fragment --><p>Policy may have static function GetLastKnownUpdated. It should be used when new entries from database are taken via revision, identifier, or anything else, but not timestamp of the last update. If this function is supplied, new entries are taken from db with condition 'WHERE kUpdatedField &gt; GetLastKnownUpdated(cache_container)'. Otherwise, condition is 'WHERE kUpdatedField &gt; last_update - correction_'. See the following code snippet for an example of usage</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>MyStructureWithRevision {</div>
<div class="line">    <span class="keywordtype">int</span> <span class="keywordtype">id</span> = 0;</div>
<div class="line">    std::string bar{};</div>
<div class="line">    <a class="code hl_struct" href="../../de/d03/structstorages_1_1postgres_1_1TimePointWithoutTz.html" title="Corresponds to TIMESTAMP WITHOUT TIME ZONE database type.">storages::postgres::TimePointWithoutTz</a> updated;</div>
<div class="line">    int32_t revision = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> get_id()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> id; }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>UserSpecificCache {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keywordtype">void</span> insert_or_assign(<span class="keywordtype">int</span>, MyStructureWithRevision&amp;&amp; item) {</div>
<div class="line">        latest_revision_ = std::max(latest_revision_, item.revision);</div>
<div class="line">    }</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">size_t</span> size() { <span class="keywordflow">return</span> 0; }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> GetLatestRevision()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> latest_revision_; }</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">int</span> latest_revision_ = 0;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>PostgresExamplePolicy3 {</div>
<div class="line">    <span class="keyword">using </span>ValueType = MyStructureWithRevision;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> std::string_view kName = <span class="stringliteral">&quot;my-pg-cache&quot;</span>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* kQuery = <span class="stringliteral">&quot;select id, bar, revision from test.my_data&quot;</span>;</div>
<div class="line">    <span class="keyword">using </span>CacheContainer = UserSpecificCache;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* kUpdatedField = <span class="stringliteral">&quot;revision&quot;</span>;</div>
<div class="line">    <span class="keyword">using </span>UpdatedFieldType = int32_t;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">auto</span> kKeyMember = &amp;MyStructureWithRevision::get_id;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Function to get last known revision/time</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Optional</span></div>
<div class="line">    <span class="comment">// If one wants to get cache updates not based on updated time, but, for</span></div>
<div class="line">    <span class="comment">// example, based on revision &gt; known_revision, this method should be used.</span></div>
<div class="line">    <span class="keyword">static</span> int32_t GetLastKnownUpdated(<span class="keyword">const</span> UserSpecificCache&amp; container) { <span class="keywordflow">return</span> container.GetLatestRevision(); }</div>
<div class="line">};</div>
</div><!-- fragment --><p>In case one provides a custom CacheContainer within Policy, it is notified of Update completion via its public member function OnWritesDone, if any. See the following code snippet for an example of usage:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>UserSpecificCacheWithWriteNotification {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keywordtype">void</span> insert_or_assign(<span class="keywordtype">int</span>, MyStructure&amp;&amp;) {}</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">size_t</span> size() { <span class="keywordflow">return</span> 0; }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> OnWritesDone() {}</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="pg_cc_forward_declaration"></a>
Forward Declaration</h1>
<p>To forward declare a cache you can forward declare a trait and include <a class="el" href="../../dd/d4f/base__postgres__cache__fwd_8hpp.html" title="Forward declaration of the components::PostgreCache.">userver/cache/base_postgres_cache_fwd.hpp</a> header. It is also useful to forward declare the cache value type.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#pragma once</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;memory&gt;</span>  <span class="comment">// for std::shared_ptr</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../dd/d4f/base__postgres__cache__fwd_8hpp.html" title="Forward declaration of the components::PostgreCache.">userver/cache/base_postgres_cache_fwd.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line">USERVER_NAMESPACE_BEGIN</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>example {  <span class="comment">// replace with a namespace of your trait</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>PostgresExamplePolicy;</div>
<div class="line"><span class="keyword">struct </span>MyStructure;</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace example</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>caches {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">using </span>MyCache1 = <a class="code hl_class" href="../../d2/d8d/classcomponents_1_1PostgreCache.html" title="Caching component for PostgreSQL. See Caching Component for PostgreSQL.">components::PostgreCache&lt;example::PostgresExamplePolicy&gt;</a>;</div>
<div class="line"><span class="keyword">using </span>MyCache1Data = std::shared_ptr&lt;const example::MyStructure&gt;;</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace caches</span></div>
</div><!-- fragment --><hr  />
<p> <div class="bottom-nav">  ⇦ <a class="el" href="../../da/dd6/md_en_2userver_2cache__dumps.html">Local cache dumps</a> | <a class="el" href="../../d0/dd8/md_en_2userver_2lru__cache.html">Least Recently Used (LRU) Caches and expirable LRU caches</a> ⇨  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:56:00 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
