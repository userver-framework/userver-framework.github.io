<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: Formats (JSON, YAML, BSON, ...)</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d2/d20/md_en_2userver_2formats.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Formats (JSON, YAML, BSON, ...)</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md258"></a> Userver provides classes for reading, working with, and serializing various data formats. Classes for different formats have an almost identical interface. There are common points for customizing parsers and serializers of custom types.</p>
<h2><a class="anchor" id="autotoc_md259"></a>
formats::*::Value</h2>
<p>Classes <a class="el" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value</a>, <a class="el" href="../../db/d67/classformats_1_1bson_1_1Value.html" title="Non-mutable BSON value representation.">formats::bson::Value</a>, <a class="el" href="../../d3/d6c/classyaml__config_1_1YamlConfig.html" title="Datatype that represents YAML with substituted variables.">yaml_config::YamlConfig</a> and <a class="el" href="../../da/dc1/classformats_1_1yaml_1_1Value.html" title="Non-mutable YAML value representation.">formats::yaml::Value</a> are intended for non-modifying work with formats (in other words, for reading data).</p>
<p>Usage Example:</p>
<div class="fragment"><div class="line">    <span class="comment">// #include &lt;userver/formats/json.hpp&gt;</span></div>
<div class="line"> </div>
<div class="line">    <a class="code hl_class" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value</a> json = <a class="code hl_function" href="../../de/da1/namespaceformats_1_1json.html#aebd74445be0a82a8db7976c19324f098" title="Parse JSON from string.">formats::json::FromString</a>(R<span class="stringliteral">&quot;({</span></div>
<div class="line"><span class="stringliteral">    &quot;key1&quot;: 1,</span></div>
<div class="line"><span class="stringliteral">    &quot;key2&quot;: {&quot;key3&quot;:&quot;val&quot;}</span></div>
<div class="line"><span class="stringliteral">  })&quot;);</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">    </span><span class="keyword">const</span> <span class="keyword">auto</span> key1 = json[<span class="stringliteral">&quot;key1&quot;</span>].As&lt;<span class="keywordtype">int</span>&gt;();</div>
<div class="line">    ASSERT_EQ(key1, 1);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> key3 = json[<span class="stringliteral">&quot;key2&quot;</span>][<span class="stringliteral">&quot;key3&quot;</span>].As&lt;std::string&gt;();</div>
<div class="line">    ASSERT_EQ(key3, <span class="stringliteral">&quot;val&quot;</span>);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md260"></a>
Customization of formats::*::Value::As&lt;T&gt;()</h2>
<p>In order for <code>formats::*::Value</code> to be able to represent data as a C++ type, you should write a special function <code>Parse</code> for that C++ type. <code>Parse</code> should be located in the namespace of the type or may be located in the <code><a class="el" href="../../d4/d6e/namespaceformats_1_1common.html" title="Common utilities for all the formats.">formats::common</a></code> namespace if the type comes from third-party library that you have no control of:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>my_namespace {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>MyKeyValue {</div>
<div class="line">    std::string field1;</div>
<div class="line">    <span class="keywordtype">int</span> field2;</div>
<div class="line">};</div>
<div class="line"><span class="comment">//  The function must be declared in the namespace of your type</span></div>
<div class="line">MyKeyValue Parse(<span class="keyword">const</span> <a class="code hl_class" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value</a>&amp; json, <a class="code hl_struct" href="../../d6/dd1/structformats_1_1parse_1_1To.html">formats::parse::To&lt;MyKeyValue&gt;</a>) {</div>
<div class="line">    <span class="keywordflow">return</span> MyKeyValue{</div>
<div class="line">        json[<span class="stringliteral">&quot;field1&quot;</span>].As&lt;std::string&gt;(<span class="stringliteral">&quot;&quot;</span>),</div>
<div class="line">        json[<span class="stringliteral">&quot;field2&quot;</span>].As&lt;int&gt;(1),  <span class="comment">// return `1` if &quot;field2&quot; is missing</span></div>
<div class="line">    };</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">TEST(FormatsJson, ExampleUsageMyStruct) {</div>
<div class="line">    <a class="code hl_class" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value</a> json = <a class="code hl_function" href="../../de/da1/namespaceformats_1_1json.html#aebd74445be0a82a8db7976c19324f098" title="Parse JSON from string.">formats::json::FromString</a>(R<span class="stringliteral">&quot;({</span></div>
<div class="line"><span class="stringliteral">    &quot;my_value&quot;: {</span></div>
<div class="line"><span class="stringliteral">        &quot;field1&quot;: &quot;one&quot;,</span></div>
<div class="line"><span class="stringliteral">        &quot;field2&quot;: 1</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral">  })&quot;);</span></div>
<div class="line"><span class="stringliteral">    </span><span class="keyword">auto</span> data = json[<span class="stringliteral">&quot;my_value&quot;</span>].As&lt;MyKeyValue&gt;();</div>
<div class="line">    EXPECT_EQ(data.field1, <span class="stringliteral">&quot;one&quot;</span>);</div>
<div class="line">    EXPECT_EQ(data.field2, 1);</div>
<div class="line">}</div>
<div class="line">}  <span class="comment">// namespace my_namespace</span></div>
</div><!-- fragment --><p>You can write a single parser for all formats, just make it a template:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../db/d1e/universal_2include_2userver_2formats_2json_8hpp.html" title="Include-all header for JSON support.">userver/formats/json.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d5/d95/yaml_8hpp.html" title="Include-all header for YAML support.">userver/formats/yaml.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line">USERVER_NAMESPACE_BEGIN</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>my_namespace {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>MyKeyValue {</div>
<div class="line">    std::string field1;</div>
<div class="line">    <span class="keywordtype">int</span> field2;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// The function must be declared in the namespace of your type</span></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> Value&gt;</div>
<div class="line">MyKeyValue Parse(<span class="keyword">const</span> Value&amp; data, <a class="code hl_struct" href="../../d6/dd1/structformats_1_1parse_1_1To.html">formats::parse::To&lt;MyKeyValue&gt;</a>) {</div>
<div class="line">    <span class="keywordflow">return</span> MyKeyValue{</div>
<div class="line">        data[<span class="stringliteral">&quot;field1&quot;</span>].template As&lt;std::string&gt;(),</div>
<div class="line">        data[<span class="stringliteral">&quot;field2&quot;</span>].template As&lt;int&gt;(-1),  <span class="comment">// return `1` if &quot;field2&quot; is missing</span></div>
<div class="line">    };</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">TEST(CommonFormats, Parse) {</div>
<div class="line">    <span class="comment">// json</span></div>
<div class="line">    <a class="code hl_class" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value</a> json = <a class="code hl_function" href="../../de/da1/namespaceformats_1_1json.html#aebd74445be0a82a8db7976c19324f098" title="Parse JSON from string.">formats::json::FromString</a>(R<span class="stringliteral">&quot;({</span></div>
<div class="line"><span class="stringliteral">    &quot;my_value&quot;: {</span></div>
<div class="line"><span class="stringliteral">        &quot;field1&quot;: &quot;one&quot;,</span></div>
<div class="line"><span class="stringliteral">        &quot;field2&quot;: 1</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral">  })&quot;);</span></div>
<div class="line"><span class="stringliteral">    </span><span class="keyword">auto</span> data_json = json[<span class="stringliteral">&quot;my_value&quot;</span>].As&lt;MyKeyValue&gt;();</div>
<div class="line">    EXPECT_EQ(data_json.field1, <span class="stringliteral">&quot;one&quot;</span>);</div>
<div class="line">    EXPECT_EQ(data_json.field2, 1);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// yaml</span></div>
<div class="line">    <a class="code hl_class" href="../../da/dc1/classformats_1_1yaml_1_1Value.html" title="Non-mutable YAML value representation.">formats::yaml::Value</a> yaml = <a class="code hl_function" href="../../d7/d72/namespaceformats_1_1yaml.html#adaade9466d62f79f127e112bead15081" title="Parse YAML from string.">formats::yaml::FromString</a>(R<span class="stringliteral">&quot;(</span></div>
<div class="line"><span class="stringliteral">    my_value:</span></div>
<div class="line"><span class="stringliteral">        field1: &quot;one&quot;</span></div>
<div class="line"><span class="stringliteral">        field2: 1</span></div>
<div class="line"><span class="stringliteral">  )&quot;);</span></div>
<div class="line"><span class="stringliteral">    </span><span class="keyword">auto</span> data_yaml = yaml[<span class="stringliteral">&quot;my_value&quot;</span>].As&lt;MyKeyValue&gt;();</div>
<div class="line">    EXPECT_EQ(data_yaml.field1, <span class="stringliteral">&quot;one&quot;</span>);</div>
<div class="line">    EXPECT_EQ(data_yaml.field2, 1);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace my_namespace</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md261"></a>
Inline helpers formats::*::Make*</h2>
<p>To build objects of trivial types some of the formats provide inline helpers, like <a class="el" href="../../d3/dcb/group__userver__formats.html#gafc1e568ca1efc4014483f1bf319e105d">formats::json::MakeArray()</a>, <a class="el" href="../../d3/dcb/group__userver__formats.html#ga9fbc3907a2068f250572de539e6cf6de">formats::json::MakeObject()</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> kDoc = <a class="code hl_function" href="../../d3/dcb/group__userver__formats.html#ga9fbc3907a2068f250572de539e6cf6de">formats::json::MakeObject</a>(</div>
<div class="line">    <span class="stringliteral">&quot;key1&quot;</span>, 1,</div>
<div class="line">    <span class="stringliteral">&quot;key2&quot;</span>, <span class="stringliteral">&quot;val&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;key3&quot;</span>, <a class="code hl_function" href="../../d3/dcb/group__userver__formats.html#ga9fbc3907a2068f250572de539e6cf6de">formats::json::MakeObject</a>(<span class="stringliteral">&quot;sub&quot;</span>, -1),</div>
<div class="line">    <span class="stringliteral">&quot;key4&quot;</span>, <a class="code hl_function" href="../../d3/dcb/group__userver__formats.html#gafc1e568ca1efc4014483f1bf319e105d">formats::json::MakeArray</a>(1, 2, 3),</div>
<div class="line">    <span class="stringliteral">&quot;key5&quot;</span>, 10.5,</div>
<div class="line">    <span class="stringliteral">&quot;key6&quot;</span>, <span class="keyword">false</span></div>
<div class="line">);</div>
</div><!-- fragment --><p>Or <a class="el" href="../../dd/dee/namespaceformats_1_1bson.html#a63db58ec47961e5e12ca50d7f4d58636" title="Constructs a Document from provided key-value pairs.">formats::bson::MakeDoc()</a>, <a class="el" href="../../dd/dee/namespaceformats_1_1bson.html#a9037c8402aa532f2c93c89d1e9f573ab" title="Constructs an array Value from provided element list.">formats::bson::MakeArray()</a>:</p>
<div class="fragment"><div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> doc = <a class="code hl_function" href="../../dd/dee/namespaceformats_1_1bson.html#a63db58ec47961e5e12ca50d7f4d58636" title="Constructs a Document from provided key-value pairs.">formats::bson::MakeDoc</a>(</div>
<div class="line">        <span class="stringliteral">&quot;key_a&quot;</span>,</div>
<div class="line">        <a class="code hl_function" href="../../dd/dee/namespaceformats_1_1bson.html#a9037c8402aa532f2c93c89d1e9f573ab" title="Constructs an array Value from provided element list.">formats::bson::MakeArray</a>(0, 1, 2),  <span class="comment">//</span></div>
<div class="line">        <span class="stringliteral">&quot;key_d&quot;</span>,</div>
<div class="line">        <a class="code hl_function" href="../../dd/dee/namespaceformats_1_1bson.html#a63db58ec47961e5e12ca50d7f4d58636" title="Constructs a Document from provided key-value pairs.">formats::bson::MakeDoc</a>(<span class="stringliteral">&quot;one&quot;</span>, 1, <span class="stringliteral">&quot;two&quot;</span>, 2),  <span class="comment">//</span></div>
<div class="line">        <span class="stringliteral">&quot;key_n&quot;</span>,</div>
<div class="line">        <span class="keyword">nullptr</span>  <span class="comment">//</span></div>
<div class="line">    );</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> umap = doc[<span class="stringliteral">&quot;key_d&quot;</span>].As&lt;std::unordered_map&lt;std::string, int&gt;&gt;();</div>
<div class="line">    EXPECT_EQ(1, umap[<span class="stringliteral">&quot;one&quot;</span>]);</div>
<div class="line">    EXPECT_EQ(2, umap[<span class="stringliteral">&quot;two&quot;</span>]);</div>
</div><!-- fragment --><p>Those inline helper functions usually work slightly faster than <code>formats::*::ValueBuilder</code>. However, if you need a <code>std::string</code> with JSON the fastest way would be to use the <a class="el" href="#formats_streaming_serialization">Streaming Serialization</a>. Inline helpers could not be customized for used provided types, unlike other format building types. Inline helpers could produce broken value on bad input because they skip some of the checks, for example a key uniqueness check.</p>
<h2><a class="anchor" id="autotoc_md262"></a>
formats::*::ValueBuilder</h2>
<p>Classes <code><a class="el" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html" title="Builder for JSON.">formats::json::ValueBuilder</a></code>, <code><a class="el" href="../../de/d70/classformats_1_1bson_1_1ValueBuilder.html" title="Builder for BSON.">formats::bson::ValueBuilder</a></code> and <code><a class="el" href="../../d9/de3/classformats_1_1yaml_1_1ValueBuilder.html" title="Builder for YAML.">formats::yaml::ValueBuilder</a></code> are designed for building objects of a given format.</p>
<p>Usage Example:</p>
<div class="fragment"><div class="line">    <span class="comment">// #include &lt;userver/formats/json.hpp&gt;</span></div>
<div class="line">    <a class="code hl_class" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html" title="Builder for JSON.">formats::json::ValueBuilder</a> builder;</div>
<div class="line">    builder[<span class="stringliteral">&quot;key1&quot;</span>] = 1;</div>
<div class="line">    builder[<span class="stringliteral">&quot;key2&quot;</span>][<span class="stringliteral">&quot;key3&quot;</span>] = <span class="stringliteral">&quot;val&quot;</span>;</div>
<div class="line">    <a class="code hl_class" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value</a> json = builder.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a078ae0edbffa37a654914629000680ad" title="Take out the resulting Value object. After calling this method the object is in unspecified (but vali...">ExtractValue</a>();</div>
<div class="line"> </div>
<div class="line">    ASSERT_EQ(json[<span class="stringliteral">&quot;key1&quot;</span>].As&lt;int&gt;(), 1);</div>
<div class="line">    ASSERT_EQ(json[<span class="stringliteral">&quot;key2&quot;</span>][<span class="stringliteral">&quot;key3&quot;</span>].As&lt;std::string&gt;(), <span class="stringliteral">&quot;val&quot;</span>);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md263"></a>
Customization of formats::*::ValueBuilder</h2>
<p>In order for <code>formats::*::ValueBuilder</code> to be able to represent a C++ type in the specified format, you should write a special function <code>Serialize</code> for that C++ type. <code>Serialize</code> should be located in the namespace of the type or may be located in the <code><a class="el" href="../../d4/d6e/namespaceformats_1_1common.html" title="Common utilities for all the formats.">formats::common</a></code> namespace if the type comes from third-party library that you have no control of:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>my_namespace {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>MyKeyValue {</div>
<div class="line">    std::string field1;</div>
<div class="line">    <span class="keywordtype">int</span> field2;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// The function must be declared in the namespace of your type</span></div>
<div class="line"><a class="code hl_class" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value</a> <a class="code hl_function" href="../../da/d81/namespacedecimal64.html#a4b4e3949d5a30d3fb74593264c484a6f" title="Serializes the Decimal to string.">Serialize</a>(<span class="keyword">const</span> MyKeyValue&amp; data, <a class="code hl_struct" href="../../d7/d48/structformats_1_1serialize_1_1To.html">formats::serialize::To&lt;formats::json::Value&gt;</a>) {</div>
<div class="line">    <a class="code hl_class" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html" title="Builder for JSON.">formats::json::ValueBuilder</a> builder;</div>
<div class="line">    builder[<span class="stringliteral">&quot;field1&quot;</span>] = data.field1;</div>
<div class="line">    builder[<span class="stringliteral">&quot;field2&quot;</span>] = data.field2;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> builder.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a078ae0edbffa37a654914629000680ad" title="Take out the resulting Value object. After calling this method the object is in unspecified (but vali...">ExtractValue</a>();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">TEST(JsonValueBuilder, ExampleCustomization) {</div>
<div class="line">    MyKeyValue <span class="keywordtype">object</span> = {<span class="stringliteral">&quot;val&quot;</span>, 1};</div>
<div class="line">    <a class="code hl_class" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html" title="Builder for JSON.">formats::json::ValueBuilder</a> builder;</div>
<div class="line">    builder[<span class="stringliteral">&quot;example&quot;</span>] = object;</div>
<div class="line">    <span class="keyword">auto</span> json = builder.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a078ae0edbffa37a654914629000680ad" title="Take out the resulting Value object. After calling this method the object is in unspecified (but vali...">ExtractValue</a>();</div>
<div class="line">    ASSERT_EQ(json[<span class="stringliteral">&quot;example&quot;</span>][<span class="stringliteral">&quot;field1&quot;</span>].As&lt;std::string&gt;(), <span class="stringliteral">&quot;val&quot;</span>);</div>
<div class="line">    ASSERT_EQ(json[<span class="stringliteral">&quot;example&quot;</span>][<span class="stringliteral">&quot;field2&quot;</span>].As&lt;int&gt;(), 1);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">TEST(JsonValueBuilder, StringViewRemove) {</div>
<div class="line">    <a class="code hl_class" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html" title="Builder for JSON.">formats::json::ValueBuilder</a> builder;</div>
<div class="line">    <span class="keyword">const</span> std::string str = <span class="stringliteral">&quot;ab&quot;</span>;</div>
<div class="line">    builder[<span class="stringliteral">&quot;a&quot;</span>] = 1;</div>
<div class="line">    builder[str] = 2;</div>
<div class="line">    builder.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#ac889e99bbd4354fe19b0cae27bed6be9" title="Remove key from object. If key is missing nothing happens.">Remove</a>(std::string_view(str.data(), 1));</div>
<div class="line"> </div>
<div class="line">    EXPECT_EQ(1, builder.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a7d9042f97115107af8ab02c87655fa7d" title="Returns array size or object members count.">GetSize</a>());</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> value = builder.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a078ae0edbffa37a654914629000680ad" title="Take out the resulting Value object. After calling this method the object is in unspecified (but vali...">ExtractValue</a>();</div>
<div class="line">    EXPECT_EQ(2, value[str].As&lt;int&gt;());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">TEST(JsonValueBuilder, StringViewHasMember) {</div>
<div class="line">    <a class="code hl_class" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html" title="Builder for JSON.">formats::json::ValueBuilder</a> main_builder;</div>
<div class="line">    <span class="keyword">const</span> std::string str = <span class="stringliteral">&quot;ab&quot;</span>;</div>
<div class="line">    main_builder[str] = 2;</div>
<div class="line">    EXPECT_EQ(<span class="keyword">false</span>, main_builder.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a347fb158912e5b68497da6736bc43fed" title="Returns true if value holds a key.">HasMember</a>(<span class="stringliteral">&quot;a&quot;</span>));</div>
<div class="line">    EXPECT_EQ(<span class="keyword">false</span>, main_builder.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a347fb158912e5b68497da6736bc43fed" title="Returns true if value holds a key.">HasMember</a>(std::string_view(str.data(), 1)));</div>
<div class="line">    EXPECT_EQ(<span class="keyword">true</span>, main_builder.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a347fb158912e5b68497da6736bc43fed" title="Returns true if value holds a key.">HasMember</a>(std::string_view(str.data(), 2)));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">TEST(JsonValueBuilder, StringViewEmplaceNocheck) {</div>
<div class="line">    <a class="code hl_class" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html" title="Builder for JSON.">formats::json::ValueBuilder</a> main_builder;</div>
<div class="line">    <span class="keyword">const</span> std::string str = <span class="stringliteral">&quot;ab&quot;</span>;</div>
<div class="line">    main_builder.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a0c87fc2ce90f66b1c62728c793727d89" title="Emplaces new member w/o a check whether the key already exists.">EmplaceNocheck</a>(std::string_view(str.data(), 1), 1);</div>
<div class="line">    main_builder.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a0c87fc2ce90f66b1c62728c793727d89" title="Emplaces new member w/o a check whether the key already exists.">EmplaceNocheck</a>(std::string_view(str.data(), 2), 2);</div>
<div class="line">    main_builder.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a0c87fc2ce90f66b1c62728c793727d89" title="Emplaces new member w/o a check whether the key already exists.">EmplaceNocheck</a>(std::string_view(std::string(1024, <span class="charliteral">&#39;a&#39;</span>) + <span class="charliteral">&#39;b&#39;</span>), 1025);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> value = main_builder.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a078ae0edbffa37a654914629000680ad" title="Take out the resulting Value object. After calling this method the object is in unspecified (but vali...">ExtractValue</a>();</div>
<div class="line">    EXPECT_EQ(1, value[<span class="stringliteral">&quot;a&quot;</span>].As&lt;int&gt;());</div>
<div class="line">    EXPECT_EQ(2, value[<span class="stringliteral">&quot;ab&quot;</span>].As&lt;int&gt;());</div>
<div class="line">    EXPECT_EQ(1025, value[std::string(1024, <span class="charliteral">&#39;a&#39;</span>) + <span class="charliteral">&#39;b&#39;</span>].As&lt;int&gt;());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace my_namespace</span></div>
<div class="line"> </div>
</div><!-- fragment --><p>You can write a single serializer for all formats, for make it a template:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../db/d1e/universal_2include_2userver_2formats_2json_8hpp.html" title="Include-all header for JSON support.">userver/formats/json.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d5/d95/yaml_8hpp.html" title="Include-all header for YAML support.">userver/formats/yaml.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line">USERVER_NAMESPACE_BEGIN</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>my_namespace {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>MyKeyValue {</div>
<div class="line">    std::string field1;</div>
<div class="line">    <span class="keywordtype">int</span> field2;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// The function must be declared in the namespace of your type</span></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> Value&gt;</div>
<div class="line">Value <a class="code hl_function" href="../../da/d81/namespacedecimal64.html#a4b4e3949d5a30d3fb74593264c484a6f" title="Serializes the Decimal to string.">Serialize</a>(<span class="keyword">const</span> MyKeyValue&amp; data, <a class="code hl_struct" href="../../d7/d48/structformats_1_1serialize_1_1To.html">formats::serialize::To&lt;Value&gt;</a>) {</div>
<div class="line">    <span class="keyword">typename</span> Value::Builder builder;</div>
<div class="line">    builder[<span class="stringliteral">&quot;field1&quot;</span>] = data.field1;</div>
<div class="line">    builder[<span class="stringliteral">&quot;field2&quot;</span>] = data.field2;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> builder.ExtractValue();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">TEST(CommonFormats, Serialize) {</div>
<div class="line">    MyKeyValue obj = {<span class="stringliteral">&quot;val&quot;</span>, 1};</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// json</span></div>
<div class="line">    <a class="code hl_class" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html" title="Builder for JSON.">formats::json::ValueBuilder</a> builderJson;</div>
<div class="line">    builderJson[<span class="stringliteral">&quot;example&quot;</span>] = obj;</div>
<div class="line">    <span class="keyword">auto</span> json = builderJson.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a078ae0edbffa37a654914629000680ad" title="Take out the resulting Value object. After calling this method the object is in unspecified (but vali...">ExtractValue</a>();</div>
<div class="line">    EXPECT_EQ(json[<span class="stringliteral">&quot;example&quot;</span>][<span class="stringliteral">&quot;field1&quot;</span>].As&lt;std::string&gt;(), <span class="stringliteral">&quot;val&quot;</span>);</div>
<div class="line">    EXPECT_EQ(json[<span class="stringliteral">&quot;example&quot;</span>][<span class="stringliteral">&quot;field2&quot;</span>].As&lt;int&gt;(), 1);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// yaml</span></div>
<div class="line">    <a class="code hl_class" href="../../d9/de3/classformats_1_1yaml_1_1ValueBuilder.html" title="Builder for YAML.">formats::yaml::ValueBuilder</a> builderYaml;</div>
<div class="line">    builderYaml[<span class="stringliteral">&quot;example&quot;</span>] = obj;</div>
<div class="line">    <span class="keyword">auto</span> yaml = builderYaml.<a class="code hl_function" href="../../d9/de3/classformats_1_1yaml_1_1ValueBuilder.html#a5264ffa1c1bb1f1f7fe6bae08aebd464" title="Take out the resulting Value object. After calling this method the object is in unspecified (but vali...">ExtractValue</a>();</div>
<div class="line">    EXPECT_EQ(yaml[<span class="stringliteral">&quot;example&quot;</span>][<span class="stringliteral">&quot;field1&quot;</span>].As&lt;std::string&gt;(), <span class="stringliteral">&quot;val&quot;</span>);</div>
<div class="line">    EXPECT_EQ(yaml[<span class="stringliteral">&quot;example&quot;</span>][<span class="stringliteral">&quot;field2&quot;</span>].As&lt;int&gt;(), 1);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace my_namespace</span></div>
</div><!-- fragment --><p><a class="anchor" id="formats_streaming_serialization"></a></p>
<h2><a class="anchor" id="autotoc_md264"></a>
Streaming Serialization</h2>
<p>For runtime-critical code, it is possible to use streaming serializers. They allow you to serialize several times faster than <code><a class="el" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html" title="Builder for JSON.">formats::json::ValueBuilder</a></code>, but should be used carefully because may produce broken format.</p>
<p>At the moment, <b>stream serialization is implemented only for JSON</b> via the <code><a class="el" href="../../da/d55/classformats_1_1json_1_1StringBuilder.html" title="SAX like builder of JSON string. Use with extreme caution and only in performance critical part of yo...">formats::json::StringBuilder</a></code>.</p>
<p>In order for stream serialization to work with your data type, you need to define the <code>WriteToStream</code> function in the namespace of your type:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>my_namespace {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>MyKeyValue {</div>
<div class="line">    std::string field1;</div>
<div class="line">    <span class="keywordtype">int</span> field2;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// The function must be declared in the namespace of your type</span></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code hl_function" href="../../da/d81/namespacedecimal64.html#aefab7afd1e43337052854ff312601e0f" title="Writes the Decimal to stream.">WriteToStream</a>(<span class="keyword">const</span> MyKeyValue&amp; data, <a class="code hl_class" href="../../da/d55/classformats_1_1json_1_1StringBuilder.html" title="SAX like builder of JSON string. Use with extreme caution and only in performance critical part of yo...">formats::json::StringBuilder</a>&amp; sw) {</div>
<div class="line">    <span class="comment">// A class that adds &#39;{&#39; in the constructor and &#39;}&#39; in the destructor to JSON</span></div>
<div class="line">    <a class="code hl_class" href="../../dc/d9e/classformats_1_1json_1_1StringBuilder_1_1ObjectGuard.html">formats::json::StringBuilder::ObjectGuard</a> guard{sw};</div>
<div class="line"> </div>
<div class="line">    sw.<a class="code hl_function" href="../../da/d55/classformats_1_1json_1_1StringBuilder.html#a7057fbfd7f40ad44d80dd4c48d351eeb" title="ONLY for objects/dicts: write key.">Key</a>(<span class="stringliteral">&quot;field1&quot;</span>);</div>
<div class="line">    <span class="comment">// Use the WriteToStream functions for values, don&#39;t work with StringBuilder</span></div>
<div class="line">    <span class="comment">// directly</span></div>
<div class="line">    <a class="code hl_function" href="../../da/d81/namespacedecimal64.html#aefab7afd1e43337052854ff312601e0f" title="Writes the Decimal to stream.">WriteToStream</a>(data.field1, sw);</div>
<div class="line"> </div>
<div class="line">    sw.<a class="code hl_function" href="../../da/d55/classformats_1_1json_1_1StringBuilder.html#a7057fbfd7f40ad44d80dd4c48d351eeb" title="ONLY for objects/dicts: write key.">Key</a>(<span class="stringliteral">&quot;field2&quot;</span>);</div>
<div class="line">    <a class="code hl_function" href="../../da/d81/namespacedecimal64.html#aefab7afd1e43337052854ff312601e0f" title="Writes the Decimal to stream.">WriteToStream</a>(data.field2, sw);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">TEST(JsonStringBuilder, ExampleUsage) {</div>
<div class="line">    StringBuilder sb;</div>
<div class="line">    MyKeyValue data = {<span class="stringliteral">&quot;one&quot;</span>, 1};</div>
<div class="line">    <a class="code hl_function" href="../../da/d81/namespacedecimal64.html#aefab7afd1e43337052854ff312601e0f" title="Writes the Decimal to stream.">WriteToStream</a>(data, sb);</div>
<div class="line">    ASSERT_EQ(sb.GetString(), <span class="stringliteral">&quot;{\&quot;field1\&quot;:\&quot;one\&quot;,\&quot;field2\&quot;:1}&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace my_namespace</span></div>
</div><!-- fragment --><p>Note that you may get <b>invalid</b> JSON, since:</p><ul>
<li>methods <code>format::json methods::StringBuilder::Key</code> <b>do not</b> check the uniqueness of keys</li>
<li><code>StringBuilder</code> itself does not put curly brackets, you need to use <a class="el" href="../../dc/d9e/classformats_1_1json_1_1StringBuilder_1_1ObjectGuard.html">formats::json::StringBuilder::ObjectGuard</a></li>
<li><code>StringBuilder</code> itself does not put square brackets, you need to use <a class="el" href="../../d2/da7/classformats_1_1json_1_1StringBuilder_1_1ArrayGuard.html">formats::json::StringBuilder::ArrayGuard</a></li>
<li>You can write any nonsense in JSON using <code>StringBuilder</code> methods</li>
<li>etc.</li>
</ul>
<p>Test your serializers!</p>
<hr  />
<p> <div class="bottom-nav">  ⇦ <a class="el" href="../../d6/d6c/md_en_2userver_2synchronization.html">Synchronization Primitives</a> | <a class="el" href="../../d8/d43/md_en_2userver_2chaotic.html">JSON schema codegen - the Chaotic</a> ⇨  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:55:59 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
