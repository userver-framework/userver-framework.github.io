<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: Deploy Environment Specific Configurations</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d2/d58/md_en_2userver_2deploy__env.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Deploy Environment Specific Configurations</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md183"></a> This page describes typical setups of the service that uses userver framework. The purpose of the page is not to provide an ideal solution with perfectly matching 3rd-party tools, but rather show different approaches and give a starting point for designing and configuring an environment.</p>
<h2><a class="anchor" id="autotoc_md184"></a>
All-in-one single instance setup</h2>
<p>A simple setup, usually used during development. The request comes directly into the service, it is processed, logs are written. During processing the service could do direct requests to other services.</p>
<div class="dotgraph">
<iframe scrolling="no" frameborder="0" src="../../dot_inline_dotgraph_1.svg" width="726" height="255"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
<p><b>Pros:</b></p><ul>
<li>Simple</li>
</ul>
<p><b>Cons:</b></p><ul>
<li>Is not reliable, only a single service instance exists.</li>
<li>Database affects efficiency and reliability of the service</li>
<li>Logs and metrics could be retrieved only by direct inspecting of the container</li>
</ul>
<p>This configuration is quite useful for testing. However, there's no need to configure it manually for tests, because testsuite does that automatically (starts databases, fills them with data, tunes logging, mocks other services). See <a class="el" href="../../df/d07/md_en_2userver_2functional__testing.html">Functional service tests (testsuite)</a> for more info.</p>
<p>For non testing purposes the configuration could be also quite useful for services that should have a single instance and have small load on database. Internal services that require no reliability and chat bots are examples of such services. For a starting point on configuration see <a class="el" href="../../db/d69/md_en_2userver_2tutorial_2production__service.html">Production configs and best practices</a>.</p>
<p>Note that for a longstanding runs the logs of the service should be cleaned up at some point. Configure the <code>logrotate</code> like software to move/remove the old logs and notify the <code>üêô Service</code> by <code>SIGUSR1</code> signal: <br  />
 </p><div class="fragment"><div class="line">postrotate</div>
<div class="line">    /usr/bin/killall -USR1 yourapp</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md185"></a>
Production setup with balancer</h2>
<p>A good setup for a production. The request comes into a service balancer, balancer routes the request into one of the instances of the setup. In the instance the request goes into the Nginx (or some other reverse proxy, or just goes directly to the <code>üêô Service</code>). Nginx could serve static requests, terminate TLS, do some header rewrites and forward request to the <code>üêô Service</code>.</p>
<p>The service uses <a class="el" href="../../d4/d95/md_en_2userver_2tutorial_2config__service.html">dynamic configs service</a>, writes logs.</p>
<p>Some <code>Metrics Uploader</code> script is periodically called, it <a class="el" href="../../d9/dac/md_en_2userver_2service__monitor.html">retrieves metrics</a> from the <code>üêô Service</code> and sends the results to <code>Metrics Aggregateor</code> (could be Prometheus, Graphite, VictoriaMetrics). Metrics could be viewed in web interface, for example via Grafana .</p>
<p><code>Logs Collector</code> (for example <code>logstash</code>, <code>fluentd</code>, <code>vector</code>) processes the logs file and uploads results to logs aggregator (for example Elasticsearch). Logs could be viewed in web interface, for example via Kibana.</p>
<div class="dotgraph">
<iframe scrolling="no" frameborder="0" src="../../dot_inline_dotgraph_2.svg" width="1183" height="479"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
<p><b>Pros:</b></p><ul>
<li>Reliable - multiple instances of service, balancers and database exist.</li>
<li>Service and database do not affect each other.</li>
<li>Diagnosable - logs and metrics from all the instances are available for the developers.</li>
</ul>
<p><b>Cons:</b></p><ul>
<li>Hard to reconfigure balancers, especially on instance count change</li>
<li>Balancers require separate containers</li>
</ul>
<p><code>Metrics Uploader</code> script could be implemented in bash or Python to request <a class="el" href="../../d9/dac/md_en_2userver_2service__monitor.html">service monitor</a>. Note that for small containers the script could eat up quite a lot of resources if it converts metrics from one format to another. Prefer using already supported metrics format and feel free to add new formats via Pull Requests to <a href="https://github.com/userver-framework/userver">userver github</a>.</p>
<p>To avoid TCP/IP overhead it is useful to configure the <code>üêô Service</code> to interact with <code>Nginx</code> via pipes. For HTTP this could be done by configuring the <a class="el" href="../../d0/d0b/classcomponents_1_1Server.html" title="Component that listens for incoming requests, manages incoming connections and passes the requests to...">components::Server</a> to use <code>unix-socket</code> rather than <code>port</code> static configuration option.</p>
<p>Beware of the <code>Logs Collector</code> software. Some of those applications are not very reliable and could eat up a lot of dynamic memory. In general, it is a good idea to limit their memory consumption by cgroups like mechanism or adjust OOM-killer priorities to kill the <code>Logs Collector</code> rather that the <code>üêô Service</code> itself. Also, do not forget to configure <code>logrotate</code>, as was shown in the first recipe.</p>
<p>See <a class="el" href="../../db/d69/md_en_2userver_2tutorial_2production__service.html">Production configs and best practices</a> for more configuration tips and tricks.</p>
<h2><a class="anchor" id="autotoc_md186"></a>
Production setup with service-mesh</h2>
<p>A good production setup that tries to solve issues with balancers from previous setup.</p>
<p>The request comes into a <code>Sidecar Proxy</code> (like Envoy) directly. It could do some work of routing, header rewrites and forwards request to the <code>üêô Service</code>.</p>
<p><code>Sidecar Proxy</code> is configured via <code>xDS</code> (service discovery service) and knows about all the instances of all the services. If the <code>üêô Service</code> has to do a network request, it does it via <code>Sidecar Proxy</code>, that routes the request directly into one of the instances of the service. See <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html#USERVER_HTTP_PROXY">USERVER_HTTP_PROXY</a> for an info on how to route all the HTTP client requests to the <code>Sidecar Proxy</code>.</p>
<p>All other parts of the setup remain the same as in the previous approach.</p>
<p>The service uses <a class="el" href="../../d4/d95/md_en_2userver_2tutorial_2config__service.html">dynamic configs service</a>, writes logs.</p>
<p>Some <code>Metrics Uploader</code> script is periodically called, it <a class="el" href="../../d9/dac/md_en_2userver_2service__monitor.html">retrieves metrics</a> from the <code>üêô Service</code> and sends the results to <code>Metrics Aggregateor</code>. Metrics could be viewed in web interface, for example via Grafana .</p>
<p><code>Logs Collector</code> (for example <code>logstash</code>, <code>fluentd</code>, <code>vector</code>) processes the logs file and uploads results to logs aggregator (for example Elasticsearch). Logs could be viewed in web interface, for example via Kibana.</p>
<div class="dotgraph">
<iframe scrolling="no" frameborder="0" src="../../dot_inline_dotgraph_3.svg" width="1211" height="702"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
<p><b>Pros:</b></p><ul>
<li>Service and database do not affect each other.</li>
<li>Diagnosable - logs and metrics from all the instances are available for the developers.</li>
<li>Less network hops and simple configuration of balancing</li>
</ul>
<p><b>Cons:</b></p><ul>
<li><code>xDS</code> becomes a single point of failure if the <code>Sidecar Proxy</code> could not start without it after container restart.</li>
</ul>
<p>The setup is very close to the setup from previous recipe (except for the <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html#USERVER_HTTP_PROXY">USERVER_HTTP_PROXY</a>). refer to it for more tips.</p>
<h2><a class="anchor" id="autotoc_md187"></a>
Sidecar</h2>
<p>This setup is useful for implementing some supplementary functionality to the main service. Usually the same sidecar is used for multiple different services of different logic.</p>
<p>Otherwise, the sidecar could be used as a first step of decomposing the main service into smaller parts.</p>
<div class="dotgraph">
<iframe scrolling="no" frameborder="0" src="../../dot_inline_dotgraph_4.svg" width="1342" height="132"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
<p><b>Pros:</b></p><ul>
<li>Increases reliability of the main service by moving out supplementary logic</li>
<li>Could be reused for different applications</li>
</ul>
<p>In cases, where the sidecar is used to decompose main service to smaller parts the tips from previous recipes apply.</p>
<p>For the case of supplementary logic the sidecar usually does not do heavy logic and should be configured for minimal resource consumption. Remove the unused components from code and/or adjust the static config file: </p><div class="fragment"><div class="line"># yaml</div>
<div class="line">components_manager:</div>
<div class="line">    coro_pool:</div>
<div class="line">        initial_size: 100         # Save memory and do not allocate many coroutines at start.</div>
<div class="line">        max_size: 200             # Do not keep more than 200 preallocated coroutines.</div>
<div class="line">        local_cache_size: 8       # Reduce thread-local coroutine cache size to avoid consuming extra coroutines.</div>
<div class="line"> </div>
<div class="line">    task_processors:</div>
<div class="line">        main-task-processor:</div>
<div class="line">            worker_threads: 1     # Process tasks in 1 thread.</div>
<div class="line"> </div>
<div class="line">    default_task_processor: main-task-processor</div>
<div class="line"> </div>
<div class="line">    # A sidecar doesn&#39;t need to trade RES memory for responsiveness in rare edge cases</div>
<div class="line">    mlock_debug_info: false</div>
<div class="line"> </div>
<div class="line">components:</div>
<div class="line">      congestion-control:</div>
<div class="line">          load-enabled: false</div>
<div class="line"> </div>
<div class="line">      # A sidecar doesn&#39;t want detailed HTTP client statistics</div>
<div class="line">      http-client:</div>
<div class="line">          destination-metrics-auto-max-size: 0</div>
<div class="line">          pool-statistics-disable: true</div>
<div class="line">          threads: 1</div>
<div class="line"> </div>
<div class="line">      # Sidecars should not upload system statistics</div>
<div class="line">      system-statistics-collector:</div>
<div class="line">          load-enabled: false</div>
<div class="line"> </div>
<div class="line">      # Sidecars usually do not provide business logic HTTP handlers</div>
<div class="line">      handler-implicit-http-options:</div>
<div class="line">          load-enabled: false</div>
<div class="line">      handler-inspect-requests:</div>
<div class="line">          load-enabled: false</div>
</div><!-- fragment --><p>Also, there's usually no need in very high responsiveness of the sidecar, so use the same <code>main-task-processor</code> for all the task processors.</p>
<hr  />
<p> <div class="bottom-nav">  ‚á¶ <a class="el" href="../../d3/da9/md_en_2userver_2tutorial_2build.html">Configure, Build and Install</a> | <a class="el" href="../../d0/d7b/md_en_2userver_2development_2releases.html">Releases, Trunk-based Development and Pull Requests</a> ‚á®  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:55:59 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
