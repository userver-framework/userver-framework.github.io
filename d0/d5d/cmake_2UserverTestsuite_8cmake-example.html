<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: cmake/UserverTestsuite.cmake</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d0/d5d/cmake_2UserverTestsuite_8cmake-example.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">cmake/UserverTestsuite.cmake</div></div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"># Functions for running testsuite tests.</div>
<div class="line">#</div>
<div class="line"># Provides:</div>
<div class="line"># - USERVER_FEATURE_TESTSUITE option</div>
<div class="line"># - userver_testsuite_requirements function that returns a list of requirements</div>
<div class="line">#   files needed to run userver testsuite</div>
<div class="line"># - userver_testsuite_add function that registers a directory with testsuite</div>
<div class="line">#   tests in ctest. Note that userver testsuite requires some arguments, they</div>
<div class="line">#   should be passed manually using PYTEST_ARGS</div>
<div class="line"># - userver_testsuite_add_simple that automatically detects and fills in some</div>
<div class="line">#   PYTEST_ARGS</div>
<div class="line">#</div>
<div class="line"># Implementation note: public functions here should be usable even without</div>
<div class="line"># a direct include of this script, so the functions should not rely</div>
<div class="line"># on non-cache variables being present.</div>
<div class="line">include_guard(GLOBAL)</div>
<div class="line"> </div>
<div class="line"># Pack initialization into a function to avoid non-cache variable leakage.</div>
<div class="line">function(_userver_prepare_testsuite)</div>
<div class="line">  include(&quot;${CMAKE_CURRENT_LIST_DIR}/UserverVenv.cmake&quot;)</div>
<div class="line">  set_property(GLOBAL PROPERTY userver_cmake_dir &quot;${CMAKE_CURRENT_LIST_DIR}&quot;)</div>
<div class="line"> </div>
<div class="line">  option(USERVER_FEATURE_TESTSUITE &quot;Enable functional tests via testsuite&quot; ON)</div>
<div class="line"> </div>
<div class="line">  if(USERVER_FEATURE_TESTSUITE AND NOT USERVER_PYTHON_DEV_CHECKED)</div>
<div class="line">    # find package python3-dev required by venv</div>
<div class="line">    execute_process(</div>
<div class="line">        COMMAND sh &quot;-c&quot; &quot;command -v python3-config&quot;</div>
<div class="line">        OUTPUT_VARIABLE PYTHONCONFIG_FOUND</div>
<div class="line">    )</div>
<div class="line">    if(NOT PYTHONCONFIG_FOUND)</div>
<div class="line">      message(FATAL_ERROR &quot;Python dev is not found&quot;)</div>
<div class="line">    endif()</div>
<div class="line">    set(USERVER_PYTHON_DEV_CHECKED TRUE CACHE INTERNAL &quot;&quot; FORCE)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(NOT USERVER_TESTSUITE_DIR)</div>
<div class="line">    get_filename_component(</div>
<div class="line">        USERVER_TESTSUITE_DIR &quot;${CMAKE_CURRENT_LIST_DIR}/../testsuite&quot; ABSOLUTE)</div>
<div class="line">  endif()</div>
<div class="line">  set_property(GLOBAL PROPERTY userver_testsuite_dir &quot;${USERVER_TESTSUITE_DIR}&quot;)</div>
<div class="line"> </div>
<div class="line">  if(USERVER_FEATURE_TESTSUITE)</div>
<div class="line">    userver_testsuite_requirements(REQUIREMENTS_FILES_VAR requirements_files TESTSUITE_ONLY)</div>
<div class="line">    userver_venv_setup(</div>
<div class="line">      NAME utest</div>
<div class="line">      # TESTSUITE_PYTHON_BINARY is used in `env.in`</div>
<div class="line">      PYTHON_OUTPUT_VAR TESTSUITE_PYTHON_BINARY</div>
<div class="line">      REQUIREMENTS ${requirements_files}</div>
<div class="line">      UNIQUE</div>
<div class="line">      )</div>
<div class="line">    configure_file(&quot;${USERVER_TESTSUITE_DIR}/env.in&quot; &quot;${CMAKE_BINARY_DIR}/testsuite/env&quot; @ONLY)</div>
<div class="line">  endif()</div>
<div class="line">endfunction()</div>
<div class="line"> </div>
<div class="line">function(userver_testsuite_requirements)</div>
<div class="line">  set(options TESTSUITE_ONLY)</div>
<div class="line">  set(oneValueArgs REQUIREMENTS_FILES_VAR)</div>
<div class="line">  set(multiValueArgs)</div>
<div class="line"> </div>
<div class="line">  cmake_parse_arguments(</div>
<div class="line">      ARG &quot;${options}&quot; &quot;${oneValueArgs}&quot; &quot;${multiValueArgs}&quot; &quot;${ARGN}&quot;)</div>
<div class="line"> </div>
<div class="line">  get_property(USERVER_CMAKE_DIR GLOBAL PROPERTY userver_cmake_dir)</div>
<div class="line">  get_property(USERVER_TESTSUITE_DIR GLOBAL PROPERTY userver_testsuite_dir)</div>
<div class="line"> </div>
<div class="line">  list(APPEND requirements_files</div>
<div class="line">      &quot;${USERVER_TESTSUITE_DIR}/requirements.txt&quot;)</div>
<div class="line"> </div>
<div class="line">  if(USERVER_FEATURE_GRPC OR TARGET userver::grpc)</div>
<div class="line">    get_property(protobuf_category</div>
<div class="line">        GLOBAL PROPERTY userver_protobuf_version_category)</div>
<div class="line">    if(NOT protobuf_category)</div>
<div class="line">      include(&quot;${USERVER_CMAKE_DIR}/SetupProtobuf.cmake&quot;)</div>
<div class="line">      get_property(protobuf_category</div>
<div class="line">          GLOBAL PROPERTY userver_protobuf_version_category)</div>
<div class="line">    endif()</div>
<div class="line">    list(APPEND requirements_files</div>
<div class="line">        &quot;${USERVER_TESTSUITE_DIR}/requirements-grpc-${protobuf_category}.txt&quot;)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(USERVER_FEATURE_MONGODB OR TARGET userver::mongo)</div>
<div class="line">    list(APPEND requirements_files</div>
<div class="line">        &quot;${USERVER_TESTSUITE_DIR}/requirements-mongo.txt&quot;)</div>
<div class="line">    list(APPEND testsuite_modules mongodb)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(USERVER_FEATURE_POSTGRESQL OR TARGET userver::postgresql)</div>
<div class="line">    list(APPEND requirements_files</div>
<div class="line">        &quot;${USERVER_TESTSUITE_DIR}/requirements-postgres.txt&quot;)</div>
<div class="line">    if (${CMAKE_SYSTEM_NAME} MATCHES &quot;Darwin&quot;)</div>
<div class="line">      list(APPEND testsuite_modules postgresql-binary)</div>
<div class="line">    else()</div>
<div class="line">      list(APPEND testsuite_modules postgresql)</div>
<div class="line">    endif()</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(USERVER_FEATURE_YDB OR TARGET userver::ydb)</div>
<div class="line">    list(APPEND requirements_files</div>
<div class="line">        &quot;${USERVER_TESTSUITE_DIR}/requirements-ydb.txt&quot;)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(USERVER_FEATURE_REDIS OR TARGET userver::redis)</div>
<div class="line">    list(APPEND requirements_files</div>
<div class="line">        &quot;${USERVER_TESTSUITE_DIR}/requirements-redis.txt&quot;)</div>
<div class="line">    list(APPEND testsuite_modules redis)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(USERVER_FEATURE_CLICKHOUSE OR TARGET userver::clickhouse)</div>
<div class="line">    list(APPEND testsuite_modules clickhouse)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(USERVER_FEATURE_RABBITMQ OR TARGET userver::rabbitmq)</div>
<div class="line">    list(APPEND testsuite_modules rabbitmq)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(USERVER_FEATURE_KAFKA OR TARGET userver::kafka)</div>
<div class="line">    list(APPEND testsuite_modules kafka)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(USERVER_FEATURE_MYSQL OR TARGET userver::mysql)</div>
<div class="line">    list(APPEND testsuite_modules mysql)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  # This function returns &quot;public&quot; dependencies for userver-based services.</div>
<div class="line">  # For private dependencies that only userver&#39;s own tests need, see</div>
<div class="line">  # SetupUserverTestsuiteEnv.cmake</div>
<div class="line"> </div>
<div class="line">  file(READ &quot;${USERVER_TESTSUITE_DIR}/requirements-testsuite.txt&quot;</div>
<div class="line">      requirements_testsuite_text)</div>
<div class="line">  if(testsuite_modules)</div>
<div class="line">    list(JOIN testsuite_modules &quot;,&quot; testsuite_modules_str)</div>
<div class="line">    string(</div>
<div class="line">        REPLACE</div>
<div class="line">        &quot;yandex-taxi-testsuite[]&quot;</div>
<div class="line">        &quot;yandex-taxi-testsuite[${testsuite_modules_str}]&quot;</div>
<div class="line">        requirements_testsuite_text</div>
<div class="line">        &quot;${requirements_testsuite_text}&quot;</div>
<div class="line">    )</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  set(requirements_testsuite_file</div>
<div class="line">      &quot;${CMAKE_BINARY_DIR}/requirements-userver-testsuite.txt&quot;)</div>
<div class="line">  file(WRITE &quot;${requirements_testsuite_file}&quot; &quot;${requirements_testsuite_text}&quot;)</div>
<div class="line">  list(APPEND requirements_files &quot;${requirements_testsuite_file}&quot;)</div>
<div class="line"> </div>
<div class="line">  if(NOT ARG_TESTSUITE_ONLY)</div>
<div class="line">    set(&quot;${ARG_REQUIREMENTS_FILES_VAR}&quot; ${requirements_files} PARENT_SCOPE)</div>
<div class="line">  else()</div>
<div class="line">    set(&quot;${ARG_REQUIREMENTS_FILES_VAR}&quot; ${requirements_testsuite_file} PARENT_SCOPE)</div>
<div class="line">  endif()</div>
<div class="line">endfunction()</div>
<div class="line"> </div>
<div class="line">function(userver_testsuite_add)</div>
<div class="line">  set(oneValueArgs</div>
<div class="line">      SERVICE_TARGET</div>
<div class="line">      TEST_SUFFIX</div>
<div class="line">      WORKING_DIRECTORY</div>
<div class="line">      PYTHON_BINARY</div>
<div class="line">      PRETTY_LOGS</div>
<div class="line">  )</div>
<div class="line">  set(multiValueArgs</div>
<div class="line">      PYTEST_ARGS</div>
<div class="line">      REQUIREMENTS</div>
<div class="line">      PYTHONPATH</div>
<div class="line">      TEST_ENV</div>
<div class="line">  )</div>
<div class="line">  cmake_parse_arguments(</div>
<div class="line">    ARG &quot;${options}&quot; &quot;${oneValueArgs}&quot; &quot;${multiValueArgs}&quot;  ${ARGN})</div>
<div class="line"> </div>
<div class="line">  _userver_setup_environment_validate_impl()</div>
<div class="line"> </div>
<div class="line">  include(CTest)</div>
<div class="line"> </div>
<div class="line">  get_property(USERVER_TESTSUITE_DIR GLOBAL PROPERTY userver_testsuite_dir)</div>
<div class="line"> </div>
<div class="line">  if (NOT ARG_SERVICE_TARGET)</div>
<div class="line">    message(FATAL_ERROR &quot;No SERVICE_TARGET given for testsuite&quot;)</div>
<div class="line">    return()</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if (NOT ARG_WORKING_DIRECTORY)</div>
<div class="line">    set(ARG_WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR})</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if (NOT DEFINED ARG_PRETTY_LOGS)</div>
<div class="line">    set(ARG_PRETTY_LOGS ON)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if (NOT ARG_TEST_SUFFIX)</div>
<div class="line">    set(service_target_with_suffix &quot;${ARG_SERVICE_TARGET}&quot;)</div>
<div class="line">  else()</div>
<div class="line">    set(service_target_with_suffix &quot;${ARG_SERVICE_TARGET}-${ARG_TEST_SUFFIX}&quot;)</div>
<div class="line">  endif()</div>
<div class="line">  set(testsuite_test_name &quot;testsuite-${service_target_with_suffix}&quot;)</div>
<div class="line"> </div>
<div class="line">  if (NOT USERVER_FEATURE_TESTSUITE)</div>
<div class="line">    message(STATUS &quot;Testsuite test ${testsuite_test_name} is disabled&quot;)</div>
<div class="line">    return()</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(ARG_PYTHON_BINARY)</div>
<div class="line">    if(ARG_REQUIREMENTS)</div>
<div class="line">      message(FATAL_ERROR</div>
<div class="line">          &quot;PYTHON_BINARY and REQUIREMENTS options are incompatible&quot;)</div>
<div class="line">    endif()</div>
<div class="line">    set(python_binary &quot;${ARG_PYTHON_BINARY}&quot;)</div>
<div class="line">  elseif(ARG_REQUIREMENTS)</div>
<div class="line">    userver_testsuite_requirements(REQUIREMENTS_FILES_VAR requirements_files)</div>
<div class="line">    list(APPEND requirements_files ${ARG_REQUIREMENTS})</div>
<div class="line">    userver_venv_setup(</div>
<div class="line">        NAME &quot;${testsuite_test_name}&quot;</div>
<div class="line">        REQUIREMENTS ${requirements_files}</div>
<div class="line">        PYTHON_OUTPUT_VAR python_binary</div>
<div class="line">    )</div>
<div class="line">  else()</div>
<div class="line">    userver_testsuite_requirements(REQUIREMENTS_FILES_VAR requirements_files)</div>
<div class="line">    userver_venv_setup(</div>
<div class="line">        NAME userver-default</div>
<div class="line">        REQUIREMENTS ${requirements_files}</div>
<div class="line">        PYTHON_OUTPUT_VAR python_binary</div>
<div class="line">        UNIQUE</div>
<div class="line">    )</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(NOT python_binary)</div>
<div class="line">    message(FATAL_ERROR &quot;No python binary given.&quot;)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  set(TESTSUITE_RUNNER &quot;${CMAKE_CURRENT_BINARY_DIR}/runtests-${service_target_with_suffix}&quot;)</div>
<div class="line">  list(APPEND ARG_PYTHONPATH &quot;${USERVER_TESTSUITE_DIR}/pytest_plugins&quot;)</div>
<div class="line"> </div>
<div class="line">  execute_process(</div>
<div class="line">    COMMAND</div>
<div class="line">    &quot;${python_binary}&quot; &quot;${USERVER_TESTSUITE_DIR}/create_runner.py&quot;</div>
<div class="line">    &quot;--output=${TESTSUITE_RUNNER}&quot;</div>
<div class="line">    &quot;--python=${python_binary}&quot;</div>
<div class="line">    &quot;--python-path=${ARG_PYTHONPATH}&quot;</div>
<div class="line">    --</div>
<div class="line">    &quot;--build-dir=${CMAKE_CURRENT_BINARY_DIR}&quot;</div>
<div class="line">    &quot;--service-logs-file=${CMAKE_CURRENT_BINARY_DIR}/Testing/Temporary/service.log&quot;</div>
<div class="line">    &quot;--basetemp=${CMAKE_CURRENT_BINARY_DIR}/Testing/Temporary&quot;</div>
<div class="line">    ${ARG_PYTEST_ARGS}</div>
<div class="line">    RESULT_VARIABLE STATUS</div>
<div class="line">  )</div>
<div class="line">  if (STATUS)</div>
<div class="line">    message(FATAL_ERROR &quot;Failed to create testsuite runner&quot;)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  set(PRETTY_LOGS_MODE &quot;&quot;)</div>
<div class="line">  if (ARG_PRETTY_LOGS)</div>
<div class="line">      set(PRETTY_LOGS_MODE &quot;--service-logs-pretty&quot;)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  # Pre-collect command in a list to support spaces in paths</div>
<div class="line">  set(testsuite_test_command)</div>
<div class="line">  list(APPEND testsuite_test_command &quot;${python_binary}&quot;)</div>
<div class="line">  list(APPEND testsuite_test_command &quot;${TESTSUITE_RUNNER}&quot;)</div>
<div class="line">  list(APPEND testsuite_test_command ${PRETTY_LOGS_MODE})</div>
<div class="line">  list(APPEND testsuite_test_command -vv)</div>
<div class="line">  list(APPEND testsuite_test_command &quot;${ARG_WORKING_DIRECTORY}&quot;)</div>
<div class="line">  # Without WORKING_DIRECTORY the `add_test` prints better diagnostic info</div>
<div class="line">  add_test(</div>
<div class="line">      NAME &quot;${testsuite_test_name}&quot;</div>
<div class="line">      COMMAND ${testsuite_test_command}</div>
<div class="line">  )</div>
<div class="line">  if(ARG_TEST_ENV)</div>
<div class="line">    set_tests_properties(&quot;${testsuite_test_name}&quot;</div>
<div class="line">        PROPERTIES ENVIRONMENT &quot;${ARG_TEST_ENV}&quot;</div>
<div class="line">    )</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  # Pre-collect command in a list to support spaces in paths</div>
<div class="line">  set(testsuite_start_command)</div>
<div class="line">  list(APPEND testsuite_start_command &quot;${python_binary}&quot;)</div>
<div class="line">  list(APPEND testsuite_start_command &quot;${TESTSUITE_RUNNER}&quot;)</div>
<div class="line">  list(APPEND testsuite_start_command ${PRETTY_LOGS_MODE})</div>
<div class="line">  list(APPEND testsuite_start_command --service-runner-mode)</div>
<div class="line">  list(APPEND testsuite_start_command -vvs)</div>
<div class="line">  list(APPEND testsuite_start_command &quot;${ARG_WORKING_DIRECTORY}&quot;)</div>
<div class="line">  add_custom_target(</div>
<div class="line">      &quot;start-${service_target_with_suffix}&quot;</div>
<div class="line">      COMMAND ${testsuite_start_command}</div>
<div class="line">      DEPENDS &quot;${TESTSUITE_RUNNER}&quot;</div>
<div class="line">      VERBATIM</div>
<div class="line">      USES_TERMINAL</div>
<div class="line">  )</div>
<div class="line">  add_dependencies(&quot;start-${service_target_with_suffix}&quot; &quot;${ARG_SERVICE_TARGET}&quot;)</div>
<div class="line">endfunction()</div>
<div class="line"> </div>
<div class="line"># Tries to search service files in some standard places.</div>
<div class="line"># Should be invoked from the service&#39;s CMakeLists.txt</div>
<div class="line"># Supports the following file structure (and a few others):</div>
<div class="line"># - configs/config.yaml</div>
<div class="line"># - configs/config_vars.[testsuite|tests].yaml [optional]</div>
<div class="line"># - configs/dynamic_config_fallback.json [optional]</div>
<div class="line"># - configs/[secdist|secure_data].json [optional]</div>
<div class="line"># - [testsuite|tests]/conftest.py</div>
<div class="line">function(userver_testsuite_add_simple)</div>
<div class="line">  set(oneValueArgs</div>
<div class="line">      SERVICE_TARGET</div>
<div class="line">      TEST_SUFFIX</div>
<div class="line">      WORKING_DIRECTORY</div>
<div class="line">      PYTHON_BINARY</div>
<div class="line">      PRETTY_LOGS</div>
<div class="line">      CONFIG_PATH</div>
<div class="line">      CONFIG_VARS_PATH</div>
<div class="line">      DYNAMIC_CONFIG_FALLBACK_PATH</div>
<div class="line">      SECDIST_PATH</div>
<div class="line">  )</div>
<div class="line">  set(multiValueArgs</div>
<div class="line">      PYTEST_ARGS</div>
<div class="line">      REQUIREMENTS</div>
<div class="line">      PYTHONPATH</div>
<div class="line">      TEST_ENV</div>
<div class="line">  )</div>
<div class="line">  cmake_parse_arguments(</div>
<div class="line">      ARG &quot;${options}&quot; &quot;${oneValueArgs}&quot; &quot;${multiValueArgs}&quot; ${ARGN})</div>
<div class="line"> </div>
<div class="line">  _userver_setup_environment_validate_impl()</div>
<div class="line"> </div>
<div class="line">  set(pytest_additional_args)</div>
<div class="line"> </div>
<div class="line">  if(ARG_WORKING_DIRECTORY)</div>
<div class="line">    if(IS_ABSOLUTE &quot;${ARG_WORKING_DIRECTORY}&quot;)</div>
<div class="line">      file(RELATIVE_PATH tests_relative_path</div>
<div class="line">          &quot;${CMAKE_CURRENT_SOURCE_DIR}&quot; &quot;${ARG_WORKING_DIRECTORY}&quot;)</div>
<div class="line">    else()</div>
<div class="line">      set(tests_relative_path &quot;${ARG_WORKING_DIRECTORY}&quot;)</div>
<div class="line">      get_filename_component(ARG_WORKING_DIRECTORY &quot;${ARG_WORKING_DIRECTORY}&quot;</div>
<div class="line">          REALPATH BASE_DIR &quot;${CMAKE_CURRENT_SOURCE_DIR}&quot;)</div>
<div class="line">    endif()</div>
<div class="line">  else()</div>
<div class="line">    foreach(probable_tests_path IN ITEMS</div>
<div class="line">        &quot;testsuite&quot;</div>
<div class="line">        &quot;tests&quot;</div>
<div class="line">        &quot;.&quot;</div>
<div class="line">    )</div>
<div class="line">      if(EXISTS &quot;${CMAKE_CURRENT_SOURCE_DIR}/${probable_tests_path}/conftest.py&quot;)</div>
<div class="line">        set(ARG_WORKING_DIRECTORY</div>
<div class="line">            &quot;${CMAKE_CURRENT_SOURCE_DIR}/${probable_tests_path}&quot;)</div>
<div class="line">        set(tests_relative_path &quot;${probable_tests_path}&quot;)</div>
<div class="line">        break()</div>
<div class="line">      endif()</div>
<div class="line">    endforeach()</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(NOT ARG_SERVICE_TARGET)</div>
<div class="line">    set(ARG_SERVICE_TARGET &quot;${PROJECT_NAME}&quot;)</div>
<div class="line">  endif()</div>
<div class="line">  if(NOT ARG_TEST_SUFFIX)</div>
<div class="line">    set(ARG_TEST_SUFFIX &quot;${tests_relative_path}&quot;)</div>
<div class="line">  endif()</div>
<div class="line">  if(&quot;${ARG_TEST_SUFFIX}&quot; STREQUAL &quot;.&quot; OR</div>
<div class="line">      &quot;${ARG_TEST_SUFFIX}&quot; STREQUAL &quot;tests&quot; OR</div>
<div class="line">      &quot;${ARG_TEST_SUFFIX}&quot; STREQUAL &quot;testsuite&quot;)</div>
<div class="line">    set(ARG_TEST_SUFFIX &quot;&quot;)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(ARG_CONFIG_PATH)</div>
<div class="line">    get_filename_component(config_path &quot;${ARG_CONFIG_PATH}&quot;</div>
<div class="line">        REALPATH BASE_DIR &quot;${CMAKE_CURRENT_SOURCE_DIR}&quot;)</div>
<div class="line">  else()</div>
<div class="line">    foreach(probable_config_path IN ITEMS</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/configs/static_config.yaml&quot;</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/configs/config.yaml&quot;</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/static_config.yaml&quot;</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/config.yaml&quot;</div>
<div class="line">    )</div>
<div class="line">      if(EXISTS &quot;${probable_config_path}&quot;)</div>
<div class="line">        set(config_path &quot;${probable_config_path}&quot;)</div>
<div class="line">        break()</div>
<div class="line">      endif()</div>
<div class="line">    endforeach()</div>
<div class="line"> </div>
<div class="line">    if(NOT config_path)</div>
<div class="line">      message(FATAL_ERROR</div>
<div class="line">          &quot;Failed to find service static config for testsuite. &quot;</div>
<div class="line">          &quot;Please pass it to ${CMAKE_CURRENT_FUNCTION} as CONFIG_PATH arg.&quot;)</div>
<div class="line">    endif()</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(ARG_CONFIG_VARS_PATH)</div>
<div class="line">    get_filename_component(config_vars_path &quot;${ARG_CONFIG_VARS_PATH}&quot;</div>
<div class="line">        REALPATH BASE_DIR &quot;${CMAKE_CURRENT_SOURCE_DIR}&quot;)</div>
<div class="line">  else()</div>
<div class="line">    foreach(probable_config_vars_path IN ITEMS</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/configs/config_vars.testsuite.yaml&quot;</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/configs/config_vars.testing.yaml&quot;</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/configs/config_vars.yaml&quot;</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/config_vars.testsuite.yaml&quot;</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/config_vars.testing.yaml&quot;</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/config_vars.yaml&quot;</div>
<div class="line">    )</div>
<div class="line">      if(EXISTS &quot;${probable_config_vars_path}&quot;)</div>
<div class="line">        set(config_vars_path &quot;${probable_config_vars_path}&quot;)</div>
<div class="line">        break()</div>
<div class="line">      endif()</div>
<div class="line">    endforeach()</div>
<div class="line">  endif()</div>
<div class="line">  if(config_vars_path)</div>
<div class="line">    list(APPEND pytest_additional_args</div>
<div class="line">        &quot;--service-config-vars=${config_vars_path}&quot;)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(ARG_DYNAMIC_CONFIG_FALLBACK_PATH)</div>
<div class="line">    get_filename_component(dynamic_config_fallback_path</div>
<div class="line">        &quot;${ARG_DYNAMIC_CONFIG_FALLBACK_PATH}&quot;</div>
<div class="line">        REALPATH BASE_DIR &quot;${CMAKE_CURRENT_SOURCE_DIR}&quot;)</div>
<div class="line">  else()</div>
<div class="line">    foreach(probable_dynamic_config_fallback_path IN ITEMS</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/configs/dynamic_config_fallback.json&quot;</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/dynamic_config_fallback.json&quot;</div>
<div class="line">    )</div>
<div class="line">      if(EXISTS &quot;${probable_dynamic_config_fallback_path}&quot;)</div>
<div class="line">        set(dynamic_config_fallback_path</div>
<div class="line">            &quot;${probable_dynamic_config_fallback_path}&quot;)</div>
<div class="line">        break()</div>
<div class="line">      endif()</div>
<div class="line">    endforeach()</div>
<div class="line">  endif()</div>
<div class="line">  if(dynamic_config_fallback_path)</div>
<div class="line">    list(APPEND pytest_additional_args</div>
<div class="line">        &quot;--config-fallback=${dynamic_config_fallback_path}&quot;)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(ARG_SECDIST_PATH)</div>
<div class="line">    get_filename_component(secdist_path &quot;${ARG_CONFIG_VARS_PATH}&quot;</div>
<div class="line">        REALPATH BASE_DIR &quot;${CMAKE_CURRENT_SOURCE_DIR}&quot;)</div>
<div class="line">  else()</div>
<div class="line">    foreach(probable_secdist_path IN ITEMS</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/configs/secdist.json&quot;</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/configs/secure_data.json&quot;</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/secdist.json&quot;</div>
<div class="line">        &quot;${CMAKE_CURRENT_SOURCE_DIR}/secure_data.json&quot;</div>
<div class="line">    )</div>
<div class="line">      if(EXISTS &quot;${probable_secdist_path}&quot;)</div>
<div class="line">        set(secdist_path &quot;${probable_secdist_path}&quot;)</div>
<div class="line">        break()</div>
<div class="line">      endif()</div>
<div class="line">    endforeach()</div>
<div class="line">  endif()</div>
<div class="line">  if(secdist_path)</div>
<div class="line">    list(APPEND pytest_additional_args</div>
<div class="line">        &quot;--service-secdist=${secdist_path}&quot;)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  if(EXISTS &quot;${CMAKE_CURRENT_BINARY_DIR}/proto&quot;)</div>
<div class="line">    list(APPEND ARG_PYTHONPATH &quot;${CMAKE_CURRENT_BINARY_DIR}/proto&quot;)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  userver_testsuite_add(</div>
<div class="line">      SERVICE_TARGET &quot;${ARG_SERVICE_TARGET}&quot;</div>
<div class="line">      TEST_SUFFIX &quot;${ARG_TEST_SUFFIX}&quot;</div>
<div class="line">      WORKING_DIRECTORY &quot;${ARG_WORKING_DIRECTORY}&quot;</div>
<div class="line">      PYTHON_BINARY &quot;${ARG_PYTHON_BINARY}&quot;</div>
<div class="line">      PRETTY_LOGS &quot;${ARG_PRETTY_LOGS}&quot;</div>
<div class="line">      PYTEST_ARGS</div>
<div class="line">      &quot;--service-config=${config_path}&quot;</div>
<div class="line">      &quot;--service-source-dir=${CMAKE_CURRENT_SOURCE_DIR}&quot;</div>
<div class="line">      &quot;--service-binary=${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}&quot;</div>
<div class="line">      ${pytest_additional_args}</div>
<div class="line">      ${ARG_PYTEST_ARGS}</div>
<div class="line">      REQUIREMENTS ${ARG_REQUIREMENTS}</div>
<div class="line">      PYTHONPATH ${ARG_PYTHONPATH}</div>
<div class="line">      TEST_ENV ${ARG_TEST_ENV}</div>
<div class="line">  )</div>
<div class="line">endfunction()</div>
<div class="line"> </div>
<div class="line"># add utest, test runs in testsuite env</div>
<div class="line">function(userver_add_utest)</div>
<div class="line">  set(options)</div>
<div class="line">  set(oneValueArgs NAME)</div>
<div class="line">  set(multiValueArgs DATABASES TEST_ENV)</div>
<div class="line"> </div>
<div class="line">  cmake_parse_arguments(</div>
<div class="line">      ARG &quot;${options}&quot; &quot;${oneValueArgs}&quot; &quot;${multiValueArgs}&quot; ${ARGN})</div>
<div class="line"> </div>
<div class="line">  if (NOT USERVER_FEATURE_TESTSUITE)</div>
<div class="line">    message(FATAL_ERROR &quot;userver_add_utest requires &#39;USERVER_FEATURE_TESTSUITE=ON&#39;&quot;)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  set(additional_args)</div>
<div class="line">  if(ARG_DATABASES)</div>
<div class="line">    list(JOIN ARG_DATABASES &quot;,&quot; databases_value)</div>
<div class="line">    list(APPEND additional_args &quot;--databases=${databases_value}&quot;)</div>
<div class="line">  endif()</div>
<div class="line"> </div>
<div class="line">  add_test(NAME &quot;${ARG_NAME}&quot; COMMAND</div>
<div class="line">    &quot;${CMAKE_BINARY_DIR}/testsuite/env&quot;</div>
<div class="line">    ${additional_args} run --</div>
<div class="line">    $&lt;TARGET_FILE:${ARG_NAME}&gt;</div>
<div class="line">    &quot;--gtest_output=xml:${CMAKE_BINARY_DIR}/test-results/${ARG_NAME}.xml&quot;</div>
<div class="line">  )</div>
<div class="line">  if(ARG_TEST_ENV)</div>
<div class="line">    set_tests_properties(&quot;${ARG_NAME}&quot;</div>
<div class="line">        PROPERTIES ENVIRONMENT &quot;${ARG_TEST_ENV}&quot;</div>
<div class="line">    )</div>
<div class="line">  endif()</div>
<div class="line">endfunction()</div>
<div class="line"> </div>
<div class="line">_userver_prepare_testsuite()</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:42:39 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
