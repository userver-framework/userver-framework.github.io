<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: Component system</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dc/dcc/md_en_2userver_2component__system.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Component system</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md137"></a> A userver-based service usually consists of components. A component is a basic building block that encapsulates dependencies logic with configuration and is able to interact with other components.</p>
<p><b>Example:</b> </p>
<ul>
<li>There is a <code>ClientB</code>, that requires initialization with some <code>SettingsB</code></li>
<li>There is a <code>ClientA</code>, that requires initialization with some <code>SettingsA</code> and a reference to <code>ClientB</code>.</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">struct </span>SettingsB{ <span class="comment">/*...*/</span> };</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ClientB {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  ClientB(SettingsB settings);</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>SettingsA{ <span class="comment">/*...*/</span> };</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ClientA {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  ClientA(ClientB&amp; b, SettingsA settings);</div>
<div class="line">};</div>
</div><!-- fragment --><p>In unit tests you could create the <a class="el" href="../../de/d08/group__userver__clients.html">clients</a> and fill the settings manually in code:</p>
<div class="fragment"><div class="line">ClientB b({.path=<span class="stringliteral">&quot;/opt/&quot;</span>, .timeout=15s});</div>
<div class="line">ClientA a(b, {.ttl=3, .skip={<span class="stringliteral">&quot;some&quot;</span>}});</div>
<div class="line"> </div>
<div class="line">a.DoSomething();</div>
</div><!-- fragment --><p>When it comes to production services with tens of components and hundreds of settings then the configuration from code becomes cumbersome and not flexible enough. Knowledge about all the dependencies of clients is required; many clients may depend on multiple other clients; some clients may be slow to start and those should be initialized concurrently...</p>
<p>Components to the rescue! A component takes care of constructing and configuring its own client. With components the configuration and dependency management problem is decomposed into small and manageable pieces:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>ComponentA: <a class="code hl_class" href="../../d7/db4/classcomponents_1_1ComponentBase.html" title="Base class for all application components, it depends on components::Logger and components::Tracer.">components::ComponentBase</a> {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  ComponentA(<span class="keyword">const</span> <a class="code hl_class" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a>&amp; config,</div>
<div class="line">             <span class="keyword">const</span> <a class="code hl_class" href="../../da/db1/classcomponents_1_1ComponentContext.html" title="Class to retrieve other components.">components::ComponentContext</a>&amp; context)</div>
<div class="line">  : client_a_(</div>
<div class="line">      context.FindComponent&lt;ComponentB&gt;().GetClientB(),</div>
<div class="line">      {.ttl=config[<span class="stringliteral">&quot;ttl&quot;</span>].<a class="code hl_function" href="../../d3/d6c/classyaml__config_1_1YamlConfig.html#a64c0d693118c8a737838bd9acb671069" title="Returns value of *this converted to T.">As</a>&lt;<span class="keywordtype">int</span>&gt;(), .skip=config[<span class="stringliteral">&quot;skip&quot;</span>].As&lt;std::vector&lt;std::string&gt;&gt;()}</div>
<div class="line">    )</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line">  ClientA&amp; GetClientA()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> client_a_; }</div>
<div class="line"> </div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line">  ClientA client_a_;</div>
<div class="line">};</div>
</div><!-- fragment --><p>Only components should know about components. Clients and other types constructed by components should not use <a class="el" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a>, <a class="el" href="../../da/db1/classcomponents_1_1ComponentContext.html" title="Class to retrieve other components.">components::ComponentContext</a>, or components directly. All the components should inherit from <a class="el" href="../../d7/db4/classcomponents_1_1ComponentBase.html" title="Base class for all application components, it depends on components::Logger and components::Tracer.">components::ComponentBase</a> base class and may override its methods.</p>
<p>All the components are listed at the <a class="el" href="../../dd/d1c/group__userver__components.html">Components</a> API Group.</p>
<h1><a class="anchor" id="autotoc_md138"></a>
Startup context</h1>
<p>On component construction a <a class="el" href="../../da/db1/classcomponents_1_1ComponentContext.html" title="Class to retrieve other components.">components::ComponentContext</a> is passed as a second parameter to the constructor of the component. That context could be used to get references to other components. That reference to the component is guaranteed to outlive the component that is being constructed.</p>
<h1><a class="anchor" id="autotoc_md139"></a>
Components construction and destruction order</h1>
<p><a class="el" href="../../d6/d84/namespaceutils.html#a5047c1275f53e699e26869c045ad3697">utils::DaemonMain</a>, <a class="el" href="../../d0/d1f/namespacecomponents.html#a0e164c546f6a3264d1b50176d2f40aec">components::Run</a> or <a class="el" href="../../d0/d1f/namespacecomponents.html#a6d18cf92cdd7ed097c44abe493c0c512">components::RunOnce</a> start all the components from the passed <a class="el" href="../../dc/df0/classcomponents_1_1ComponentList.html" title="A list to keep a unique list of components to start with components::Run(), utils::DaemonMain() or co...">components::ComponentList</a>. Each component is constructed in a separate <a class="el" href="../../d8/d7c/classengine_1_1Task.html" title="Asynchronous task that has a unique ownership of the payload.">engine::Task</a> on the default task processor and is initialized concurrently with other components.</p>
<p>This is a useful feature, for example in cases with multiple caches that slowly read from different databases.</p>
<p>To make component <em>A</em> depend on component <em>B</em> just call <a class="el" href="../../da/db1/classcomponents_1_1ComponentContext.html#a4ba6078e836fc718192a75444f93f9f3" title="Finds a component of type T with specified name (if any) and returns the component after it was initi...">components::ComponentContext::FindComponent&lt;B&gt;()</a> in the constructor of A. FindComponent() suspends the current task and continues only after the construction of component B is finished. Components are destroyed in reverse order of construction, so the component A is destroyed before the component B. In other words - references from FindComponent() outlive the component that called the FindComponent() function. If any component loading fails, FindComponent() wakes up and throws an <a class="el" href="../../d2/d43/classcomponents_1_1ComponentsLoadCancelledException.html" title="Exception that is thrown from components::ComponentContext::FindComponent() if a component load faile...">components::ComponentsLoadCancelledException</a>.</p>
<p><a class="anchor" id="clients_from_components_lifetime"></a></p>
<h1><a class="anchor" id="autotoc_md140"></a>
References from components and lifetime of clients</h1>
<p>It is a common practice to have a component that returns a reference <em>R</em> from some function <em>F</em>. In such cases:</p><ul>
<li>a reference <em>R</em> lives as long as the component is alive</li>
<li>a reference <em>R</em> is usually a client</li>
<li>and it is safe to invoke member functions of reference <em>R</em> concurrently unless otherwise specified.</li>
</ul>
<p>Examples:</p><ul>
<li>components::HttpClient::GetHttpClient()</li>
<li>components::StatisticsStorage::GetStorage()</li>
</ul>
<h1><a class="anchor" id="autotoc_md141"></a>
Components static configuration</h1>
<p><a class="el" href="../../dc/d21/classcomponents_1_1ManagerControllerComponent.html" title="Component that prepares the engine internals and starts all the other components.">components::ManagerControllerComponent</a> configures the engine internals from information provided in its static config: preallocates coroutines, creates the engine::TaskProcessor, creates threads for low-level event processing. After that it starts all the components that were added to the <a class="el" href="../../dc/df0/classcomponents_1_1ComponentList.html" title="A list to keep a unique list of components to start with components::Run(), utils::DaemonMain() or co...">components::ComponentList</a>. Each registered component should have a section in service config (also known as static config).</p>
<p>The component configuration is passed as a first parameter of type <a class="el" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a> to the constructor of the component. Note that <a class="el" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a> extends the functionality of <a class="el" href="../../d3/d6c/classyaml__config_1_1YamlConfig.html" title="Datatype that represents YAML with substituted variables.">yaml_config::YamlConfig</a> with YamlConfig::Mode::kEnvAllowed mode that is able to substitute variables with values, use environment variales and fallbacks. See <a class="el" href="../../d3/d6c/classyaml__config_1_1YamlConfig.html" title="Datatype that represents YAML with substituted variables.">yaml_config::YamlConfig</a> for more info and examples.</p>
<p>All the components have the following options:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Description   </th><th class="markdownTableHeadNone">Default value    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">load-enabled   </td><td class="markdownTableBodyNone">set to <code>false</code> to disable loading of the component   </td><td class="markdownTableBodyNone">true   </td></tr>
</table>
<p><a class="anchor" id="static-configs-validation"></a></p>
<h2><a class="anchor" id="autotoc_md142"></a>
Static configs validation</h2>
<p>To validate static configs you only need to define member function of your component <code>GetStaticConfigSchema()</code></p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>myservice::smth {</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="../../d1/d3e/structyaml__config_1_1Schema.html" title="JSON Schema-like type definition.">yaml_config::Schema</a> Component::GetStaticConfigSchema() {</div>
<div class="line">    <span class="keywordflow">return</span> yaml_config::MergeSchemas&lt;components::ComponentBase&gt;(R<span class="stringliteral">&quot;(</span></div>
<div class="line"><span class="stringliteral">type: object</span></div>
<div class="line"><span class="stringliteral">description: user component smth</span></div>
<div class="line"><span class="stringliteral">additionalProperties: false</span></div>
<div class="line"><span class="stringliteral">properties:</span></div>
<div class="line"><span class="stringliteral">    some-url:</span></div>
<div class="line"><span class="stringliteral">        type: string</span></div>
<div class="line"><span class="stringliteral">        description: url for something</span></div>
<div class="line"><span class="stringliteral">    fs-task-processor:</span></div>
<div class="line"><span class="stringliteral">        type: string</span></div>
<div class="line"><span class="stringliteral">        description: name of the task processor to do some blocking FS syscalls</span></div>
<div class="line"><span class="stringliteral">)&quot;);</span></div>
<div class="line"><span class="stringliteral">}</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">}  </span><span class="comment">// namespace myservice::smth</span></div>
</div><!-- fragment --><p>All schemas and sub-schemas must have <code>description</code> field and can have <code>defaultDescription</code> field if they have a default value.</p>
<p>Scope of static config validatoin can be specified by <code>validate_all_components</code> section of <code>components_manager</code> config. To disable it use:</p>
<div class="fragment"><div class="line">components_manager:</div>
<div class="line">    static_config_validation:</div>
<div class="line">        validate_all_components: false</div>
</div><!-- fragment --><p>You also can force static config validation of your component by adding <code><a class="el" href="../../d0/d1f/namespacecomponents.html#a014b8ca2fd4a0e41eebdfe11cfd29a83">components::kHasValidate</a></code></p>
<div class="fragment"><div class="line">template &lt;&gt;</div>
<div class="line">inline constexpr <span class="keywordtype">bool</span> <a class="code hl_namespace" href="../../d0/d1f/namespacecomponents.html" title="Contains functions and types to start a userver based service/tool.">components</a>::kHasValidate&lt;myservice::smth::Component&gt; = true;</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>There are plans to use it to generate documentation.</dd></dl>
<p>Supported types:</p><ul>
<li>Scalars: <code>boolean</code>, <code>string</code>, <code>integer</code>, <code>double</code></li>
<li><code>object</code> must have options <code>additionalProperties</code> and <code>properties</code></li>
<li><code>array</code> must have option <code>items</code></li>
</ul>
<p><a class="anchor" id="select-config-file-mode"></a></p>
<h2><a class="anchor" id="autotoc_md143"></a>
Setup config file mode</h2>
<p>You can configure the configuration mode of the component in the configuration file by specializing the <code><a class="el" href="../../d0/d1f/namespacecomponents.html#ac371cdc43180d3d67a9409d3fd0c651f">components::kConfigFileMode</a></code> template variable in the file with component declaration Supported mode:</p><ul>
<li><code>kConfigFileMode::kRequired</code> - The component must be defined in configuration file</li>
<li><code>kConfigFileMode::kNotRequired</code> - The component may not be defined in the configuration file</li>
</ul>
<div class="fragment"><div class="line">template &lt;&gt;</div>
<div class="line">inline constexpr auto <a class="code hl_namespace" href="../../d0/d1f/namespacecomponents.html" title="Contains functions and types to start a userver based service/tool.">components</a>::kConfigFileMode&lt;myservice::smth::Component&gt; = ConfigFileMode::kNotRequired;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md144"></a>
Writing your own components</h1>
<p>Users of the framework may (and should) write their own components.</p>
<p>Components provide functionality to tie the main part of the program with the configuration and other components. Component should be lightweight and simple.</p>
<dl class="section note"><dt>Note</dt><dd>Rule of a thumb: if you wish to unit test some code that is located in the component, then in 99% of cases that code should not be located in the component.</dd></dl>
<h2><a class="anchor" id="autotoc_md145"></a>
Should I write a new component or class would be enough?</h2>
<p>You need a component if:</p><ul>
<li>you need a static config</li>
<li>you need to work with other components</li>
<li>you are writing clients (you need a component to be the factory for your clients)</li>
<li>you want to subscribe for configs or cache changes</li>
</ul>
<h2><a class="anchor" id="autotoc_md146"></a>
HowTo</h2>
<p>Start writing your component from adding a header file with a class inherited from <a class="el" href="../../d7/db4/classcomponents_1_1ComponentBase.html" title="Base class for all application components, it depends on components::Logger and components::Tracer.">components::ComponentBase</a>. </p><div class="fragment"><div class="line"><span class="preprocessor">#pragma once</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d2/d2c/core_2include_2userver_2components_2component__base_8hpp.html" title="Contains components::ComponentBase declaration and forward declarations of components::ComponentConfi...">userver/components/component_base.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d2/d2e/source_8hpp.html" title="A client for easy dynamic config fetching in components.">userver/dynamic_config/source.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>myservice::smth {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>Component final : <span class="keyword">public</span> <a class="code hl_class" href="../../d7/db4/classcomponents_1_1ComponentBase.html" title="Base class for all application components, it depends on components::Logger and components::Tracer.">components::ComponentBase</a> {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="comment">// name of your component to refer in static config</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> std::string_view kName = <span class="stringliteral">&quot;smth&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    Component(<span class="keyword">const</span> <a class="code hl_class" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a>&amp; config, <span class="keyword">const</span> <a class="code hl_class" href="../../da/db1/classcomponents_1_1ComponentContext.html" title="Class to retrieve other components.">components::ComponentContext</a>&amp; context);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> DoSomething() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    ~Component() final;</div>
<div class="line"> </div>
<div class="line">    static <a class="code hl_namespace" href="../../dd/d20/namespaceyaml__config.html" title="Utilities to work with static YAML config.">yaml_config</a>::Schema GetStaticConfigSchema();</div>
<div class="line"> </div>
<div class="line">private:</div>
<div class="line">    dynamic_config::Source config_;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace myservice::smth</span></div>
<div class="line"> </div>
</div><!-- fragment --><p>In source file write the implementation of the component: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d8/d2e/core_2include_2userver_2components_2component_8hpp.html" title="Convenience header that provides all the types for component implementation (components::ComponentCon...">userver/components/component.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d2/d88/core_2include_2userver_2dynamic__config_2storage_2component_8hpp.html" title="Component that stores the dynamic config.">userver/dynamic_config/storage/component.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;userver/dynamic_config/value.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../de/d4e/utils_2async_8hpp.html" title="Utility functions to start asynchronous tasks.">userver/utils/async.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../dc/d5f/merge__schemas_8hpp.html" title="Merge parent and child components schemas of static configs.">userver/yaml_config/merge_schemas.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>myservice::smth {</div>
<div class="line"> </div>
<div class="line">Component::Component(<span class="keyword">const</span> <a class="code hl_class" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a>&amp; config, <span class="keyword">const</span> <a class="code hl_class" href="../../da/db1/classcomponents_1_1ComponentContext.html" title="Class to retrieve other components.">components::ComponentContext</a>&amp; context)</div>
<div class="line">    : <a class="code hl_namespace" href="../../d0/d1f/namespacecomponents.html" title="Contains functions and types to start a userver based service/tool.">components</a>::ComponentBase(config, context),</div>
<div class="line">      config_(</div>
<div class="line">          <span class="comment">// Searching for some component to initialize members</span></div>
<div class="line">          context.FindComponent&lt;<a class="code hl_namespace" href="../../d0/d1f/namespacecomponents.html" title="Contains functions and types to start a userver based service/tool.">components</a>::DynamicConfig&gt;().GetSource()  <span class="comment">// getting &quot;client&quot; from a component</span></div>
<div class="line">      ) {</div>
<div class="line">    <span class="comment">// Reading config values from static config</span></div>
<div class="line">    [[maybe_unused]] <span class="keyword">auto</span> url = config[<span class="stringliteral">&quot;some-url&quot;</span>].<a class="code hl_function" href="../../d3/d6c/classyaml__config_1_1YamlConfig.html#a64c0d693118c8a737838bd9acb671069" title="Returns value of *this converted to T.">As</a>&lt;std::string&gt;();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> fs_tp_name = config[<span class="stringliteral">&quot;fs-task-processor&quot;</span>].<a class="code hl_function" href="../../d3/d6c/classyaml__config_1_1YamlConfig.html#a64c0d693118c8a737838bd9acb671069" title="Returns value of *this converted to T.">As</a>&lt;std::string&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Starting a task on a separate task processor from config</span></div>
<div class="line">    <span class="keyword">auto</span>&amp; fs_task_processor = context.<a class="code hl_function" href="../../da/db1/classcomponents_1_1ComponentContext.html#a0f8bdf097d092609d4efb31aeb9fbdc7" title="Returns an engine::TaskProcessor with the specified name.">GetTaskProcessor</a>(fs_tp_name);</div>
<div class="line">    <a class="code hl_function" href="../../dc/db7/group__userver__concurrency.html#ga29b9a09eacda1ddf8b4440b3713f5e52" title="Starts an asynchronous task.">utils::Async</a>(fs_task_processor, <span class="stringliteral">&quot;my-component/fs-work&quot;</span>, [] { <span class="comment">/*...*/</span> }).Get();</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace myservice::smth</span></div>
</div><!-- fragment --><p> Destructor of the component is invoked on service shutdown. Components are destroyed in the reverse order of construction. In other words, references from <code>context.FindComponent&lt;<a class="el" href="../../dd/d1a/classcomponents_1_1DynamicConfig.html" title="Component that stores the dynamic config.">components::DynamicConfig</a>&gt;()</code> outlive the component.</p>
<p>If you need dynamic configs, you can get them using this approach: </p><div class="fragment"><div class="line"><span class="keyword">namespace </span>myservice::smth {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">inline</span> <span class="keyword">const</span> <a class="code hl_class" href="../../d3/dc3/classdynamic__config_1_1Key.html" title="A config key is a unique identifier for a config variable.">dynamic_config::Key</a> kMyConfig{<span class="stringliteral">&quot;SAMPLE_INTEGER_FROM_RUNTIME_CONFIG&quot;</span>, 42};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> Component::DoSomething()<span class="keyword"> const </span>{</div>
<div class="line">    <span class="comment">// Getting a snapshot of dynamic config.</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> runtime_config = config_.GetSnapshot();</div>
<div class="line">    <span class="keywordflow">return</span> runtime_config[kMyConfig];</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace myservice::smth</span></div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>See <a class="el" href="../../d4/d95/md_en_2userver_2tutorial_2config__service.html">Writing your own configs server</a> for info on how to implement your own config server.</dd></dl>
<p>Do not forget to register your component in <a class="el" href="../../dc/df0/classcomponents_1_1ComponentList.html" title="A list to keep a unique list of components to start with components::Run(), utils::DaemonMain() or co...">components::ComponentList</a> before invoking the <a class="el" href="../../d6/d84/namespaceutils.html#a5047c1275f53e699e26869c045ad3697">utils::DaemonMain</a>, <a class="el" href="../../d0/d1f/namespacecomponents.html#a0e164c546f6a3264d1b50176d2f40aec">components::Run</a> or <a class="el" href="../../d0/d1f/namespacecomponents.html#a6d18cf92cdd7ed097c44abe493c0c512">components::RunOnce</a>.</p>
<p>Done! You've implemented your first component. Full sources:</p><ul>
<li><a class="el" href="../../dd/d4b/components_2component_sample_test_8hpp-example.html">components/component_sample_test.hpp</a></li>
<li><a class="el" href="../../d3/d25/components_2component_sample_test_8cpp-example.html">components/component_sample_test.cpp</a></li>
</ul>
<dl class="section note"><dt>Note</dt><dd>For info on writing HTTP handler components refer to the <a class="el" href="../../da/d16/md_en_2userver_2tutorial_2hello__service.html">Writing your first HTTP server</a>.</dd></dl>
<h2><a class="anchor" id="autotoc_md147"></a>
Testing</h2>
<p>Starting up the components in unit tests is quite hard. Prefer moving out all the functionality from the component or testing the component with the help of <a class="el" href="../../df/d07/md_en_2userver_2functional__testing.html">testsuite functional tests</a>.</p>
<hr  />
<p> <div class="bottom-nav">  ⇦ <a class="el" href="../../da/d24/md_en_2userver_2tutorial_2auth__postgres.html">Custom Authorization/Authentication via PostgreSQL</a> | <a class="el" href="../../de/d08/group__userver__clients.html">Clients</a> ⇨  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:55:58 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
