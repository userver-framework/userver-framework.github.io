<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: Pre-caching data from HTTP remote</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dc/d8a/md_en_2userver_2tutorial_2http__caching.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Pre-caching data from HTTP remote</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md705"></a> </p>
<h1><a class="anchor" id="autotoc_md706"></a>
Before you start</h1>
<p>Make sure that you can compile and run core tests and read a basic example <a class="el" href="../../da/d16/md_en_2userver_2tutorial_2hello__service.html">Writing your first HTTP server</a>.</p>
<h1><a class="anchor" id="autotoc_md707"></a>
Step by step guide</h1>
<p>Consider the case when you need to write an HTTP handler that greets a user. However, the localized strings are stored at some remote HTTP server, and those localizations rarely change. To reduce the network traffic and improve response times it is profitable to bulk retrieve the translations from remote and cache them in a local cache.</p>
<p>In this sample we show how to write and test a cache along with creating HTTP requests. If you wish to cache data from database prefer using <a class="el" href="../../d5/d2d/md_en_2userver_2caches.html">cache specializations for DB</a>.</p>
<h2><a class="anchor" id="autotoc_md708"></a>
Remote HTTP server description</h2>
<p>For the purpose of this there is some HTTP server that has HTTP handler <code><a href="http://localhost:8090/v1/translations">http://localhost:8090/v1/translations</a></code>.</p>
<p>Handler returns all the available translations as JSON on GET: </p><div class="fragment"><div class="line">bash</div>
<div class="line">curl http://localhost:8090/v1/translations -s | jq</div>
<div class="line">{</div>
<div class="line">  &quot;content&quot;: {</div>
<div class="line">    &quot;hello&quot;: {</div>
<div class="line">      &quot;ru&quot;: &quot;Привет&quot;,</div>
<div class="line">      &quot;en&quot;: &quot;Hello&quot;</div>
<div class="line">    },</div>
<div class="line">    &quot;wellcome&quot;: {</div>
<div class="line">      &quot;ru&quot;: &quot;Добро пожаловать&quot;,</div>
<div class="line">      &quot;en&quot;: &quot;Wellcome&quot;</div>
<div class="line">    }</div>
<div class="line">  },</div>
<div class="line">  &quot;update_time&quot;: &quot;2021-11-01T12:00:00Z&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><p>In case of query parameter "last_update" the handler returns only the changed translations since requested time: </p><div class="fragment"><div class="line">bash</div>
<div class="line">$ curl http://localhost:8090/v1/translations?last_update=2021-11-01T12:00:00Z -s | jq</div>
<div class="line">{</div>
<div class="line">  &quot;content&quot;: {</div>
<div class="line">    &quot;hello&quot;: {</div>
<div class="line">      &quot;ru&quot;: &quot;Приветище&quot;</div>
<div class="line">    }</div>
<div class="line">  },</div>
<div class="line">  &quot;update_time&quot;: &quot;2021-12-01T12:00:00Z&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><p>We are planning to cache those translations in a std::unordered_map:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>samples::http_cache {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>KeyLang {</div>
<div class="line">    std::string key;</div>
<div class="line">    std::string language;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>KeyLangEq {</div>
<div class="line">    <span class="keywordtype">bool</span> operator()(<span class="keyword">const</span> KeyLang&amp; x, <span class="keyword">const</span> KeyLang&amp; y) <span class="keyword">const</span> <span class="keyword">noexcept</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>KeyLangHash {</div>
<div class="line">    <span class="keywordtype">bool</span> operator()(<span class="keyword">const</span> KeyLang&amp; x) <span class="keyword">const</span> <span class="keyword">noexcept</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">using </span>KeyLangToTranslation = std::unordered_map&lt;KeyLang, std::string, KeyLangHash, KeyLangEq&gt;;</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace samples::http_cache</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md709"></a>
Cache component</h2>
<p>Our cache <a class="el" href="../../dc/dcc/md_en_2userver_2component__system.html">component</a> should have the following fields:</p><ul>
<li>Reference to HTTP client, that is required to make HTTP requests</li>
<li>URL to the incremental and full update handle</li>
<li>String with last update time from remote. This string used only from the <a class="el" href="../../da/df8/classcache_1_1CacheUpdateTrait.html#a317ae9796c9108002c4efd1227882cf5" title="Should be overridden in a derived class to align the stored data with some data source.">components::CachingComponentBase::Update</a> overload and it is guaranteed <a class="el" href="../../d5/d2d/md_en_2userver_2caches.html">that Update is not called concurrently</a>, so there is no need to protect it from concurrent access.</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>samples::http_cache {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>HttpCachedTranslations final : <span class="keyword">public</span> <a class="code hl_class" href="../../df/dd1/classcomponents_1_1CachingComponentBase.html" title="Base class for caching components.">components::CachingComponentBase</a>&lt;KeyLangToTranslation&gt; {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> std::string_view kName = <span class="stringliteral">&quot;cache-http-translations&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    HttpCachedTranslations(<span class="keyword">const</span> <a class="code hl_class" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a>&amp; config, <span class="keyword">const</span> <a class="code hl_class" href="../../da/db1/classcomponents_1_1ComponentContext.html" title="Class to retrieve other components.">components::ComponentContext</a>&amp; context);</div>
<div class="line">    ~HttpCachedTranslations() <span class="keyword">override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> Update(</div>
<div class="line">        <a class="code hl_enumeration" href="../../db/d8d/namespacecache.html#a99d3f117ecf9ccf2816a2bb19c1ffce1" title="Type of CachingComponentBase update.">cache::UpdateType</a> type,</div>
<div class="line">        [[maybe_unused]] <span class="keyword">const</span> std::chrono::system_clock::time_point&amp; last_update,</div>
<div class="line">        [[maybe_unused]] <span class="keyword">const</span> std::chrono::system_clock::time_point&amp; now,</div>
<div class="line">        <a class="code hl_class" href="../../d8/db9/classcache_1_1UpdateStatisticsScope.html" title="Allows a specific cache to fill cache statistics during an Update.">cache::UpdateStatisticsScope</a>&amp; stats_scope</div>
<div class="line">    ) <span class="keyword">override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> <a class="code hl_struct" href="../../d1/d3e/structyaml__config_1_1Schema.html" title="JSON Schema-like type definition.">yaml_config::Schema</a> GetStaticConfigSchema();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <a class="code hl_class" href="../../d5/dee/classclients_1_1http_1_1Client.html" title="HTTP client that returns a HTTP request builder from CreateRequest().">clients::http::Client</a>&amp; http_client_;</div>
<div class="line">    <span class="keyword">const</span> std::string translations_url_;</div>
<div class="line">    std::string last_update_remote_;</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_class" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value</a> GetAllData() <span class="keyword">const</span>;</div>
<div class="line">    <a class="code hl_class" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value</a> GetUpdatedData() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> MergeAndSetData(</div>
<div class="line">        KeyLangToTranslation&amp;&amp; content,</div>
<div class="line">        <a class="code hl_class" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value</a> json,</div>
<div class="line">        <a class="code hl_class" href="../../d8/db9/classcache_1_1UpdateStatisticsScope.html" title="Allows a specific cache to fill cache statistics during an Update.">cache::UpdateStatisticsScope</a>&amp; stats_scope</div>
<div class="line">    );</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace samples::http_cache</span></div>
</div><!-- fragment --><p>To create a non <a class="el" href="../../d0/dd8/md_en_2userver_2lru__cache.html">LRU cache</a> cache you have to derive from <a class="el" href="../../df/dd1/classcomponents_1_1CachingComponentBase.html" title="Base class for caching components.">components::CachingComponentBase</a>, call CacheUpdateTrait::StartPeriodicUpdates() at the component constructor and CacheUpdateTrait::StopPeriodicUpdates() at the destructor:</p>
<div class="fragment"><div class="line">HttpCachedTranslations::HttpCachedTranslations(</div>
<div class="line">    <span class="keyword">const</span> <a class="code hl_class" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a>&amp; config,</div>
<div class="line">    <span class="keyword">const</span> <a class="code hl_class" href="../../da/db1/classcomponents_1_1ComponentContext.html" title="Class to retrieve other components.">components::ComponentContext</a>&amp; context</div>
<div class="line">)</div>
<div class="line">    : CachingComponentBase(config, context),</div>
<div class="line">      http_client_(context.FindComponent&lt;<a class="code hl_namespace" href="../../d0/d1f/namespacecomponents.html" title="Contains functions and types to start a userver based service/tool.">components</a>::HttpClient&gt;().GetHttpClient()),</div>
<div class="line">      translations_url_(config[<span class="stringliteral">&quot;translations-url&quot;</span>].As&lt;<a class="code hl_namespace" href="../../d8/dcc/namespacestd.html" title="STL namespace.">std</a>::string&gt;()) {</div>
<div class="line">    CacheUpdateTrait::StartPeriodicUpdates();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">HttpCachedTranslations::~HttpCachedTranslations() { CacheUpdateTrait::StopPeriodicUpdates(); }</div>
</div><!-- fragment --><p>The constructor initializes component fields with data from static configuration and with references to clients.</p>
<h2><a class="anchor" id="autotoc_md710"></a>
Update</h2>
<p>Depending on cache configuration settings the overloaded Update function is periodically called with different options:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> HttpCachedTranslations::Update(</div>
<div class="line">    <a class="code hl_enumeration" href="../../db/d8d/namespacecache.html#a99d3f117ecf9ccf2816a2bb19c1ffce1" title="Type of CachingComponentBase update.">cache::UpdateType</a> type,</div>
<div class="line">    [[maybe_unused]] <span class="keyword">const</span> std::chrono::system_clock::time_point&amp; last_update,</div>
<div class="line">    [[maybe_unused]] <span class="keyword">const</span> std::chrono::system_clock::time_point&amp; now,</div>
<div class="line">    <a class="code hl_class" href="../../d8/db9/classcache_1_1UpdateStatisticsScope.html" title="Allows a specific cache to fill cache statistics during an Update.">cache::UpdateStatisticsScope</a>&amp; stats_scope</div>
<div class="line">) {</div>
<div class="line">    <a class="code hl_class" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value</a> json;</div>
<div class="line">    <span class="keywordflow">switch</span> (type) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="../../db/d8d/namespacecache.html#a99d3f117ecf9ccf2816a2bb19c1ffce1aa60924e124da4d51bd4dc74c8f85b158" title="requests all the items, starting from scratch">cache::UpdateType::kFull</a>:</div>
<div class="line">            json = GetAllData();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="../../db/d8d/namespacecache.html#a99d3f117ecf9ccf2816a2bb19c1ffce1a4461e3132c6a68cc061f851d6b53fc15" title="requests only newly updated items">cache::UpdateType::kIncremental</a>:</div>
<div class="line">            json = GetUpdatedData();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <a class="code hl_define" href="../../d2/d54/assert_8hpp.html#abf42436fd89fea4f612dd97bedbf83ac" title="Assertion macro that aborts execution in DEBUG builds and does nothing in release builds.">UASSERT</a>(<span class="keyword">false</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (json.IsEmpty()) {</div>
<div class="line">        stats_scope.<a class="code hl_function" href="../../d8/db9/classcache_1_1UpdateStatisticsScope.html#a695e6de302860dd4116bda054ac545c8" title="Mark that the Update has finished without changes.">FinishNoChanges</a>();</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    KeyLangToTranslation content;</div>
<div class="line">    <span class="keywordflow">if</span> (type == <a class="code hl_enumvalue" href="../../db/d8d/namespacecache.html#a99d3f117ecf9ccf2816a2bb19c1ffce1a4461e3132c6a68cc061f851d6b53fc15" title="requests only newly updated items">cache::UpdateType::kIncremental</a>) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> snapshot = Get();  <span class="comment">// smart pointer to a shared cache data</span></div>
<div class="line">        content = *snapshot;          <span class="comment">// copying the shared data</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    MergeAndSetData(std::move(content), json, stats_scope);</div>
<div class="line">}</div>
</div><!-- fragment --><p>In this sample full and incremental data retrieval is implemented in GetAllData() and GetUpdatedData() respectively.</p>
<p>Both functions return data in the same format and we parse both responses using <code>MergeAndSetData</code>:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> HttpCachedTranslations::MergeAndSetData(</div>
<div class="line">    KeyLangToTranslation&amp;&amp; content,</div>
<div class="line">    <a class="code hl_class" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value</a> json,</div>
<div class="line">    <a class="code hl_class" href="../../d8/db9/classcache_1_1UpdateStatisticsScope.html" title="Allows a specific cache to fill cache statistics during an Update.">cache::UpdateStatisticsScope</a>&amp; stats_scope</div>
<div class="line">) {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [key, value] : Items(json[<span class="stringliteral">&quot;content&quot;</span>])) {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [lang, text] : Items(value)) {</div>
<div class="line">            content.insert_or_assign(KeyLang{key, lang}, text.As&lt;std::string&gt;());</div>
<div class="line">        }</div>
<div class="line">        stats_scope.<a class="code hl_function" href="../../d8/db9/classcache_1_1UpdateStatisticsScope.html#a827e23b43f5d0bae74a07e00e7ae84f5" title="Each item received from the data source should be accounted with this function.">IncreaseDocumentsReadCount</a>(value.GetSize());</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> update_time = json[<span class="stringliteral">&quot;update_time&quot;</span>].As&lt;std::string&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> size = content.size();</div>
<div class="line">    Set(std::move(content));</div>
<div class="line">    last_update_remote_ = std::move(update_time);</div>
<div class="line">    stats_scope.<a class="code hl_function" href="../../d8/db9/classcache_1_1UpdateStatisticsScope.html#a8f6594cdc520e9f31457551e53e31906" title="Mark that the Update has finished with changes.">Finish</a>(size);</div>
<div class="line">}</div>
</div><!-- fragment --><p>At the end of the MergeAndSetData function the <a class="el" href="../../df/dd1/classcomponents_1_1CachingComponentBase.html#a0d2ad77cfdc6f33bbf8f1f7ae6de3b24">components::CachingComponentBase::Set()</a> invocation stores data as a new cache.</p>
<p>Update time from remote stored into <code>last_update_remote_</code>. Clocks on different hosts are usually out of sync, so it is better to store the remote time if possible, rather than using a local times from <code>last_update</code> and <code>now</code> input parameters.</p>
<h2><a class="anchor" id="autotoc_md711"></a>
Data retrieval</h2>
<p>To make an HTTP request call <a class="el" href="../../d5/dee/classclients_1_1http_1_1Client.html#a98c35b7b1ecd6470c0348d45cab885d3" title="Returns a HTTP request builder type with preset values of User-Agent, Proxy and some of the Testsuite...">clients::http::Client::CreateRequest()</a> to get an instance of <a class="el" href="../../de/df5/classclients_1_1http_1_1Request.html" title="Class for creating and performing new http requests.">clients::http::Request</a> builder. Work with builder is quite straightforward:</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value</a> HttpCachedTranslations::GetAllData()<span class="keyword"> const </span>{</div>
<div class="line">    <span class="keyword">auto</span> response = http_client_.CreateRequest()</div>
<div class="line">                        .get(translations_url_)  <span class="comment">// HTTP GET translations_url_ URL</span></div>
<div class="line">                        .retry(2)                <span class="comment">// retry once in case of error</span></div>
<div class="line">                        .timeout(std::chrono::milliseconds{500})</div>
<div class="line">                        .perform();  <span class="comment">// start performing the request</span></div>
<div class="line">    response-&gt;raise_for_status();</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_function" href="../../de/da1/namespaceformats_1_1json.html#aebd74445be0a82a8db7976c19324f098" title="Parse JSON from string.">formats::json::FromString</a>(response-&gt;body_view());</div>
<div class="line">}</div>
</div><!-- fragment --><p>HTTP requests for incremental update differ only in URL and query parameter <code>last_update</code>:</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value</a> HttpCachedTranslations::GetUpdatedData()<span class="keyword"> const </span>{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> url = <a class="code hl_function" href="../../d3/d69/namespacehttp.html#a8dbec47df1105b1e4628448bd4f8a382" title="Make an URL with query arguments.">http::MakeUrl</a>(translations_url_, {{<span class="stringliteral">&quot;last_update&quot;</span>, last_update_remote_}});</div>
<div class="line">    <span class="keyword">auto</span> response = http_client_.CreateRequest().get(url).retry(2).timeout(std::chrono::milliseconds{500}).perform();</div>
<div class="line">    response-&gt;raise_for_status();</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_function" href="../../de/da1/namespaceformats_1_1json.html#aebd74445be0a82a8db7976c19324f098" title="Parse JSON from string.">formats::json::FromString</a>(response-&gt;body_view());</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md712"></a>
Static configuration</h2>
<p>To configure the new cache component provide its own options, options from <a class="el" href="../../df/dd1/classcomponents_1_1CachingComponentBase.html" title="Base class for caching components.">components::CachingComponentBase</a>:</p>
<div class="fragment"><div class="line"># yaml</div>
<div class="line">components_manager:</div>
<div class="line">    components:                       # Configuring components that were registered via component_list</div>
<div class="line">        cache-http-translations:</div>
<div class="line">            translations-url: &#39;mockserver/v1/translations&#39;  # Some other microservice listens on this URL</div>
<div class="line"> </div>
<div class="line">            update-types: full-and-incremental</div>
<div class="line">            full-update-interval: 1h</div>
<div class="line">            update-interval: 15m</div>
</div><!-- fragment --><p>Options for dependent components <a class="el" href="../../dd/d5a/classcomponents_1_1HttpClient.html" title="Component that manages clients::http::Client.">components::HttpClient</a>, <a class="el" href="../../d9/de2/classcomponents_1_1TestsuiteSupport.html" title="Testsuite support component.">components::TestsuiteSupport</a> and support handler <a class="el" href="../../d5/ded/classserver_1_1handlers_1_1TestsControl.html" title="Handler that allows to control the behavior of server from tests, and functional tests with testsuite...">server::handlers::TestsControl</a> should be provided:</p>
<div class="fragment"><div class="line">        http-client:</div>
<div class="line">            fs-task-processor: fs-task-processor</div>
<div class="line"> </div>
<div class="line">        dns-client:                     # Asynchronous DNS component</div>
<div class="line">            fs-task-processor: fs-task-processor</div>
<div class="line"> </div>
<div class="line">        testsuite-support:</div>
<div class="line">        tests-control:</div>
<div class="line">            # Some options from server::handlers::HttpHandlerBase</div>
<div class="line">            path: /tests/{action}</div>
<div class="line">            method: POST</div>
<div class="line">            task_processor: main-task-processor</div>
<div class="line"> </div>
<div class="line">        server:</div>
<div class="line">            # ...</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md713"></a>
Cache component usage</h2>
<p>Now the cache could be used just as any other component. For example, a handler could get a reference to the cache and use it in <code>HandleRequestThrow</code>:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>GreetUser final : <span class="keyword">public</span> <a class="code hl_class" href="../../d6/d36/classserver_1_1handlers_1_1HttpHandlerBase.html" title="Base class for all the Userver HTTP Handlers.">server::handlers::HttpHandlerBase</a> {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> std::string_view kName = <span class="stringliteral">&quot;handler-greet-user&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    GreetUser(<span class="keyword">const</span> <a class="code hl_class" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a>&amp; config, <span class="keyword">const</span> <a class="code hl_class" href="../../da/db1/classcomponents_1_1ComponentContext.html" title="Class to retrieve other components.">components::ComponentContext</a>&amp; context)</div>
<div class="line">        : HttpHandlerBase(config, context), cache_(context.FindComponent&lt;HttpCachedTranslations&gt;()) {}</div>
<div class="line"> </div>
<div class="line">    std::string <a class="code hl_function" href="../../d6/d36/classserver_1_1handlers_1_1HttpHandlerBase.html#ad006a8d0c90e48b5b662d3b483eb3dd9">HandleRequestThrow</a>(<span class="keyword">const</span> <a class="code hl_class" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request, <a class="code hl_class" href="../../de/df6/classserver_1_1request_1_1RequestContext.html" title="Stores request-specific data during request processing.">server::request::RequestContext</a>&amp;)<span class="keyword"></span></div>
<div class="line"><span class="keyword">        const override </span>{</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> cache_snapshot = cache_.Get();</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">using </span>samples::http_cache::KeyLang;</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span>&amp; hello = cache_snapshot-&gt;at(KeyLang{<span class="stringliteral">&quot;hello&quot;</span>, <span class="stringliteral">&quot;ru&quot;</span>});</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span>&amp; welcome = cache_snapshot-&gt;at(KeyLang{<span class="stringliteral">&quot;welcome&quot;</span>, <span class="stringliteral">&quot;ru&quot;</span>});</div>
<div class="line">        request.<a class="code hl_function" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#a2434ed4270f909f1b74224fbc4196aed" title="Returns a container that should be filled with response data to this request.">GetHttpResponse</a>().<a class="code hl_function" href="../../da/da4/classserver_1_1http_1_1HttpResponse.html#a65a1797ad369c166546a22ffaaab0d53" title="Add or rewrite the Content-Type header.">SetContentType</a>(http::content_type::kTextPlain);</div>
<div class="line">        <span class="keywordflow">return</span> fmt::format(<span class="stringliteral">&quot;{}, {}! {}&quot;</span>, hello, request.<a class="code hl_function" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#aea82de2fbb3e8ed97ba400b38cc706bb">GetArg</a>(<span class="stringliteral">&quot;username&quot;</span>), welcome);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    samples::http_cache::HttpCachedTranslations&amp; cache_;</div>
<div class="line">};</div>
</div><!-- fragment --><p>Note that the cache is concurrency safe <a class="el" href="../../dc/dcc/md_en_2userver_2component__system.html">as all the components</a>.</p>
<h2><a class="anchor" id="autotoc_md714"></a>
int main()</h2>
<p>Finally, we add our component to the <code><a class="el" href="../../dd/d1c/group__userver__components.html#ga44510c5120b67bd36f0ff9f845c68280" title="Returns a list of components to start a basic HTTP server.">components::MinimalServerComponentList()</a></code>, and start the server with static configuration <code>kStaticConfig</code>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> component_list = <a class="code hl_function" href="../../dd/d1c/group__userver__components.html#ga44510c5120b67bd36f0ff9f845c68280" title="Returns a list of components to start a basic HTTP server.">components::MinimalServerComponentList</a>()</div>
<div class="line">                                    .<a class="code hl_function" href="../../dc/df0/classcomponents_1_1ComponentList.html#aac1091016f393791732a7da6aaf27f48" title="Appends a component with default component name Component::kName.">Append</a>&lt;samples::http_cache::HttpCachedTranslations&gt;()</div>
<div class="line">                                    .Append&lt;samples::http_cache::GreetUser&gt;()</div>
<div class="line">                                    .<a class="code hl_function" href="../../dc/df0/classcomponents_1_1ComponentList.html#aac1091016f393791732a7da6aaf27f48" title="Appends a component with default component name Component::kName.">Append</a>&lt;<a class="code hl_class" href="../../d9/de2/classcomponents_1_1TestsuiteSupport.html" title="Testsuite support component.">components::TestsuiteSupport</a>&gt;()</div>
<div class="line">                                    .Append&lt;server::handlers::TestsControl&gt;()</div>
<div class="line">                                    .Append&lt;<a class="code hl_class" href="../../d0/d1e/classclients_1_1dns_1_1Component.html" title="Caching DNS resolver component.">clients::dns::Component</a>&gt;()</div>
<div class="line">                                    .Append&lt;components::HttpClient&gt;();</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_function" href="../../d6/d84/namespaceutils.html#a5047c1275f53e699e26869c045ad3697">utils::DaemonMain</a>(argc, argv, component_list);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md715"></a>
Build and Run</h2>
<p>To build the sample, execute the following build steps at the userver root directory: </p><div class="fragment"><div class="line">mkdir build_release</div>
<div class="line">cd build_release</div>
<div class="line">cmake -DCMAKE_BUILD_TYPE=Release ..</div>
<div class="line">make userver-samples-http_caching</div>
</div><!-- fragment --><p>Note that you need a running translations service with bulk handlers to start the service. You could use the <a class="el" href="../../d5/d81/md_en_2userver_2tutorial_2mongo__service.html">mongo service</a> for that purpose.</p>
<p>The sample could be started by running <code>make start-userver-samples-http_caching</code>. The command would invoke <a class="el" href="../../df/d07/md_en_2userver_2functional__testing.html">testsuite start target</a> that sets proper paths in the configuration files and starts the service.</p>
<p>To start the service manually run <code>./samples/http_caching/userver-samples-http_caching -c &lt;/path/to/static_config.yaml&gt;</code> (do not forget to prepare the configuration files!).</p>
<p>Now you can send a request to your server from another terminal: </p><div class="fragment"><div class="line">bash</div>
<div class="line">$ curl -X POST http://localhost:8089/samples/greet?username=Dear+Developer  -i</div>
<div class="line">HTTP/1.1 200 OK</div>
<div class="line">Date: Thu, 09 Dec 2021 17:01:44 UTC</div>
<div class="line">Content-Type: text/html; charset=utf-8</div>
<div class="line">X-YaRequestId: 94193f99ebf94eb58252139f2e9dace4</div>
<div class="line">X-YaSpanId: 4e17e02dfa7b8322</div>
<div class="line">X-YaTraceId: 306d2d54fd0543c09376a5c4bb120a88</div>
<div class="line">Server: userver/2.0 (20211209085954; rv:d05d059a3)</div>
<div class="line">Connection: keep-alive</div>
<div class="line">Content-Length: 61</div>
<div class="line"> </div>
<div class="line">Привет, Dear Developer! Добро пожаловать</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md716"></a>
Auto testing</h2>
<p>The <a class="el" href="../../d5/ded/classserver_1_1handlers_1_1TestsControl.html" title="Handler that allows to control the behavior of server from tests, and functional tests with testsuite...">server::handlers::TestsControl</a> and <a class="el" href="../../d9/de2/classcomponents_1_1TestsuiteSupport.html" title="Testsuite support component.">components::TestsuiteSupport</a> components among other things provide necessary control over the caches. You can stop/start periodic updates or even force updates of caches by HTTP requests to the <a class="el" href="../../d5/ded/classserver_1_1handlers_1_1TestsControl.html" title="Handler that allows to control the behavior of server from tests, and functional tests with testsuite...">server::handlers::TestsControl</a> handler.</p>
<p>For example the following JSON forces incremental update of the <code>cache-http-translations</code> cache: </p><div class="fragment"><div class="line">{<span class="stringliteral">&quot;invalidate_caches&quot;</span>: {</div>
<div class="line">    <span class="stringliteral">&quot;update_type&quot;</span>: <span class="stringliteral">&quot;incremental&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;names&quot;</span>: [<span class="stringliteral">&quot;cache-http-translations&quot;</span>]</div>
<div class="line">}}</div>
</div><!-- fragment --><p>Fortunately, the <a class="el" href="../../df/d07/md_en_2userver_2functional__testing.html">testsuite API</a> provides all the required functionality via simpler to use Python functions.</p>
<h2><a class="anchor" id="autotoc_md717"></a>
Functional testing</h2>
<p><a class="el" href="../../df/d07/md_en_2userver_2functional__testing.html">Functional tests</a> for the service could be implemented using the testsuite. To do that you have to:</p>
<ul>
<li>Mock the translations service data: <div class="fragment"><div class="line"><span class="preprocessor">@pytest.fixture(name=&#39;translations&#39;)</span></div>
<div class="line"><span class="keyword">def </span>_translations():</div>
<div class="line">    <span class="keywordflow">return</span> {</div>
<div class="line">        <span class="stringliteral">&#39;hello&#39;</span>: {<span class="stringliteral">&#39;en&#39;</span>: <span class="stringliteral">&#39;hello&#39;</span>, <span class="stringliteral">&#39;ru&#39;</span>: <span class="stringliteral">&#39;Привет&#39;</span>},</div>
<div class="line">        <span class="stringliteral">&#39;welcome&#39;</span>: {<span class="stringliteral">&#39;ru&#39;</span>: <span class="stringliteral">&#39;Добро пожаловать&#39;</span>, <span class="stringliteral">&#39;en&#39;</span>: <span class="stringliteral">&#39;Welcome&#39;</span>},</div>
<div class="line">    }</div>
</div><!-- fragment --></li>
<li>Mock the translations service API: <div class="fragment"><div class="line"><span class="preprocessor">@pytest.fixture(autouse=True)</span></div>
<div class="line"><span class="keyword">def </span>mock_translations(mockserver, translations, mocked_time):</div>
<div class="line">    <span class="preprocessor">@mockserver.json_handler(&#39;/v1/translations&#39;)</span></div>
<div class="line">    <span class="keyword">def </span>mock(request):</div>
<div class="line">        <span class="keywordflow">return</span> {</div>
<div class="line">            <span class="stringliteral">&#39;content&#39;</span>: translations,</div>
<div class="line">            <span class="stringliteral">&#39;update_time&#39;</span>: utils.timestring(mocked_time.now()),</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> mock</div>
</div><!-- fragment --></li>
<li>Import the <a class="el" href="../../d6/d25/namespacepytest__userver_1_1plugins_1_1core.html" title="Python plugin that provides core fixtures for functional tests with testsuite; see Functional service...">pytest_userver.plugins.core</a> plugin and teach testsuite how to patch the service config to use the mocked URL: <div class="fragment"><div class="line">pytest_plugins = [<span class="stringliteral">&#39;pytest_userver.plugins.core&#39;</span>]</div>
<div class="line"> </div>
<div class="line">USERVER_CONFIG_HOOKS = [<span class="stringliteral">&#39;userver_config_translations&#39;</span>]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">@pytest.fixture(scope=&#39;session&#39;)</span></div>
<div class="line"><span class="keyword">def </span>userver_config_translations(mockserver_info):</div>
<div class="line">    <span class="keyword">def </span>do_patch(config_yaml, config_vars):</div>
<div class="line">        components = config_yaml[<span class="stringliteral">&#39;components_manager&#39;</span>][<span class="stringliteral">&#39;components&#39;</span>]</div>
<div class="line">        components[<span class="stringliteral">&#39;cache-http-translations&#39;</span>][<span class="stringliteral">&#39;translations-url&#39;</span>] = (</div>
<div class="line">            mockserver_info.url(<span class="stringliteral">&#39;v1/translations&#39;</span>)</div>
<div class="line">        )</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> do_patch</div>
</div><!-- fragment --></li>
<li>Write the test: <div class="fragment"><div class="line"><span class="keyword">async def </span>test_http_caching(service_client, translations, mocked_time):</div>
<div class="line">    response = await service_client.post(</div>
<div class="line">        <span class="stringliteral">&#39;/samples/greet&#39;</span>, params={<span class="stringliteral">&#39;username&#39;</span>: <span class="stringliteral">&#39;дорогой разработчик&#39;</span>},</div>
<div class="line">    )</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line">    <span class="keyword">assert</span> <span class="stringliteral">&#39;text/plain&#39;</span> <span class="keywordflow">in</span> response.headers[<span class="stringliteral">&#39;Content-Type&#39;</span>]</div>
<div class="line">    <span class="keyword">assert</span> response.text == <span class="stringliteral">&#39;Привет, дорогой разработчик! Добро пожаловать&#39;</span></div>
<div class="line"> </div>
<div class="line">    translations[<span class="stringliteral">&#39;hello&#39;</span>][<span class="stringliteral">&#39;ru&#39;</span>] = <span class="stringliteral">&#39;Приветище&#39;</span></div>
<div class="line"> </div>
<div class="line">    mocked_time.sleep(10)</div>
<div class="line">    await service_client.invalidate_caches()</div>
<div class="line"> </div>
<div class="line">    response = await service_client.post(</div>
<div class="line">        <span class="stringliteral">&#39;/samples/greet&#39;</span>, params={<span class="stringliteral">&#39;username&#39;</span>: <span class="stringliteral">&#39;дорогой разработчик&#39;</span>},</div>
<div class="line">    )</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line">    <span class="keyword">assert</span> <span class="stringliteral">&#39;text/plain&#39;</span> <span class="keywordflow">in</span> response.headers[<span class="stringliteral">&#39;Content-Type&#39;</span>]</div>
<div class="line">    <span class="keyword">assert</span> response.text == <span class="stringliteral">&#39;Приветище, дорогой разработчик! Добро пожаловать&#39;</span></div>
</div><!-- fragment --></li>
</ul>
<h1><a class="anchor" id="autotoc_md718"></a>
Full sources</h1>
<p>See the full example:</p><ul>
<li><a class="el" href="../../d3/db5/samples_2http_caching_2http_caching_8cpp-example.html">samples/http_caching/http_caching.cpp</a></li>
<li><a class="el" href="../../d4/d04/samples_2http_caching_2static_config_8yaml-example.html">samples/http_caching/static_config.yaml</a></li>
<li><a class="el" href="../../d6/dec/samples_2http_caching_2CMakeLists_8txt-example.html">samples/http_caching/CMakeLists.txt</a></li>
<li><a class="el" href="../../dd/df0/samples_2http_caching_2tests_2conftest_8py-example.html">samples/http_caching/tests/conftest.py</a></li>
<li><a class="el" href="../../d9/d0d/samples_2http_caching_2tests_2test_http_caching_8py-example.html">samples/http_caching/tests/test_http_caching.py</a></li>
</ul>
<hr  />
<p> <div class="bottom-nav">  ⇦ <a class="el" href="../../db/db9/md_en_2userver_2tutorial_2tcp__full.html">TCP full-duplex server with metrics and Spans</a> | <a class="el" href="../../d8/d91/md_en_2userver_2tutorial_2flatbuf__service.html">HTTP Flatbuf handler and requests</a> ⇨  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:56:00 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
