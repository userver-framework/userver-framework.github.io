<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: uPg: Automatic connection limit</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d1/d60/md_en_2userver_2pg__connlimit__mode__auto.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">uPg: Automatic connection limit</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md435"></a> </p>
<h1><a class="anchor" id="autotoc_md436"></a>
Server connection limit</h1>
<p>A PostgreSQL server has a connection limit for all clients. If there are too many client connections, it may lead to random connection closing. You have to thoroughly calculate client instance count in the cluster and serverside connection limit to get maximum client pool size. Moreover, you have to recalculate the limit in case of cluster resize.</p>
<p>It is a whole thing to maintain the limit all the time and it is error-prone. A wrong setup might lead to incidents.</p>
<p>That's why we have "connlimit-mode: auto" that override the <a class="el" href="../../d1/d92/classcomponents_1_1Postgres.html" title="PosgreSQL client component.">components::Postgres</a> static config option <code>max_pool_size</code>.</p>
<h1><a class="anchor" id="autotoc_md437"></a>
connlimit-mode: auto</h1>
<p>The PostgreSQL driver allows one to automatically determine the required max connection limit. It is calculated as follows:</p>
<div class="fragment"><div class="line">client_max_connections = server_max_connections/instances - reserved</div>
</div><!-- fragment --><p><code>server_max_connections</code> is calculated based on <code>SHOW max_connections</code> answer and on the current user connection limit. The service identifies <code>instanses</code> based on the following algorithm. The service creates <code>u_clients</code> table and regularly writes down information about itself. After that the service reads the table and identifies alive instances. <code>reserved</code> is set to be 5 to reflect administrative scripts connections, migration scripts, etc.</p>
<p>The limit is promptly changed after service topology change: node addition/removal, service instance stop, etc.</p>
<h1><a class="anchor" id="autotoc_md438"></a>
Disabling the feature</h1>
<p>The feature can be turned on/off in runtime via the dynamic config variable <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html#POSTGRES_CONNLIMIT_MODE_AUTO_ENABLED">POSTGRES_CONNLIMIT_MODE_AUTO_ENABLED</a>. If disabled dynamically, the previous connection limit settings are used.</p>
<p>If you want to disable the feature permanently for some clusters (e.g. in case the current user may not create <code>u_clients</code> table), you can do it in static config for <a class="el" href="../../d1/d92/classcomponents_1_1Postgres.html" title="PosgreSQL client component.">components::Postgres</a>:</p>
<div class="fragment"><div class="line">components_manager:</div>
<div class="line">    components:</div>
<div class="line">        postgres-xxx:</div>
<div class="line">            connlimit_mode: manual</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md439"></a>
Error "No available connections found"</h1>
<p>This error tells that there are no available connections in the pool. But it doesn't mean that the service exceeded the limit of the number of connections.</p>
<p>The pg-driver will try to create a new connection asynchronously (with the deadline from the initial request). If another connection is released from another request, driver will take it. If request spikes are expected, you might increase the <code>min_pool_size</code> option (default 4) in <a class="el" href="../../d1/d92/classcomponents_1_1Postgres.html" title="PosgreSQL client component.">components::Postgres</a> config to prepare some available connections for these request spikes. Also, if there are logs such as <code>Connecting: X. Max concurrent connecting: X.</code>, you might increase the <code>connecting_limit</code> option (default unlimited) in <a class="el" href="../../d1/d92/classcomponents_1_1Postgres.html" title="PosgreSQL client component.">components::Postgres</a> config. Also, you can change these options by the dynamic config <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html#POSTGRES_CONNECTION_POOL_SETTINGS">POSTGRES_CONNECTION_POOL_SETTINGS</a></p>
<dl class="section warning"><dt>Warning</dt><dd>No new connections will be created if there are many errors when creating a connection in the recent period. The recent error period is 15 seconds. Error count is controlled by the option <code>recent-errors-threshold</code> (default 2) in the dynamic config <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html#POSTGRES_CONNECTION_SETTINGS">POSTGRES_CONNECTION_SETTINGS</a>. Errors accounted for the purposes of <code>recent-errors-threshold</code> are: 1) A timeout error when creating a connection 2) A ConnectionError (aborted connections and pipeline mode errors)</dd></dl>
<hr  />
<p> <div class="bottom-nav">  ⇦ <a class="el" href="../../da/d75/pg_topology.html">uPg: Cluster topology discovery</a> | <a class="el" href="../../df/d47/md_en_2userver_2pg__user__types.html">uPg: PostgreSQL user type mappings</a> ⇨  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:55:59 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
