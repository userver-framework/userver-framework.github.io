<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: gRPC</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d1/d06/md_en_2userver_2grpc.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">gRPC</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md294"></a> <b>Quality:</b> <a class="el" href="../../db/d57/md_en_2userver_2development_2stability.html#QUALITY_TIERS">Platinum Tier</a>.</p>
<h1><a class="anchor" id="autotoc_md295"></a>
Introduction</h1>
<p>üêô <b>userver</b> provides a gRPC driver as <code>userver-grpc</code> library. It uses <code>namespace <a class="el" href="../../df/d12/namespaceugrpc_1_1client.html" title="Client-side utilities.">ugrpc::client</a></code> and <code>namespace <a class="el" href="../../db/dfe/namespaceugrpc_1_1server.html" title="Server-side utilities.">ugrpc::server</a></code>.</p>
<p>The driver wraps <code>grpcpp</code> in the userver asynchronous interface.</p>
<p>See also:</p><ul>
<li><a class="el" href="../../d6/daa/md_en_2userver_2tutorial_2grpc__service.html">gRPC client and service</a></li>
<li><a href="https://grpc.io/docs/languages/cpp/">Official gRPC documentation</a></li>
<li><a href="https://grpc.github.io/grpc/cpp/index.html">grpcpp reference</a></li>
<li><a href="https://grpc.github.io/grpc/core/index.html">grpc-core reference</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md296"></a>
Capabilities</h1>
<ul>
<li>Creating asynchronous gRPC clients and services;</li>
<li>Forwarding gRPC Core logs to userver logs;</li>
<li>Caching and reusing connections;</li>
<li>Timeouts;</li>
<li>Collection of metrics on driver usage;</li>
<li>Cancellation support;</li>
<li>Automatic authentication using middlewares;</li>
<li><a class="el" href="../../d6/d64/md_en_2userver_2deadline__propagation.html">Deadline propagation</a> .</li>
</ul>
<h1><a class="anchor" id="autotoc_md297"></a>
Installation</h1>
<p>Generate and link a library from <code>.proto</code> schemas and link to it in your <code>CMakeLists.txt</code>:</p>
<div class="fragment"><div class="line">userver_add_grpc_library(${PROJECT_NAME}-proto PROTOS samples/greeter.proto)</div>
<div class="line">target_link_libraries(${PROJECT_NAME}_objs PUBLIC ${PROJECT_NAME}-proto)</div>
</div><!-- fragment --><p><code>userver_add_grpc_library</code> will link <code>userver-grpc</code> transitively and will generate the usual <code>.pb.h + .pb.cc</code> files. For service definitions, it will additionally generate asynchronous interfaces <code>foo_client.usrv.pb.hpp</code> and <code>foo_service.usrv.pb.hpp</code>.</p>
<p>To create gRPC clients in your microservice, register the provided <a class="el" href="../../db/d02/classugrpc_1_1client_1_1ClientFactoryComponent.html" title="Provides a ClientFactory in the component system.">ugrpc::client::ClientFactoryComponent</a> and add the corresponding component section to the static config.</p>
<p>To create gRPC services in your microservice, register the provided <a class="el" href="../../d7/d9a/classugrpc_1_1server_1_1ServerComponent.html" title="Component that configures and manages the gRPC server.">ugrpc::server::ServerComponent</a> and add the corresponding component section to the static config.</p>
<h1><a class="anchor" id="autotoc_md298"></a>
gRPC clients</h1>
<h2><a class="anchor" id="autotoc_md299"></a>
Client creation</h2>
<p>In a component constructor, find <a class="el" href="../../db/d02/classugrpc_1_1client_1_1ClientFactoryComponent.html" title="Provides a ClientFactory in the component system.">ugrpc::client::ClientFactoryComponent</a> and store a reference to its <a class="el" href="../../d5/dac/classugrpc_1_1client_1_1ClientFactory.html" title="Creates gRPC clients.">ugrpc::client::ClientFactory</a>. Using it, you can create gRPC clients of code-generated <code>YourServiceClient</code> types.</p>
<p>Client creation in an expensive operation! Either create them once at the server boot time or cache them.</p>
<h2><a class="anchor" id="autotoc_md300"></a>
Client usage</h2>
<p>Typical steps include:</p><ul>
<li>Filling a <code>std::unique_ptr&lt;grpc::ClientContext&gt;</code> with request settings<ul>
<li>gRPC documentation recommends using <code>set_deadline</code> for each RPC</li>
<li>Fill the authentication metadata as necessary</li>
</ul>
</li>
<li>Stream creation by calling a client method</li>
<li>Operations on the stream</li>
<li>Depending on the RPC kind, it is necessary to call <code>Finish</code> or <code>Read</code> until it returns <code>false</code> (otherwise the connection will close abruptly)</li>
</ul>
<p>Read the documentation on gRPC streams:</p><ul>
<li>Single request, single response <a class="el" href="../../d4/dd4/classugrpc_1_1client_1_1UnaryCall.html" title="Controls a single request -&gt; single response RPC.">ugrpc::client::UnaryCall</a></li>
<li>Single request, response stream <a class="el" href="../../d2/d96/classugrpc_1_1client_1_1InputStream.html" title="Controls a single request -&gt; response stream RPC.">ugrpc::client::InputStream</a></li>
<li>Request stream, single response <a class="el" href="../../d0/dec/classugrpc_1_1client_1_1OutputStream.html" title="Controls a request stream -&gt; single response RPC.">ugrpc::client::OutputStream</a></li>
<li>Request stream, response stream <a class="el" href="../../d1/dd7/classugrpc_1_1client_1_1BidirectionalStream.html" title="Controls a request stream -&gt; response stream RPC.">ugrpc::client::BidirectionalStream</a></li>
</ul>
<p>On errors, exceptions from <a class="el" href="../../db/dfb/grpc_2include_2userver_2ugrpc_2client_2exceptions_8hpp.html" title="Exceptions thrown by gRPC client streams.">userver/ugrpc/client/exceptions.hpp</a> are thrown. It is recommended to catch them outside the entire stream interaction. You can catch exceptions for <a href="https://grpc.github.io/grpc/core/md_doc_statuscodes.html">specific gRPC error codes</a> or all at once.</p>
<h2><a class="anchor" id="autotoc_md301"></a>
TLS / SSL</h2>
<p>May be enabled for gRPC client via:</p>
<div class="fragment"><div class="line"># yaml</div>
<div class="line">components_manager:</div>
<div class="line">    components:</div>
<div class="line">        grpc-client-factory:</div>
<div class="line">            auth-type: ssl</div>
</div><!-- fragment --><p>Available values are:</p>
<ul>
<li><code>insecure</code> (default)</li>
<li><code>ssl</code></li>
</ul>
<p>SSL has to be disabled in tests, because it requires the server to have a public domain name, which it does not in tests. In testsuite, SSL in gRPC clients is disabled automatically.</p>
<p>TLS for gRPC server may be enabled via:</p>
<div class="fragment"><div class="line"># yaml</div>
<div class="line">components_manager:</div>
<div class="line">    components:</div>
<div class="line">        grpc-server:</div>
<div class="line">            tls:</div>
<div class="line">                key: /path/to/private.key</div>
<div class="line">                cert: /path/to/cert.crt</div>
<div class="line">                # remove if you don&#39;t force client cert verification</div>
<div class="line">                ca: /path/to/ca.crt</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md302"></a>
Client middlewares</h2>
<p>Client behaviour can be modified with a middleware. Middleware code is executed before or after the client code. Middlewares to use are indicated in static config in the defining component. For example:</p>
<div class="fragment"><div class="line"># yaml</div>
<div class="line">components_manager:</div>
<div class="line">    components:</div>
<div class="line">        grpc-client-factory:</div>
<div class="line">            middlewares:</div>
<div class="line">              - grpc-client-logging</div>
<div class="line">              - grpc-client-deadline-propagation </div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md303"></a>
List of standard client middlewares</h3>
<ol type="1">
<li><code>grpc-client-logging</code> with component <a class="el" href="../../d2/d09/classugrpc_1_1client_1_1middlewares_1_1log_1_1Component.html" title="Component for gRPC client logging.">ugrpc::client::middlewares::log::Component</a> - logs requests and responses.</li>
<li><code>grpc-client-deadline-propagation</code> with component <a class="el" href="../../da/df9/classugrpc_1_1client_1_1middlewares_1_1deadline__propagation_1_1Component.html" title="Component for gRPC client deadline_propagation. Update deadline from TaskInheritedData if it exists a...">ugrpc::client::middlewares::deadline_propagation::Component</a> - activates <a class="el" href="../../d6/d64/md_en_2userver_2deadline__propagation.html">Deadline propagation</a>.</li>
<li><code>grpc-client-baggage</code> with component <a class="el" href="../../d6/de9/classugrpc_1_1client_1_1middlewares_1_1baggage_1_1Component.html" title="Component for gRPC client baggage.">ugrpc::client::middlewares::baggage::Component</a> - passes request baggage to subrequests.</li>
</ol>
<h1><a class="anchor" id="autotoc_md304"></a>
gRPC services</h1>
<h2><a class="anchor" id="autotoc_md305"></a>
Service creation</h2>
<p>A service implementation is a class derived from a code-generated <code>YourServiceBase</code> interface class. Each service method from the schema corresponds to a method of the interface class. If you don't override some of the methods, <code>UNIMPLEMENTED</code> error code will be reported for those.</p>
<p>To register your service:</p><ul>
<li>Create a component that derives from <a class="el" href="../../df/d19/classugrpc_1_1server_1_1ServiceComponentBase.html" title="Base class for all the gRPC service components.">ugrpc::server::ServiceComponentBase</a></li>
<li>Store your service implementation instance inside the component</li>
<li>Call <a class="el" href="../../df/d19/classugrpc_1_1server_1_1ServiceComponentBase.html#a395af87934a76f44ae7f419fc26d5b43">ugrpc::server::ServiceComponentBase::RegisterService</a> in the component's constructor</li>
<li>Don't forget to register your service component.</li>
</ul>
<h2><a class="anchor" id="autotoc_md306"></a>
Service method handling</h2>
<p>Each method receives:</p><ul>
<li>A stream controller object, used to respond to the RPC<ul>
<li>Also contains grpc::ClientContext from grpcpp library</li>
</ul>
</li>
<li>A request (for single-request RPCs only)</li>
</ul>
<p>When using a server stream, always call <code>Finish</code> or <code>FinishWithError</code>. Otherwise the client will receive <code>UNKNOWN</code> error, which signifies an internal server error.</p>
<p>Read the documentation on gRPC streams:</p><ul>
<li>Single request, single response <a class="el" href="../../d6/d9d/classugrpc_1_1server_1_1UnaryCall.html" title="Controls a single request -&gt; single response RPC.">ugrpc::server::UnaryCall</a></li>
<li>Request stream, single response <a class="el" href="../../dc/db6/classugrpc_1_1server_1_1InputStream.html" title="Controls a request stream -&gt; single response RPC.">ugrpc::server::InputStream</a></li>
<li>Single request, response stream <a class="el" href="../../da/d89/classugrpc_1_1server_1_1OutputStream.html" title="Controls a single request -&gt; response stream RPC.">ugrpc::server::OutputStream</a></li>
<li>Request stream, response stream <a class="el" href="../../d3/d6c/classugrpc_1_1server_1_1BidirectionalStream.html" title="Controls a request stream -&gt; response stream RPC.">ugrpc::server::BidirectionalStream</a></li>
</ul>
<p>On connection errors, exceptions from <a class="el" href="../../d0/dba/grpc_2include_2userver_2ugrpc_2server_2exceptions_8hpp.html" title="Errors thrown by gRPC server streams.">userver/ugrpc/server/exceptions.hpp</a> are thrown. It is recommended not to catch them, leading to RPC interruption. You can catch exceptions for <a href="https://grpc.github.io/grpc/core/md_doc_statuscodes.html">specific gRPC error codes</a> or all at once.</p>
<h2><a class="anchor" id="autotoc_md307"></a>
Custom server credentials</h2>
<p>By default, gRPC server uses <code>grpc::InsecureServerCredentials</code>. To pass a custom credentials:</p>
<ol type="1">
<li>Do not pass <code>grpc-server.port</code> in the static config</li>
<li>Create a custom component, e.g. <code>GrpcServerConfigurator</code></li>
<li><code>context.FindComponent&lt;<a class="el" href="../../d7/d9a/classugrpc_1_1server_1_1ServerComponent.html" title="Component that configures and manages the gRPC server.">ugrpc::server::ServerComponent</a>&gt;().GetServer()</code></li>
<li>Call <a class="el" href="../../d9/d55/classugrpc_1_1server_1_1Server.html#a7b4f32fa5c613d5523f98a011be33b05">WithServerBuilder</a> method on the returned <a class="el" href="../../d9/d55/classugrpc_1_1server_1_1Server.html">server</a></li>
<li>Inside the callback, call <code>grpc::ServerBuilder::AddListeningPort</code>, passing it your custom credentials<ul>
<li>Look into grpc++ documentation and into <code>&lt;grpcpp/security/server_credentials.h&gt;</code> for available credentials</li>
<li>SSL credentials are <code>grpc::SslServerCredentials</code></li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md308"></a>
Server middlewares</h2>
<p>The gRPC server can be extended by middlewares. Middleware is called on each incoming (for service) or outgoing (for client) RPC request. Different middlewares handle the call in the defined order. A middleware may decide to reject the call or call the next middleware in the stack. Middlewares may implement almost any enhancement to the gRPC server including authorization and authentication, ratelimiting, logging, tracing, audit, etc.</p>
<p>Middlewares to use are indicated in static config in section <code>middlewares</code> of <code><a class="el" href="../../df/d19/classugrpc_1_1server_1_1ServiceComponentBase.html" title="Base class for all the gRPC service components.">ugrpc::server::ServiceComponentBase</a></code> descendant component. Default middleware list for handlers can be specified in <code>grpc-server.service-defaults.middlewares</code> config section.</p>
<p>Example configuration: </p><div class="fragment"><div class="line">components_manager:</div>
<div class="line">    components:</div>
<div class="line">        some-service-client:</div>
<div class="line">            middlewares:</div>
<div class="line">              - grpc-client-logging</div>
<div class="line">              - grpc-client-deadline-propagation</div>
<div class="line">              - grpc-client-baggage</div>
<div class="line"> </div>
<div class="line">        grpc-server:</div>
<div class="line">            service-defaults:</div>
<div class="line">                middlewares:</div>
<div class="line">                  - grpc-server-logging</div>
<div class="line">                  - grpc-server-deadline-propagation</div>
<div class="line">                  - grpc-server-congestion-control</div>
<div class="line">                  - grpc-server-baggage</div>
<div class="line"> </div>
<div class="line">        some-service:</div>
<div class="line">            middlewares:</div>
<div class="line">              # Completely overwrite the default list</div>
<div class="line">              - grpc-server-logging</div>
</div><!-- fragment --><p>Use <a class="el" href="../../d7/d2d/classugrpc_1_1server_1_1MiddlewareBase.html" title="Base class for server gRPC middleware.">ugrpc::server::MiddlewareBase</a> and <a class="el" href="../../da/da3/classugrpc_1_1client_1_1MiddlewareBase.html" title="Base class for client gRPC middleware.">ugrpc::client::MiddlewareBase</a> to implement new middlewares.</p>
<h3><a class="anchor" id="autotoc_md309"></a>
List of standard server middlewares:</h3>
<ol type="1">
<li><code>grpc-server-logging</code> with component <a class="el" href="../../d8/db0/classugrpc_1_1server_1_1middlewares_1_1log_1_1Component.html" title="Component for gRPC server logging.">ugrpc::server::middlewares::log::Component</a> - logs requests.</li>
<li><code>grpc-server-deadline-propagation</code> with component <a class="el" href="../../d1/de3/classugrpc_1_1server_1_1middlewares_1_1deadline__propagation_1_1Component.html" title="Component for gRPC server deadline propagation.">ugrpc::server::middlewares::deadline_propagation::Component</a> - activates <a class="el" href="../../d6/d64/md_en_2userver_2deadline__propagation.html">Deadline propagation</a>.</li>
<li><code>grpc-server-congestion-control</code> with component <a class="el" href="../../d4/dae/classugrpc_1_1server_1_1middlewares_1_1congestion__control_1_1Component.html" title="Component for gRPC server logging.">ugrpc::server::middlewares::congestion_control::Component</a> - limits requests. See Congestion Control section of <a class="el" href="../../db/d69/md_en_2userver_2tutorial_2production__service.html">Production configs and best practices</a>.</li>
<li><code>grpc-server-baggage</code> with component <a class="el" href="../../d1/d3f/classugrpc_1_1server_1_1middlewares_1_1baggage_1_1Component.html" title="Component for gRPC server baggage.">ugrpc::server::middlewares::baggage::Component</a> - passes request baggage to subrequests.</li>
<li><code>grpc-server-headers-propagator</code> with component <a class="el" href="../../d6/dee/classugrpc_1_1server_1_1middlewares_1_1headers__propagator_1_1Component.html" title="Component for gRPC server headers_propagator.">ugrpc::server::middlewares::headers_propagator::Component</a> - propagates headers.</li>
</ol>
<h1><a class="anchor" id="autotoc_md310"></a>
gRPC Logs</h1>
<p>Each gRPC call generates a span ( <code><a class="el" href="../../d7/d1a/classtracing_1_1Span.html" title="Measures the execution time of the current code block, links it with the parent tracing::Spans and st...">tracing::Span</a></code> ) containing tags which are inherited by all child logs.</p>
<p>Additionally, if logging is activated, a separate log is generated for every gRPC request-response in <code>grpc-server-logging</code> and <code>grpc-client-logging</code> middlewares.</p>
<p>gRPC logs are listed below.</p>
<h2><a class="anchor" id="autotoc_md311"></a>
Client log tags</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Middleware component name   </th><th class="markdownTableHeadNone">Key   </th><th class="markdownTableHeadNone">Value    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">builtin   </td><td class="markdownTableBodyNone"><code>error</code>   </td><td class="markdownTableBodyNone">error flag, <code>true</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">builtin   </td><td class="markdownTableBodyNone"><code>grpc_code</code>   </td><td class="markdownTableBodyNone">error code <code>grpc::StatusCode</code>, <a href="https://grpc.github.io/grpc/core/md_doc_statuscodes.html">list</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">builtin   </td><td class="markdownTableBodyNone"><code>error_msg</code>   </td><td class="markdownTableBodyNone">error message    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>grpc-client-logging</code>   </td><td class="markdownTableBodyNone"><code>meta_type</code>   </td><td class="markdownTableBodyNone">call name    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>grpc-client-logging</code>   </td><td class="markdownTableBodyNone"><code>grpc_type</code>   </td><td class="markdownTableBodyNone"><code>request</code> or <code>response</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>grpc-client-logging</code>   </td><td class="markdownTableBodyNone"><code>body</code>   </td><td class="markdownTableBodyNone">logged message body    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>grpc-client-deadline-propagation</code>   </td><td class="markdownTableBodyNone"><code>deadline_updated</code>   </td><td class="markdownTableBodyNone">error flag, <code>true</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>grpc-client-deadline-propagation</code>   </td><td class="markdownTableBodyNone"><code>timeout_ms</code>   </td><td class="markdownTableBodyNone">amount of time before request deadline   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md312"></a>
Server log tags</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Middleware component name   </th><th class="markdownTableHeadNone">Key   </th><th class="markdownTableHeadNone">Value    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">builtin   </td><td class="markdownTableBodyNone"><code>error</code>   </td><td class="markdownTableBodyNone">error flag <code>true</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">builtin   </td><td class="markdownTableBodyNone"><code>error_msg</code>   </td><td class="markdownTableBodyNone">error message    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>grpc-server-logging</code>   </td><td class="markdownTableBodyNone"><code>meta_type</code>   </td><td class="markdownTableBodyNone">call name    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>grpc-server-logging</code>   </td><td class="markdownTableBodyNone"><code>body</code>   </td><td class="markdownTableBodyNone">logged message body    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>grpc-server-logging</code>   </td><td class="markdownTableBodyNone"><code>type</code>   </td><td class="markdownTableBodyNone"><code>request</code> or <code>response</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>grpc-server-logging</code>   </td><td class="markdownTableBodyNone"><code>grpc_type</code>   </td><td class="markdownTableBodyNone"><code>request</code> or <code>response</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>grpc-server-deadline-propagation</code>   </td><td class="markdownTableBodyNone"><code>received_deadline_ms</code>   </td><td class="markdownTableBodyNone">deadline    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>grpc-server-deadline-propagation</code>   </td><td class="markdownTableBodyNone"><code>cancelled_by_deadline</code>   </td><td class="markdownTableBodyNone"><code>true</code> or <code>false</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>grpc-server-congestion-control</code>   </td><td class="markdownTableBodyNone"><code>limit</code>   </td><td class="markdownTableBodyNone">rate limit when request is throttled (tokens per second)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>grpc-server-congestion-control</code>   </td><td class="markdownTableBodyNone"><code>service/method</code>   </td><td class="markdownTableBodyNone">method name when request is throttled    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>grpc-server-baggage</code>   </td><td class="markdownTableBodyNone"><code>Got baggage header:</code>   </td><td class="markdownTableBodyNone">baggage header   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md313"></a>
Hiding fields in request-response logs</h2>
<p>The gRPC driver provides log fields hiding in request-response logs. You need to do the following:</p>
<p>1) Add <a href="https://github.com/userver-framework/userver/blob/develop/grpc/proto/userver/field_options.proto">userver/field_options.proto</a> to your service. Generate a library from this proto file and link against it in your <code>CMakeLists.txt</code>.</p>
<p>2) Import userver/field_options.proto in your proto file.</p>
<p>3) Use <code>[(userver.field).secret = true]</code> opposite to the filds that you want to hide. In the following example the fields <code>password</code> and <code>secret_code</code> will be hidden in the logs:</p>
<div class="fragment"><div class="line">message Creds {</div>
<div class="line">  string login = 1;</div>
<div class="line">  string password = 2 [(userver.field).secret = true];</div>
<div class="line">  string secret_code = 3 [(userver.field).secret = true];</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md314"></a>
grpc-core logs</h2>
<p>grpc-core is a lower level library, its logs are forwarded to the userver default logger. In this process only error level logs get through from grpc-core to the userver default logger if the default settings are used. However, the default settings can be overriden and more verbose logging can be achieved.</p>
<p>To do this you need to change the value of <code>native-log-level</code> in the static config file in the components <code>grpc-client-common</code> and <code>grpc-server</code>:</p>
<div class="fragment"><div class="line">grpc-server:</div>
<div class="line">    native-log-level: debug</div>
</div><!-- fragment --><p>There are 3 possible logging levels: <code>error</code>, <code>info</code>, <code>debug</code>. If logging level is set in several components then the most verbose logging level is used.</p>
<p><a class="anchor" id="grpc_generic_api"></a></p>
<h1><a class="anchor" id="autotoc_md315"></a>
Generic API</h1>
<p>gRPC generic API allows to call and accept RPCs with dynamic service and method names. The other side will see this as a normal RPC, it does not need to use generic API.</p>
<p>Intended mainly for use in proxies. Metadata can be used to proxy the request without parsing it.</p>
<p>See details in:</p>
<ul>
<li><a class="el" href="../../d6/d04/classugrpc_1_1client_1_1GenericClient.html">ugrpc::client::GenericClient</a> ;</li>
<li><a class="el" href="../../dd/d39/classugrpc_1_1server_1_1GenericServiceBase.html">ugrpc::server::GenericServiceBase</a> .</li>
</ul>
<p>Full example showing the usage of both:</p>
<ul>
<li>grpc-generic-proxy/src/proxy_service.hpp</li>
<li>grpc-generic-proxy/src/proxy_service.cpp</li>
<li>grpc-generic-proxy/main.cpp</li>
<li>grpc-generic-proxy/static_config.yaml</li>
<li>grpc-generic-proxy/config_vars.yaml</li>
<li>grpc-generic-proxy/CMakeLists.txt</li>
</ul>
<p>Based on:</p>
<ul>
<li>grpcpp <a href="https://grpc.github.io/grpc/cpp/grpcpp_2generic_2generic__stub_8h.html">generic stub</a>;</li>
<li>grpcpp <a href="https://grpc.github.io/grpc/cpp/grpcpp_2generic_2async__generic__service_8h.html">generic service</a>.</li>
</ul>
<h1><a class="anchor" id="autotoc_md316"></a>
Metrics</h1>
<ul>
<li>Client metrics are put inside <code>grpc.client.by-destination</code></li>
<li>Server metrics are put inside <code>grpc.server.by-destination</code></li>
<li>Client-wide totals are currently NOT computed</li>
<li>Server-wide totals are put inside <code>grpc.server.total</code></li>
</ul>
<p>Each metric has the following labels:</p>
<ul>
<li><code>grpc_service</code> - fully qualified grpc (proto) service name</li>
<li><code>grpc_method</code> - fully qualified grpc method name</li>
<li><code>grpc_destination</code> = <code>grpc_service/grpc_method</code></li>
<li><code>grpc_destination_full</code> = <code>client_name/grpc_service/grpc_method</code> (only for client metrics)</li>
</ul>
<p>These are the metrics provided for each gRPC method:</p>
<ul>
<li><code>timings.1min</code> ‚Äî time from RPC start to finish (<code><a class="el" href="../../df/d18/classutils_1_1statistics_1_1Percentile.html" title="Class allows easy calculation of percentiles.">utils::statistics::Percentile</a></code>)</li>
<li><code>status</code> with label <code>grpc_code=STATUS_CODE_NAME</code> ‚Äî RPCs that finished with specified status codes, one metric per gRPC status. Zero <code>status</code> metrics are omitted, except for <code>OK</code> and <code>UNKNOWN</code> metrics, which are always written.</li>
<li>Metrics for RPCs that finished abruptly without a status:<ul>
<li><code>cancelled</code> ‚Äî RPCs that were interrupted due to task cancellation. (Not to be confused with RPCs finished with <code>CANCELLED</code> status.) Server-side, this means that the client dropped the RPC or called <code>TryCancel</code>. Client-side, this likely means that either the parent handler was interrupted, or the RPC was dropped as unnecessary. See <a class="el" href="../../d8/ddb/classugrpc_1_1client_1_1RpcCancelledError.html" title="RPC failed due to task cancellation.">ugrpc::client::RpcCancelledError</a> and <a class="el" href="../../d0/dd9/classugrpc_1_1server_1_1RpcInterruptedError.html" title="RPC failed without a status. This means that either the call got cancelled using TryCancel,...">ugrpc::server::RpcInterruptedError</a></li>
<li><code>cancelled-by-deadline-propagation</code> ‚Äî RPCs, the handling of which was interrupted because the deadline specified in the request was reached. (Available for both server and client-side.) See also <a class="el" href="../../d6/d64/md_en_2userver_2deadline__propagation.html">userver deadline propagation</a></li>
<li><code>network-error</code> ‚Äî other RPCs that finished abruptly without a status, see <a class="el" href="../../db/d86/classugrpc_1_1client_1_1RpcInterruptedError.html" title="RPC failed without a status. This means that either the call got cancelled using TryCancel,...">ugrpc::client::RpcInterruptedError</a> and <a class="el" href="../../d0/dd9/classugrpc_1_1server_1_1RpcInterruptedError.html" title="RPC failed without a status. This means that either the call got cancelled using TryCancel,...">ugrpc::server::RpcInterruptedError</a></li>
</ul>
</li>
<li><code>abandoned-error</code> ‚Äî RPCs that we forgot to <code>Finish</code> (always a bug in <code>ugrpc</code> usage). Such RPCs also separately report the status or network error that occurred during the automatic request termination</li>
<li><code>deadline-propagated</code> ‚Äî RPCs, for which deadline was specified. See also <a class="el" href="../../d6/d64/md_en_2userver_2deadline__propagation.html">userver deadline propagation</a></li>
<li><code>rps</code> ‚Äî requests per second: <div class="fragment"><div class="line">sum(status) + network-error + cancelled + cancelled-by-deadline-propagation</div>
</div><!-- fragment --></li>
<li><code>eps</code> ‚Äî server errors per second <div class="fragment"><div class="line">sum(status if is_error(status))</div>
</div><!-- fragment --> The status codes to be considered server errors are chosen according to <a href="https://opentelemetry.io/docs/specs/semconv/rpc/grpc/#grpc-status">OpenTelemetry recommendations</a><ul>
<li><code>UNKNOWN</code></li>
<li><code>DATA_LOSS</code></li>
<li><code>UNIMPLEMENTED</code></li>
<li><code>INTERNAL</code></li>
<li><code>UNAVAILABLE</code></li>
<li>Note: <code>network-error</code> is not accounted in <code>eps</code>, because either the client is responsible for the server dropping the request (<code>TryCancel</code>, deadline), or it is truly a network error, in which case it's typically helpful for troubleshooting to say that there are issues not with the uservice process itself, but with the infrastructure</li>
</ul>
</li>
<li><code>active</code> ‚Äî The number of currently active RPCs (created and not finished)</li>
</ul>
<p>An example of userver gRPC metrics.</p>
<h1><a class="anchor" id="autotoc_md317"></a>
Unit tests and benchmarks</h1>
<ul>
<li><a class="el" href="../../d6/daa/md_en_2userver_2tutorial_2grpc__service.html">gRPC client and service</a> shows how to test userver gRPC services and clients in gtest</li>
<li><a class="el" href="../../d2/d59/classugrpc_1_1tests_1_1Service.html">ugrpc::tests::Service</a> and <a class="el" href="../../dc/da7/classugrpc_1_1tests_1_1ServiceBase.html" title="Sets up a mini gRPC server using the provided service implementations.">ugrpc::tests::ServiceBase</a> can be used to benchmark userver gRPC services and clients, as well as create more complex gtest tests with multiple services and perhaps databases.</li>
</ul>
<hr  />
<p> <div class="bottom-nav">  ‚á¶ <a class="el" href="../../db/d8f/md_en_2userver_2profile__context__switches.html">Profiling context switches</a> | <a class="el" href="../../dd/de2/rabbitmq_driver.html">RabbitMQ (AMQP 0-9-1)</a> ‚á®  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:55:59 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
