<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: Functional service tests (testsuite)</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('df/d07/md_en_2userver_2functional__testing.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Functional service tests (testsuite)</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md268"></a> </p>
<h1><a class="anchor" id="autotoc_md269"></a>
Getting started</h1>
<p>üêô <b>userver</b> has built-in support for functional service tests using <a href="https://pypi.org/project/yandex-taxi-testsuite/">Yandex.Taxi Testsuite</a>. Testsuite is based on <a href="https://pytest.org/">pytest</a> and allows developers to test their services in isolated environment. It starts service binary with minimal database and all external services mocked then allows developer to call service handlers and test their result.</p>
<p>Supported features:</p>
<ul>
<li>Database startup (Mongo, Postgresql, Clickhouse, Kafka, ...)</li>
<li>Per-test database state</li>
<li>Service startup</li>
<li>Mocksever to mock external service handlers</li>
<li>Mock service time, <code><a class="el" href="../../db/dec/namespaceutils_1_1datetime.html#a55c8fa2daccb0874282e200e656e005f" title="std::chrono::system_clock::now() that could be mocked">utils::datetime::Now()</a></code></li>
<li>Testpoint</li>
<li>Cache invalidation</li>
<li>Logs capture</li>
<li>Service runner</li>
</ul>
<h1><a class="anchor" id="autotoc_md270"></a>
CMake integration</h1>
<h2><a class="anchor" id="autotoc_md271"></a>
CMake integration via <code>userver_testsuite_add()</code></h2>
<p>With <code>userver_testsuite_add()</code> function you can easily add testsuite support to your project. Its main purpose is:</p>
<ul>
<li>Setup Python <code>venv</code> environment or use an existing one.</li>
<li>Create runner script that setups <code>PYTHONPATH</code> and passes extra arguments to <code>pytest</code>.</li>
<li>Register <code>ctest</code> target.</li>
<li>Add a <code>start-*</code> target that starts the service and databases with testsuite configs and waits for keyboard interruption to stop the service.</li>
</ul>
<p><a class="el" href="../../d0/d5d/cmake_2UserverTestsuite_8cmake-example.html">cmake/UserverTestsuite.cmake</a> library is automatically added to CMake path after userver environment setup. Add the following line to use it:</p>
<div class="fragment"><div class="line"># cmake</div>
<div class="line">include(UserverTestsuite)</div>
</div><!-- fragment --><p>Then create testsuite target: </p><div class="fragment"><div class="line"><span class="comment">userver_testsuite_add(</span></div>
<div class="line"><span class="comment">  SERVICE_TARGET ${PROJECT_NAME}</span></div>
<div class="line"><span class="comment">  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/tests</span></div>
<div class="line"><span class="comment">  PYTHON_BINARY ${TESTSUITE_PYTHON_BINARY}</span></div>
<div class="line"><span class="comment">  PYTEST_ARGS</span></div>
<div class="line"><span class="comment">  --service-config=${CMAKE_CURRENT_SOURCE_DIR}/static_config.yaml</span></div>
<div class="line"><span class="comment">  --service-binary=${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}</span></div>
<div class="line"><span class="comment">  --service-config-vars=${CMAKE_CURRENT_SOURCE_DIR}/config_vars.yaml</span></div>
<div class="line"><span class="comment">)</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md272"></a>
Arguments</h2>
<ul>
<li>SERVICE_TARGET, required CMake name of the target service to test. Used as suffix for <code>testsuite-</code> and <code>start-</code> CMake target names.</li>
<li>WORKING_DIRECTORY, pytest working directory. Default is ${CMAKE_CURRENT_SOURCE_DIR}.</li>
<li>PYTEST_ARGS, list of extra arguments passed to <code>pytest</code>.</li>
<li>PYTHONPATH, list of directories to be prepended to <code>PYTHONPATH</code>.</li>
<li>REQUIREMENTS, list of requirements.txt files used to populate <code>venv</code>.</li>
<li>PYTHON_BINARY, path to existing Python binary.</li>
<li>PRETTY_LOGS, set to <code>OFF</code> to disable pretty printing.</li>
</ul>
<p>Some of the most useful arguments for PYTEST_ARGS:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Argument   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-v</code>   </td><td class="markdownTableBodyNone">Increase verbosity    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>-s</code>   </td><td class="markdownTableBodyNone">Do not intercept <code>stdout</code> and <code>stderr</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-x</code>   </td><td class="markdownTableBodyNone">Stop on first error    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>-k EXPRESSION</code>   </td><td class="markdownTableBodyNone">Filter tests by expression    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>--service-logs-pretty</code>   </td><td class="markdownTableBodyNone">Enable logs coloring    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>--service-logs-pretty-disable</code>   </td><td class="markdownTableBodyNone">Disable logs coloring    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>--service-log-level=LEVEL</code>   </td><td class="markdownTableBodyNone">Set the log level for the service. Possible values: <code>trace</code>, <code>debug</code>, <code>info</code>, <code>warning</code>, <code>error</code>, <code>critical</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>--service-wait</code>   </td><td class="markdownTableBodyNone">With this argument the testsuite will wait for the service start by user. For example under gdb. Testsuite outputs a hint on starting the service    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>-rf</code>   </td><td class="markdownTableBodyNone">Show a summary of failed tests   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md273"></a>
CMake integration via <code>userver_testsuite_add_simple()</code></h2>
<p><code>userver_testsuite_add_simple()</code> is a version of <code>userver_testsuite_add()</code> that makes some assumptions of the project structure. It should be invoked from the service's <code>CMakeLists.txt</code> as follows:</p>
<div class="fragment"><div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">userver_testsuite_add_simple()</span></div>
<div class="line"><span class="comment"></span> </div>
</div><!-- fragment --><p>It supports the following file structure (and a few others):</p>
<ul>
<li><code>configs/config.yaml</code></li>
<li><code>configs/config_vars.[testsuite|tests].yaml</code> [optional]</li>
<li><code>configs/dynamic_config_fallback.json</code> [optional]</li>
<li><code>configs/[secdist|secure_data].json</code> [optional]</li>
<li><code>[testsuite|tests]/conftest.py</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md274"></a>
Python environment</h2>
<p>You may want to create new virtual environment with its own set of packages. Or reuse existing one. That could be done this way:</p>
<ul>
<li>If <code>PYTHON_BINARY</code> is specified then it is used.</li>
<li>Otherwise, a new test venv is created. Passed <code>REQUIREMENTS</code>, if any, are installed. Requirements of userver itself (based on selected <code>USERVER_FEATURE_*</code> flags) are installed as well.</li>
</ul>
<p>Basic <code>requirements.txt</code> file may look like this:</p>
<div class="fragment"><div class="line">yandex-taxi-testsuite[mongodb]</div>
</div><!-- fragment --><p>Creating per-testsuite virtual environment is a recommended way to go. It creates Python venv in the current binary directory:</p>
<p><code>${CMAKE_CURRENT_BINARY_DIR}/venv-testsuite-${SERVICE_TARGET}</code></p>
<h2><a class="anchor" id="autotoc_md275"></a>
Run with ctest</h2>
<p><code>userver_testsuite_add()</code> registers a ctest target with name <code>testsuite-${SERVICE_TARGET}</code>. Run all project tests with ctest command or use filters to run specific tests:</p>
<div class="fragment"><div class="line">ctest -V -R testsuite-my-project  # SERVICE_TARGET argument is used</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md276"></a>
Direct run</h2>
<p>To run pytest directly <code>userver_testsuite_add()</code> creates a testsuite runner script that could be found in corresponding binary directory. This may be useful to run a single testcase, to start the testsuite with gdb or to start the testsuite with extra pytest arguments:</p>
<p><code>${CMAKE_CURRENT_BINARY_DIR}/runtests-testsuite-${SERVICE_TARGET}</code></p>
<p>You can use it to manually start testsuite with extra <code>pytest</code> arguments, e.g.:</p>
<div class="fragment"><div class="line">./build/tests/runtests-testsuite-my-project -vvx ./tests -k test_foo</div>
</div><!-- fragment --><p>Please refer to <code>testuite</code> and <code>pytest</code> documentation for available options. Run it with <code>--help</code> argument to see the short options description.</p>
<div class="fragment"><div class="line">./build/tests/runtests-testsuite-my-project ./tests --help</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md277"></a>
Debug</h2>
<p>To debug the functional test you can start testsuite with extra <code>pytest</code> arguments, e.g.:</p>
<div class="fragment"><div class="line">./build/tests/runtests-testsuite-my-project --service-wait ./tests -k test_foo</div>
</div><!-- fragment --><p>At the beginning of the execution the console will display the command to start the service, e.g.:</p>
<div class="fragment"><div class="line">gdb --args /.../my-project/build/functional-tests --config /.../config.yaml</div>
</div><!-- fragment --><p>Now you can open a new terminal window and run this command in it or if you use an IDE you can find the corresponding CMake target and add arg <code>--config /.../config.yaml</code>. After that it will be possible to set breakpoints and start target with debug.</p>
<h1><a class="anchor" id="autotoc_md278"></a>
pytest_userver</h1>
<p>By default <code><a class="el" href="../../d3/d88/namespacepytest__userver.html" title="Python module pytest_userver provides testsuite support for userver services.">pytest_userver</a></code> plugin is included in python path. It provides basic testsuite support for userver service. To use it add it to your <code>pytest_plugins</code> in root <code>conftest.py</code>:</p>
<div class="fragment"><div class="line"><span class="comment"># Adding a plugin from userver/testsuite/pytest_plugins/</span></div>
<div class="line">pytest_plugins = [<span class="stringliteral">&#39;pytest_userver.plugins.core&#39;</span>]</div>
</div><!-- fragment --><p>It requires extra PYTEST_ARGS to be passed:</p>
<div class="fragment"><div class="line"><span class="comment">userver_testsuite_add(</span></div>
<div class="line"><span class="comment">  SERVICE_TARGET ${PROJECT_NAME}</span></div>
<div class="line"><span class="comment">  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/tests</span></div>
<div class="line"><span class="comment">  PYTHON_BINARY ${TESTSUITE_PYTHON_BINARY}</span></div>
<div class="line"><span class="comment">  PYTEST_ARGS</span></div>
<div class="line"><span class="comment">  --service-config=${CMAKE_CURRENT_SOURCE_DIR}/static_config.yaml</span></div>
<div class="line"><span class="comment">  --service-binary=${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}</span></div>
<div class="line"><span class="comment">  --service-config-vars=${CMAKE_CURRENT_SOURCE_DIR}/config_vars.yaml</span></div>
<div class="line"><span class="comment">)</span></div>
</div><!-- fragment --><p>The plugins match the userver cmake targets. For example, if the service links with <code>userver::core</code> its tests should use the <a class="el" href="../../d6/d25/namespacepytest__userver_1_1plugins_1_1core.html" title="Python plugin that provides core fixtures for functional tests with testsuite; see Functional service...">pytest_userver.plugins.core</a> plugin.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">CMake target   </th><th class="markdownTableHeadNone">Matching plugin for testsuite    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">userver::core   </td><td class="markdownTableBodyNone"><a class="el" href="../../d6/d25/namespacepytest__userver_1_1plugins_1_1core.html" title="Python plugin that provides core fixtures for functional tests with testsuite; see Functional service...">pytest_userver.plugins.core</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">userver::grpc   </td><td class="markdownTableBodyNone"><a class="el" href="../../de/d62/namespacepytest__userver_1_1plugins_1_1grpc.html" title="Python plugin that provides gRPC fixtures for functional tests with testsuite; see Functional service...">pytest_userver.plugins.grpc</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">userver::postgresql   </td><td class="markdownTableBodyNone"><a class="el" href="../../df/d1c/namespacepytest__userver_1_1plugins_1_1postgresql.html" title="Plugin that imports the required fixtures to start the database and adjusts the PostgreSQL &quot;dbconnect...">pytest_userver.plugins.postgresql</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">userver::clickhouse   </td><td class="markdownTableBodyNone"><a class="el" href="../../d6/d7f/namespacepytest__userver_1_1plugins_1_1clickhouse.html" title="Plugin that imports the required fixtures to start the Clickhouse database.">pytest_userver.plugins.clickhouse</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">userver::redis   </td><td class="markdownTableBodyNone"><a class="el" href="../../df/d5c/namespacepytest__userver_1_1plugins_1_1redis.html" title="Plugin that imports the required fixtures to start the Redis database.">pytest_userver.plugins.redis</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">userver::mongo   </td><td class="markdownTableBodyNone"><a class="el" href="../../de/d6b/namespacepytest__userver_1_1plugins_1_1mongo.html" title="Plugin that imports the required fixtures to start the database and adjusts the mongo &quot;dbconnection&quot; ...">pytest_userver.plugins.mongo</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">userver::rabbitmq   </td><td class="markdownTableBodyNone"><a class="el" href="../../d4/dc0/namespacepytest__userver_1_1plugins_1_1rabbitmq.html" title="Plugin that imports the required fixtures to start the RabbitMQ.">pytest_userver.plugins.rabbitmq</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">userver::kafka   </td><td class="markdownTableBodyNone"><a class="el" href="../../d2/ddb/namespacepytest__userver_1_1plugins_1_1kafka.html" title="Plugin that imports the required fixtures to start the broker.">pytest_userver.plugins.kafka</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">userver::mysql   </td><td class="markdownTableBodyNone"><a class="el" href="../../da/dee/namespacepytest__userver_1_1plugins_1_1mysql.html" title="Plugin that imports the required fixtures to start the MySQL/MariaDB database.">pytest_userver.plugins.mysql</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">userver::ydb   </td><td class="markdownTableBodyNone"><a class="el" href="../../d6/d35/namespacepytest__userver_1_1plugins_1_1ydb.html" title="pytest plugin that provides YDB fixtures for functional tests with testsuite; see YDB for an introduc...">pytest_userver.plugins.ydb</a>   </td></tr>
</table>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../d3/da9/md_en_2userver_2tutorial_2build.html#userver_libraries">userver_libraries</a></dd></dl>
<h2><a class="anchor" id="autotoc_md279"></a>
Userver testsuite support</h2>
<p>Userver has built-in support for testsuite.</p>
<p>In order to use it you need to register corresponding components:</p>
<p>Headers:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d6/d43/tests__control_8hpp.html" title="Handler that allows to control the behavior of server from tests, and functional tests with testsuite...">userver/server/handlers/tests_control.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d3/d37/testsuite__support_8hpp.html" title="Testsuite support component.">userver/testsuite/testsuite_support.hpp</a>&gt;</span></div>
</div><!-- fragment --><p>Add components to components list:</p>
<div class="fragment"><div class="line">            .Append&lt;components::TestsuiteSupport&gt;()</div>
<div class="line">            .Append&lt;<a class="code hl_class" href="../../d5/ded/classserver_1_1handlers_1_1TestsControl.html" title="Handler that allows to control the behavior of server from tests, and functional tests with testsuite...">server::handlers::TestsControl</a>&gt;()</div>
<div class="line">            .Append&lt;components::DynamicConfigClient&gt;()</div>
<div class="line">            .Append&lt;<a class="code hl_class" href="../../d3/da0/classcomponents_1_1DynamicConfigClientUpdater.html" title="Component that does a periodic update of runtime configs.">components::DynamicConfigClientUpdater</a>&gt;()</div>
</div><!-- fragment --><p>Add testsuite components to <code>config.yaml</code>:</p>
<div class="fragment"><div class="line">        tests-control:</div>
<div class="line">            load-enabled: $testsuite-enabled</div>
<div class="line">            path: /tests/{action}</div>
<div class="line">            method: POST</div>
<div class="line">            task_processor: main-task-processor</div>
<div class="line">            testpoint-timeout: 10s</div>
<div class="line">            testpoint-url: mockserver/testpoint</div>
<div class="line">            throttling_enabled: false</div>
<div class="line">        testsuite-support:</div>
</div><!-- fragment --><dl class="section warning"><dt>Warning</dt><dd>Please note that the variable <code>testsuite-enabled</code> must be disabled in production environment. Testsuite sets the <code>testsuite-enabled</code> variable into <code>true</code> when it runs the service. In the example above this variable controls whether <code>tests-control</code> component is loaded. This component must be disabled for production.</dd></dl>
<h2><a class="anchor" id="autotoc_md280"></a>
Features</h2>
<p>The essential parts of the testsuite are <a class="el" href="../../dc/db7/group__userver__testsuite__fixtures.html#service_client">pytest_userver.plugins.service_client.service_client</a> and <a class="el" href="../../dc/db7/group__userver__testsuite__fixtures.html#gabb8550b2f685640c794e2bd66f67a9e6" title="Main fixture that provides access to userver monitor listener.">pytest_userver.plugins.service_client.monitor_client</a> fixtures that give you access to the <a class="el" href="../../d5/d79/classpytest__userver_1_1client_1_1Client.html" title="Asyncio userver client, typically retrieved from plugins.service_client.service_client fixture.">pytest_userver.client.Client</a> and <a class="el" href="../../d5/dd8/classpytest__userver_1_1client_1_1ClientMonitor.html" title="Asyncio userver client for monitor listeners, typically retrieved from plugins.service_client....">pytest_userver.client.ClientMonitor</a> respectively. Those types allow to interact with a running service.</p>
<p>Testsuite functions reference could be found at <a class="el" href="../../db/daa/group__userver__testsuite.html">Testsuite Python support</a>.</p>
<p><a class="anchor" id="SERVICE_CONFIG_HOOKS"></a></p>
<h3><a class="anchor" id="autotoc_md281"></a>
Service config generation</h3>
<p><code><a class="el" href="../../d3/d88/namespacepytest__userver.html" title="Python module pytest_userver provides testsuite support for userver services.">pytest_userver</a></code> modifies static configs <code>config.yaml</code> and <code>config_vars.yaml</code> passed to pytest before starting the userver based service.</p>
<p>To apply additional modifications to the static config files declare <code>USERVER_CONFIG_HOOKS</code> variable in your pytest-plugin with a list of functions or pytest-fixtures that should be run before config is written to disk. USERVER_CONFIG_HOOKS values are collected across different files and all the collected functions and fixtures are applied.</p>
<p>Example usage:</p>
<div class="fragment"><div class="line">USERVER_CONFIG_HOOKS = [<span class="stringliteral">&#39;prepare_service_config&#39;</span>]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">@pytest.fixture(scope=&#39;session&#39;)</span></div>
<div class="line"><span class="keyword">def </span>prepare_service_config(grpc_mockserver_endpoint):</div>
<div class="line">    <span class="keyword">def </span>patch_config(config, config_vars):</div>
<div class="line">        components = config[<span class="stringliteral">&#39;components_manager&#39;</span>][<span class="stringliteral">&#39;components&#39;</span>]</div>
<div class="line">        components[<span class="stringliteral">&#39;greeter-client&#39;</span>][<span class="stringliteral">&#39;endpoint&#39;</span>] = grpc_mockserver_endpoint</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> patch_config</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md282"></a>
Service client</h3>
<p>Fixture <a class="el" href="../../dc/db7/group__userver__testsuite__fixtures.html#service_client">service_client</a> is used to access the service being tested:</p>
<div class="fragment"><div class="line"><span class="keyword">async def </span>test_ping(service_client):</div>
<div class="line">    response = await service_client.get(<span class="stringliteral">&#39;/ping&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
</div><!-- fragment --><p>When <code>tests-control</code> component is enabled service_client is <code><a class="el" href="../../d5/d79/classpytest__userver_1_1client_1_1Client.html" title="Asyncio userver client, typically retrieved from plugins.service_client.service_client fixture.">pytest_userver.client.Client</a></code> instance. Which supports special testsuite related methods.</p>
<p>On first call to <code>service_client</code> service state is implicitly updated, e.g.: caches, mocked time, etc.</p>
<h3><a class="anchor" id="autotoc_md283"></a>
Service environment variables</h3>
<p>Use <a class="el" href="../../dc/db7/group__userver__testsuite__fixtures.html#ga588add6a832f263b08760df32bb5edd2">service_env</a> fixture to provide extra environment variables for your service:</p>
<div class="fragment"><div class="line"><span class="preprocessor">@pytest.fixture(scope=&#39;session&#39;)</span></div>
<div class="line"><span class="keyword">def </span>service_env(redis_sentinels):</div>
<div class="line">    secdist_config = {</div>
<div class="line">        <span class="stringliteral">&#39;redis_settings&#39;</span>: {</div>
<div class="line">            <span class="stringliteral">&#39;taxi-tmp&#39;</span>: {</div>
<div class="line">                <span class="stringliteral">&#39;password&#39;</span>: <span class="stringliteral">&#39;&#39;</span>,</div>
<div class="line">                <span class="stringliteral">&#39;sentinels&#39;</span>: redis_sentinels,</div>
<div class="line">                <span class="stringliteral">&#39;shards&#39;</span>: [{<span class="stringliteral">&#39;name&#39;</span>: <span class="stringliteral">&#39;test_master0&#39;</span>}],</div>
<div class="line">            },</div>
<div class="line">        },</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> {<span class="stringliteral">&#39;SECDIST_CONFIG&#39;</span>: json.dumps(secdist_config)}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md284"></a>
Extra client dependencies</h3>
<p>Use <a class="el" href="../../dc/db7/group__userver__testsuite__fixtures.html#ga7fc327f52c588f33b3a66fcacb6b8783">extra_client_deps</a> fixture to provide extra fixtures that your service depends on:</p>
<div class="fragment"><div class="line"><span class="preprocessor">@pytest.fixture</span></div>
<div class="line"><span class="keyword">def </span>extra_client_deps(some_fixture_that_required_by_service, some_other_fixture):</div>
<div class="line">    <span class="keywordflow">pass</span></div>
</div><!-- fragment --><p>Note that <a class="el" href="../../dc/db7/group__userver__testsuite__fixtures.html#gae69bdc9e879f4e45233fba123d7b699f">auto_client_deps</a> fixture already knows about the userver supported databases and clients, so usually you do not need to manually register any dependencies.</p>
<h3><a class="anchor" id="autotoc_md285"></a>
Mockserver</h3>
<p><a href="https://yandex.github.io/yandex-taxi-testsuite/mockserver/">Mockserver</a> allows to mock external HTTP handlers. It starts its own HTTP server that receives HTTP traffic from the service being tested. And allows to install custom HTTP handlers within testsuite. In order to use it all HTTP clients must be pointed to mockserver address.</p>
<p>Mockserver usage example:</p>
<div class="fragment"><div class="line"><span class="preprocessor">@pytest.fixture(autouse=True)</span></div>
<div class="line"><span class="keyword">def </span>mock_translations(mockserver, translations, mocked_time):</div>
<div class="line">    <span class="preprocessor">@mockserver.json_handler(&#39;/v1/translations&#39;)</span></div>
<div class="line">    <span class="keyword">def </span>mock(request):</div>
<div class="line">        <span class="keywordflow">return</span> {</div>
<div class="line">            <span class="stringliteral">&#39;content&#39;</span>: translations,</div>
<div class="line">            <span class="stringliteral">&#39;update_time&#39;</span>: utils.timestring(mocked_time.now()),</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> mock</div>
</div><!-- fragment --><ul>
<li>Testcase: <a class="el" href="../../dd/df0/samples_2http_caching_2tests_2conftest_8py-example.html">samples/http_caching/tests/conftest.py</a></li>
</ul>
<p>To connect your HTTP client to the mockserver make the HTTP client use a base URL of the form <b><a href="http://{mockserver}/{service_name}/">http://{mockserver}/{service_name}/</a></b>.</p>
<p>This could be achieved by patching static config as described in <a class="el" href="#SERVICE_CONFIG_HOOKS">config hooks</a> and providing a mockserver address using <a href="https://yandex.github.io/yandex-taxi-testsuite/mockserver/#testsuite.mockserver.classes.MockserverInfo.url">mockserver_info.url(path)</a>:</p>
<div class="fragment"><div class="line">pytest_plugins = [<span class="stringliteral">&#39;pytest_userver.plugins.core&#39;</span>]</div>
<div class="line"> </div>
<div class="line">USERVER_CONFIG_HOOKS = [<span class="stringliteral">&#39;userver_config_translations&#39;</span>]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">@pytest.fixture(scope=&#39;session&#39;)</span></div>
<div class="line"><span class="keyword">def </span>userver_config_translations(mockserver_info):</div>
<div class="line">    <span class="keyword">def </span>do_patch(config_yaml, config_vars):</div>
<div class="line">        components = config_yaml[<span class="stringliteral">&#39;components_manager&#39;</span>][<span class="stringliteral">&#39;components&#39;</span>]</div>
<div class="line">        components[<span class="stringliteral">&#39;cache-http-translations&#39;</span>][<span class="stringliteral">&#39;translations-url&#39;</span>] = (</div>
<div class="line">            mockserver_info.url(<span class="stringliteral">&#39;v1/translations&#39;</span>)</div>
<div class="line">        )</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> do_patch</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md286"></a>
Mock time</h3>
<p>Userver provides a way to mock internal datetime value. It only works for datetime retrieved with <code><a class="el" href="../../db/dec/namespaceutils_1_1datetime.html#a55c8fa2daccb0874282e200e656e005f" title="std::chrono::system_clock::now() that could be mocked">utils::datetime::Now()</a></code>, see <a class="el" href="../../d4/d70/md_en_2userver_2testing.html#utest-mocked-time">Mocked time section</a> for details.</p>
<p>From testsuite you can control it with <a href="https://yandex.github.io/yandex-taxi-testsuite/other_plugins/#mocked-time">mocked_time</a> plugin.</p>
<p>Example usage:</p>
<div class="fragment"><div class="line"><span class="preprocessor">@pytest.mark.now(&#39;2019-12-31T11:22:33Z&#39;)</span></div>
<div class="line"><span class="keyword">async def </span>test_now(service_client, mocked_time):</div>
<div class="line">    response = await service_client.get(<span class="stringliteral">&#39;/now&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line">    <span class="keyword">assert</span> <span class="stringliteral">&#39;application/json&#39;</span> <span class="keywordflow">in</span> response.headers[<span class="stringliteral">&#39;Content-Type&#39;</span>]</div>
<div class="line">    <span class="keyword">assert</span> response.json() == {<span class="stringliteral">&#39;now&#39;</span>: <span class="stringliteral">&#39;2019-12-31T11:22:33+00:00&#39;</span>}</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># Change mocked time and sync state</span></div>
<div class="line">    mocked_time.sleep(671)</div>
<div class="line">    await service_client.update_server_state()</div>
<div class="line"> </div>
<div class="line">    response = await service_client.get(<span class="stringliteral">&#39;/now&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line">    <span class="keyword">assert</span> <span class="stringliteral">&#39;application/json&#39;</span> <span class="keywordflow">in</span> response.headers[<span class="stringliteral">&#39;Content-Type&#39;</span>]</div>
<div class="line">    <span class="keyword">assert</span> response.json() == {<span class="stringliteral">&#39;now&#39;</span>: <span class="stringliteral">&#39;2019-12-31T11:33:44+00:00&#39;</span>}</div>
</div><!-- fragment --><p>Example are available here:</p>
<ul>
<li>C++ code: <a class="el" href="../../d9/d6d/samples_2testsuite-support_2src_2now_8cpp-example.html">samples/testsuite-support/src/now.cpp</a></li>
<li>Testcase: <a class="el" href="../../dd/df0/samples_2testsuite-support_2tests_2test_mocked_time_8py-example.html">samples/testsuite-support/tests/test_mocked_time.py</a></li>
</ul>
<h3><a class="anchor" id="autotoc_md287"></a>
Testpoint</h3>
<p><a href="https://yandex.github.io/yandex-taxi-testsuite/testpoint/">Testpoints</a> are used to send messages from the service to testcase and back. Typical use cases are:</p>
<ul>
<li>Retrieve intermediate state of the service and test it</li>
<li>Inject errors into the service</li>
<li>Synchronize service and testcase execution</li>
</ul>
<p>First of all you should include testpoint header:</p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d9/d1d/testpoint_8hpp.html" title="Send testpoint notification. Works only if testpoint support is enabled (e.g. in components::TestsCon...">userver/testsuite/testpoint.hpp</a>&gt;</span></div>
</div><!-- fragment --><p>It provides <code><a class="el" href="../../d9/d1d/testpoint_8hpp.html#a8a6d27a839e4327f705ac8d965e4b6e8" title="Send testpoint notification. Works only if testpoint support is enabled (e.g. in components::TestsCon...">TESTPOINT()</a></code> and family of <code><a class="el" href="../../d9/d1d/testpoint_8hpp.html#affc6f7542ce4c6a761234d96c33f43d0" title="Send testpoint notification and receive data. Works only if testpoint support is enabled (e....">TESTPOINT_CALLBACK()</a></code> macros that do nothing in production environment and only work when run under testsuite. Under testsuite they only make sense when corresponding testsuite handler is installed.</p>
<p>All testpoints has their own name that is used to call named testsuite handler. Second argument is <code><a class="el" href="../../de/d91/classformats_1_1json_1_1Value.html" title="Non-mutable JSON value representation.">formats::json::Value()</a></code> instance that is only evaluated under testsuite.</p>
<p><code><a class="el" href="../../d9/d1d/testpoint_8hpp.html#a8a6d27a839e4327f705ac8d965e4b6e8" title="Send testpoint notification. Works only if testpoint support is enabled (e.g. in components::TestsCon...">TESTPOINT()</a></code> usage sample:</p>
<div class="fragment"><div class="line">    <a class="code hl_define" href="../../d9/d1d/testpoint_8hpp.html#a8a6d27a839e4327f705ac8d965e4b6e8" title="Send testpoint notification. Works only if testpoint support is enabled (e.g. in components::TestsCon...">TESTPOINT</a>(<span class="stringliteral">&quot;simple-testpoint&quot;</span>, [] {</div>
<div class="line">        <a class="code hl_class" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html" title="Builder for JSON.">formats::json::ValueBuilder</a> builder;</div>
<div class="line">        builder[<span class="stringliteral">&quot;payload&quot;</span>] = <span class="stringliteral">&quot;Hello, world!&quot;</span>;</div>
<div class="line">        <span class="keywordflow">return</span> builder.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a078ae0edbffa37a654914629000680ad" title="Take out the resulting Value object. After calling this method the object is in unspecified (but vali...">ExtractValue</a>();</div>
<div class="line">    }());</div>
</div><!-- fragment --><p>Then you can use testpoint from testcase:</p>
<div class="fragment"><div class="line"><span class="keyword">async def </span>test_basic(service_client, testpoint):</div>
<div class="line">    <span class="preprocessor">@testpoint(&#39;simple-testpoint&#39;)</span></div>
<div class="line">    <span class="keyword">def </span>simple_testpoint(data):</div>
<div class="line">        <span class="keyword">assert</span> data == {<span class="stringliteral">&#39;payload&#39;</span>: <span class="stringliteral">&#39;Hello, world!&#39;</span>}</div>
<div class="line"> </div>
<div class="line">    response = await service_client.get(<span class="stringliteral">&#39;/testpoint&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line">    <span class="keyword">assert</span> <span class="stringliteral">&#39;application/json&#39;</span> <span class="keywordflow">in</span> response.headers[<span class="stringliteral">&#39;Content-Type&#39;</span>]</div>
<div class="line">    <span class="keyword">assert</span> simple_testpoint.times_called == 1</div>
</div><!-- fragment --><p>In order to eliminate unnecessary testpoint requests userver keeps track of testpoints that have testsuite handlers installed. Usually testpoint handlers are declared before first call to <a class="el" href="../../dc/db7/group__userver__testsuite__fixtures.html#service_client">service_client</a> which implicitly updates userver's list of testpoint. Sometimes it might be required to manually update server state. This can be achieved using <code>service_client.update_server_state()</code> method e.g.:</p>
<div class="fragment"><div class="line">    <span class="preprocessor">@testpoint(&#39;injection-point&#39;)</span></div>
<div class="line">    <span class="keyword">def </span>injection_point(data):</div>
<div class="line">        <span class="keywordflow">return</span> {<span class="stringliteral">&#39;value&#39;</span>: <span class="stringliteral">&#39;injected&#39;</span>}</div>
<div class="line"> </div>
<div class="line">    await service_client.update_server_state()</div>
<div class="line">    <span class="keyword">assert</span> injection_point.times_called == 0</div>
</div><!-- fragment --><p>Accessing testpoint userver is not aware of will raise an exception:</p>
<div class="fragment"><div class="line">    <span class="keyword">with</span> pytest.raises(</div>
<div class="line">        <a class="code hl_class" href="../../d5/d1e/classpytest__userver_1_1plugins_1_1testpoint_1_1UnregisteredTestpointError.html">pytest_userver.plugins.testpoint.UnregisteredTestpointError</a>,</div>
<div class="line">    ):</div>
<div class="line">        <span class="keyword">assert</span> injection_point.times_called == 0</div>
</div><!-- fragment --><ul>
<li>C++ code: <a class="el" href="../../d6/d02/samples_2testsuite-support_2src_2testpoint_8cpp-example.html">samples/testsuite-support/src/testpoint.cpp</a></li>
<li>Testcase: <a class="el" href="../../d9/d75/samples_2testsuite-support_2tests_2test_testpoint_8py-example.html">samples/testsuite-support/tests/test_testpoint.py</a></li>
</ul>
<p><a class="anchor" id="testsuite_logs_capture"></a></p>
<h3><a class="anchor" id="autotoc_md288"></a>
Logs capture</h3>
<p>Testsuite can be used to test logs written by service. To achieve this the testsuite starts a simple logs capture TCP server and tells the service to replicate logs to it on per test basis.</p>
<p>Example usage: </p><div class="fragment"><div class="line"><span class="keyword">async def </span>test_select(service_client):</div>
<div class="line">    <span class="keyword">async</span> <span class="keyword">with</span> service_client.capture_logs(log_level=<span class="stringliteral">&#39;INFO&#39;</span>) <span class="keyword">as</span> capture:</div>
<div class="line">        response = await service_client.get(<span class="stringliteral">&#39;/logcapture&#39;</span>)</div>
<div class="line">        <span class="keyword">assert</span> response.status == 200</div>
<div class="line"> </div>
<div class="line">    records = capture.select(</div>
<div class="line">        text=<span class="stringliteral">&#39;Message to capture&#39;</span>, link=response.headers[<span class="stringliteral">&#39;x-yarequestid&#39;</span>],</div>
<div class="line">    )</div>
<div class="line">    <span class="keyword">assert</span> len(records) == 1, capture.select()</div>
</div><!-- fragment --><p>Example on logs capture usage could be found here:</p>
<ul>
<li>C++ code: <a class="el" href="../../df/d36/samples_2testsuite-support_2src_2logcapture_8cpp-example.html">samples/testsuite-support/src/logcapture.cpp</a></li>
<li>Testcase: <a class="el" href="../../d1/d98/samples_2testsuite-support_2tests_2test_logcapture_8py-example.html">samples/testsuite-support/tests/test_logcapture.py</a></li>
</ul>
<p><a class="anchor" id="TESTSUITE_TASKS"></a></p>
<h3><a class="anchor" id="autotoc_md289"></a>
Testsuite tasks</h3>
<p>Testsuite tasks facility allows to register a custom function and call it by name from testsuite. It's useful for testing components that perform periodic job not related to its own HTTP handler.</p>
<p>You can use <code><a class="el" href="../../dd/dc0/classtestsuite_1_1TestsuiteTasks.html" title="Testsuite tasks support.">testsuite::TestsuiteTasks</a></code> to register your own task:</p>
<div class="fragment"><div class="line">    <span class="keyword">auto</span>&amp; testsuite_tasks = <a class="code hl_function" href="../../d3/d56/namespacetestsuite.html#a66b38b3d8afe9b7f27f89451165da6db" title="Get reference to TestsuiteTasks instance.">testsuite::GetTestsuiteTasks</a>(context);</div>
<div class="line">    <span class="comment">// Only register task for testsuite environment</span></div>
<div class="line">    <span class="keywordflow">if</span> (testsuite_tasks.IsEnabled()) {</div>
<div class="line">        testsuite_tasks.RegisterTask(<span class="stringliteral">&quot;sample-task&quot;</span>, [] {</div>
<div class="line">            <a class="code hl_define" href="../../d9/d1d/testpoint_8hpp.html#a8a6d27a839e4327f705ac8d965e4b6e8" title="Send testpoint notification. Works only if testpoint support is enabled (e.g. in components::TestsCon...">TESTPOINT</a>(<span class="stringliteral">&quot;sample-task/action&quot;</span>, [] {</div>
<div class="line">                <a class="code hl_class" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html" title="Builder for JSON.">formats::json::ValueBuilder</a> builder;</div>
<div class="line">                <span class="keywordflow">return</span> builder.<a class="code hl_function" href="../../d2/daa/classformats_1_1json_1_1ValueBuilder.html#a078ae0edbffa37a654914629000680ad" title="Take out the resulting Value object. After calling this method the object is in unspecified (but vali...">ExtractValue</a>();</div>
<div class="line">            }());</div>
<div class="line">        });</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">// Proudction code goes here</span></div>
<div class="line">    }</div>
</div><!-- fragment --><p>After that you can call your task from testsuite code:</p>
<div class="fragment"><div class="line">    await service_client.run_task(<span class="stringliteral">&#39;sample-task&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> task_action.times_called == 1</div>
</div><!-- fragment --><p>Or spawn the task asynchronously using context manager:</p>
<div class="fragment"><div class="line">    <span class="keyword">async</span> <span class="keyword">with</span> service_client.spawn_task(<span class="stringliteral">&#39;sample-task&#39;</span>):</div>
<div class="line">        await task_action.wait_call()</div>
</div><!-- fragment --><p>An example on testsuite tasks could be found here:</p>
<ul>
<li>C++ code: <a class="el" href="../../d5/dc4/samples_2testsuite-support_2src_2tasks_8cpp-example.html">samples/testsuite-support/src/tasks.cpp</a></li>
<li>Testcase: <a class="el" href="../../d1/d57/samples_2testsuite-support_2tests_2test_tasks_8py-example.html">samples/testsuite-support/tests/test_tasks.py</a></li>
</ul>
<p><a class="anchor" id="TESTSUITE_METRICS_TESTING"></a></p>
<h3><a class="anchor" id="autotoc_md290"></a>
Metrics</h3>
<p>Testsuite provides access to userver metrics written by <a class="el" href="../../d7/dd9/classutils_1_1statistics_1_1Writer.html" title="Class for writing metrics.">utils::statistics::Writer</a> and <a class="el" href="../../d7/d33/classutils_1_1statistics_1_1MetricTag.html" title="Metric description.">utils::statistics::MetricTag</a> via <a class="el" href="../../dc/db7/group__userver__testsuite__fixtures.html#gabb8550b2f685640c794e2bd66f67a9e6">monitor_client</a> , see <a class="el" href="../../db/d69/md_en_2userver_2tutorial_2production__service.html#tutorial_metrics">tutorial on configuration</a>. It allows to:</p>
<ul>
<li>retrieve specific service metric by path and (optionally) labels: <a class="el" href="../../d5/dd8/classpytest__userver_1_1client_1_1ClientMonitor.html#a0ce375173c992cf4f9a0936f3c582d24">await monitor_client.single_metric(path, labels)</a></li>
<li>retrieve array of metrics by path prefix and (optionally) labels: <a class="el" href="../../d5/dd8/classpytest__userver_1_1client_1_1ClientMonitor.html#abea2c54107600a21d31a402f1220fa88">await monitor_client.metrics(path_prefix, labels)</a></li>
<li>retrieve specific service metric by path and (optionally) labels or <code>None</code> if no such metric: <a class="el" href="../../d5/dd8/classpytest__userver_1_1client_1_1ClientMonitor.html#a0ce375173c992cf4f9a0936f3c582d24">await monitor_client.single_metric_optional(path, labels)</a></li>
<li>reset metrics: <a class="el" href="../../d5/d79/classpytest__userver_1_1client_1_1Client.html#a2f339f39e260fb7f4698ef172f9328ac">await service_client.reset_metrics()</a></li>
</ul>
<p>Example usage:</p>
<p>For a metric tag that is defined as:</p>
<div class="fragment"></div><!-- fragment --><p>and used like:</p>
<div class="fragment"><div class="line">    std::atomic&lt;int&gt;&amp; foo_metric = metrics_-&gt;GetMetric(kFooMetric);</div>
<div class="line">    ++foo_metric;  <span class="comment">// safe to increment conceurrently</span></div>
</div><!-- fragment --><p>the metrics could be retrieved and reset as follows:</p>
<div class="fragment"><div class="line"><span class="keyword">async def </span>test_reset(service_client, monitor_client):</div>
<div class="line">    <span class="comment"># Reset service metrics</span></div>
<div class="line">    await service_client.reset_metrics()</div>
<div class="line">    <span class="comment"># Retrieve metrics</span></div>
<div class="line">    metric = await monitor_client.single_metric(<span class="stringliteral">&#39;sample-metrics.foo&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> metric.value == 0</div>
<div class="line">    <span class="keyword">assert</span> <span class="keywordflow">not</span> metric.labels</div>
</div><!-- fragment --><p>For metrics with labels, they could be retrieved in the following way:</p>
<div class="fragment"><div class="line"><span class="keyword">async def </span>test_engine_metrics(service_client, monitor_client):</div>
<div class="line">    metric = await monitor_client.single_metric(</div>
<div class="line">        <span class="stringliteral">&#39;engine.task-processors.tasks.finished&#39;</span>,</div>
<div class="line">        labels={<span class="stringliteral">&#39;task_processor&#39;</span>: <span class="stringliteral">&#39;main-task-processor&#39;</span>},</div>
<div class="line">    )</div>
<div class="line">    <span class="keyword">assert</span> metric.value &gt; 0</div>
<div class="line">    <span class="keyword">assert</span> metric.labels == {<span class="stringliteral">&#39;task_processor&#39;</span>: <span class="stringliteral">&#39;main-task-processor&#39;</span>}</div>
<div class="line"> </div>
<div class="line">    metrics_dict = await monitor_client.metrics(</div>
<div class="line">        prefix=<span class="stringliteral">&#39;http.&#39;</span>, labels={<span class="stringliteral">&#39;http_path&#39;</span>: <span class="stringliteral">&#39;/ping&#39;</span>},</div>
<div class="line">    )</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">assert</span> metrics_dict</div>
<div class="line">    <span class="keyword">assert</span> <span class="stringliteral">&#39;http.handler.cancelled-by-deadline&#39;</span> <span class="keywordflow">in</span> metrics_dict</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">assert</span> (</div>
<div class="line">        metrics_dict.value_at(</div>
<div class="line">            <span class="stringliteral">&#39;http.handler.in-flight&#39;</span>,</div>
<div class="line">            labels={</div>
<div class="line">                <span class="stringliteral">&#39;http_path&#39;</span>: <span class="stringliteral">&#39;/ping&#39;</span>,</div>
<div class="line">                <span class="stringliteral">&#39;http_handler&#39;</span>: <span class="stringliteral">&#39;handler-ping&#39;</span>,</div>
<div class="line">                <span class="stringliteral">&#39;version&#39;</span>: <span class="stringliteral">&#39;2&#39;</span>,</div>
<div class="line">            },</div>
<div class="line">        )</div>
<div class="line">        == 0</div>
<div class="line">    )</div>
</div><!-- fragment --><p>The <a class="el" href="../../d6/ddb/classpytest__userver_1_1metrics_1_1Metric.html">Metric</a> python type is hashable and comparable:</p>
<div class="fragment"><div class="line">    <span class="comment"># Checking for a particular metric</span></div>
<div class="line">    <span class="keyword">assert</span> metrics.Metric({}, value=3) <span class="keywordflow">in</span> values[<span class="stringliteral">&#39;sample&#39;</span>]</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># Comparing with a set of Metric</span></div>
<div class="line">    <span class="keyword">assert</span> values[<span class="stringliteral">&#39;sample&#39;</span>] == {</div>
<div class="line">        metrics.Metric(labels={}, value=3),</div>
<div class="line">        metrics.Metric(labels={<span class="stringliteral">&#39;label&#39;</span>: <span class="stringliteral">&#39;b&#39;</span>}, value=2),</div>
<div class="line">        metrics.Metric(labels={<span class="stringliteral">&#39;label&#39;</span>: <span class="stringliteral">&#39;a&#39;</span>}, value=1),</div>
<div class="line">    }</div>
</div><!-- fragment --><ul>
<li>C++ code: <a class="el" href="../../d7/dcf/samples_2testsuite-support_2src_2metrics_8cpp-example.html">samples/testsuite-support/src/metrics.cpp</a></li>
<li>C++ header: <a class="el" href="../../d1/dad/samples_2testsuite-support_2src_2metrics_8hpp-example.html">samples/testsuite-support/src/metrics.hpp</a></li>
<li>Testcase: <a class="el" href="../../dc/da2/samples_2testsuite-support_2tests_2test_metrics_8py-example.html">samples/testsuite-support/tests/test_metrics.py</a></li>
</ul>
<h3><a class="anchor" id="autotoc_md291"></a>
Metrics Portability</h3>
<p>Different monitoring systems and time series databases have different limitations. To make sure that the metrics of your service could be used on most of the popular systems, there is special action in <a class="el" href="../../d5/ded/classserver_1_1handlers_1_1TestsControl.html" title="Handler that allows to control the behavior of server from tests, and functional tests with testsuite...">server::handlers::TestsControl</a>.</p>
<p>To use it you could just write the following test:</p>
<div class="fragment"><div class="line"><span class="keyword">async def </span>test_metrics_portability(service_client):</div>
<div class="line">    warnings = await service_client.metrics_portability()</div>
<div class="line">    <span class="keyword">assert</span> <span class="keywordflow">not</span> warnings</div>
</div><!-- fragment --><p>Note that warnings are grouped by type, so you could check only for some particular warnings or skip some of them. For example:</p>
<div class="fragment"><div class="line"><span class="keyword">async def </span>test_partial_metrics_portability(service_client):</div>
<div class="line">    warnings = await service_client.metrics_portability()</div>
<div class="line">    warnings.pop(<span class="stringliteral">&#39;label_name_mismatch&#39;</span>, <span class="keywordtype">None</span>)</div>
<div class="line">    <span class="keyword">assert</span> <span class="keywordflow">not</span> warnings, warnings</div>
</div><!-- fragment --><ul>
<li>Testcase: <a class="el" href="../../d6/d5a/samples_2production_service_2tests_2test_production_8py-example.html">samples/production_service/tests/test_production.py</a></li>
</ul>
<h3><a class="anchor" id="autotoc_md292"></a>
Service runner</h3>
<p>Testsuite provides a way to start standalone service with all mocks and database started. This can be done by adding <code>--service-runner-mode</code> flag to pytest, e.g.:</p>
<div class="fragment"><div class="line">./build/tests/runtests-my-project ./tests -s --service-runner-mode</div>
</div><!-- fragment --><p>Please note that <code>-s</code> flag is required to disable console output capture.</p>
<p><code><a class="el" href="../../d3/d88/namespacepytest__userver.html" title="Python module pytest_userver provides testsuite support for userver services.">pytest_userver</a></code> provides default service runner testcase. In order to override it you have to add your own testcase with <code>@pytest.mark.servicetest</code>:</p>
<div class="fragment"><div class="line"><span class="preprocessor">@pytest.mark.servicetest</span></div>
<div class="line"><span class="keyword">def </span>test_service(service_client):</div>
<div class="line">    ...</div>
</div><!-- fragment --><hr  />
<p> <div class="bottom-nav">  ‚á¶ <a class="el" href="../../d4/d70/md_en_2userver_2testing.html">Unit Tests and Benchmarks</a> | <a class="el" href="../../de/d74/md_en_2userver_2chaos__testing.html">Chaos Testing</a> ‚á®  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:55:59 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
