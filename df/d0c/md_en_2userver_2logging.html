<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: Logging and Tracing</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('df/d0c/md_en_2userver_2logging.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Logging and Tracing</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md365"></a> </p>
<h1><a class="anchor" id="autotoc_md366"></a>
Logging</h1>
<p>Modern applications use logging a lot for debugging and diagnosing a running production service. Usually logs are harvested, indexed and stored in a separate service for further investigation.</p>
<p>The userver framework addresses modern logging requirements and provides multiple facilities for efficient work with logs, including <a class="el" href="../../d1/de2/md_en_2userver_2log__level__running__service.html">Logging at runtime</a>.</p>
<p>Below are the intruductions to main developer logging facilities.</p>
<h2><a class="anchor" id="autotoc_md367"></a>
Log level</h2>
<p>Macros are used for logging:</p>
<div class="fragment"><div class="line">    <a class="code hl_define" href="../../dd/de6/universal_2include_2userver_2logging_2log_8hpp.html#a9d0a09bf4292af456e282867b32d7d5e" title="Evaluates a message and logs it to the default logger if its level is below or equal to logging::Leve...">LOG_DEBUG</a>() &lt;&lt; <span class="stringliteral">&quot;Some debug info, not logged by default in production&quot;</span>;</div>
<div class="line">    <a class="code hl_define" href="../../dd/de6/universal_2include_2userver_2logging_2log_8hpp.html#a87d766158e3857c6aedba65e63f24d05" title="Evaluates a message and logs it to the default logger if its level is below or equal to logging::Leve...">LOG_INFO</a>() &lt;&lt; <span class="stringliteral">&quot;This is informational message&quot;</span>;</div>
<div class="line">    <a class="code hl_define" href="../../dd/de6/universal_2include_2userver_2logging_2log_8hpp.html#af4286b23b3d2bde3eab2c8bd7131fee4" title="Evaluates a message and logs it to the default logger if its level is below or equal to logging::Leve...">LOG_WARNING</a>() &lt;&lt; <span class="stringliteral">&quot;Something strange happened&quot;</span>;</div>
<div class="line">    <a class="code hl_define" href="../../dd/de6/universal_2include_2userver_2logging_2log_8hpp.html#aa14f3fd56b4112420dd49c2ebf8276f1" title="Evaluates a message and logs it to the default logger if its level is below or equal to logging::Leve...">LOG_ERROR</a>() &lt;&lt; <span class="stringliteral">&quot;This is unbelievable, fix me, please!&quot;</span>;</div>
</div><!-- fragment --><p>The right part of the expression is calculated only if the logging level is less or equal to the macro log level. I.e., the right part of the expression <code>LOG_DEBUG ()&lt;&lt; ...</code> is calculated only in the case of the <code>DEBUG</code> or <code>TRACE</code> logging level.</p>
<p>Sometimes it is useful to set the logging level of a given log entry dynamically:</p>
<div class="fragment"><div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> level = flag ? logging::Level::kDebug : logging::Level::kInfo;</div>
<div class="line">    <a class="code hl_define" href="../../dd/de6/universal_2include_2userver_2logging_2log_8hpp.html#ac7287b93a2311534ceb8ec2fd19ca39e" title="If lvl matches the verbosity then builds a stream and evaluates a message for the default logger.">LOG</a>(level) &lt;&lt; <span class="stringliteral">&quot;some text&quot;</span>;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md368"></a>
Filter to the log level</h2>
<p>Not all logs get into the log file, but only those that are not lower than the logger's log level. The logger log level is set in static config (see <a class="el" href="../../d4/da4/classcomponents_1_1Logging.html" title="Logging component">components::Logging</a>).</p>
<p>The log level can be changed in the static config for a particular handle. In this case, the log level of the logger is changed only for the request handling task of the handle and for all the subtasks:</p>
<div class="fragment"><div class="line">yaml</div>
<div class="line">  components_manager:</div>
<div class="line">    components:</div>
<div class="line">      handler-ping:</div>
<div class="line">        log-level: WARNING</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md369"></a>
Dynamic change of the logging level</h2>
<p>The logging <code>level</code> that was set in the static config of the <a class="el" href="../../d4/da4/classcomponents_1_1Logging.html" title="Logging component">components::Logging</a> component for the entire service can be changed on the fly. See <a class="el" href="../../d1/de2/md_en_2userver_2log__level__running__service.html">Logging at runtime</a> for more info.</p>
<h2><a class="anchor" id="autotoc_md370"></a>
Limit log length of the requests and responses</h2>
<p>For per-handle limiting of the request body or response data logging you can use the <code>request_body_size_log_limit</code> and <code>request_headers_size_log_limit</code> and <code>response_data_size_log_limit</code> static options of the handler (see <a class="el" href="../../d1/ddc/classserver_1_1handlers_1_1HandlerBase.html" title="Base class for the request handlers.">server::handlers::HandlerBase</a>). Or you could override the <a class="el" href="../../d6/d36/classserver_1_1handlers_1_1HttpHandlerBase.html#a069b15f186552632c0ed55d32803ab8d" title="Override it if you need a custom request body logging.">server::handlers::HttpHandlerBase::GetRequestBodyForLogging</a> and <a class="el" href="../../d6/d36/classserver_1_1handlers_1_1HttpHandlerBase.html#a1e3bfb0dc81fc1beaac5eeaafb25c003" title="Override it if you need a custom response data logging.">server::handlers::HttpHandlerBase::GetResponseDataForLogging</a> functions.</p>
<h2><a class="anchor" id="autotoc_md371"></a>
Limiting the log frequency</h2>
<p>If some line of code generates too many logs and a small number of them is enough, then <code>LOG_*</code> should be replaced with <code>LOG_LIMITED_*</code>. For example, <code><a class="el" href="../../dd/de6/universal_2include_2userver_2logging_2log_8hpp.html#ac7287b93a2311534ceb8ec2fd19ca39e" title="If lvl matches the verbosity then builds a stream and evaluates a message for the default logger.">LOG(lvl)</a></code> should be replaced with <code><a class="el" href="../../dd/de6/universal_2include_2userver_2logging_2log_8hpp.html#a7cfb53670165dc6ca29dbe2d28b3633b" title="If lvl matches the verbosity then builds a stream and evaluates a message for the default logger....">LOG_LIMITED(lvl)</a></code>; <code><a class="el" href="../../dd/de6/universal_2include_2userver_2logging_2log_8hpp.html#a9d0a09bf4292af456e282867b32d7d5e" title="Evaluates a message and logs it to the default logger if its level is below or equal to logging::Leve...">LOG_DEBUG()</a></code> should be replaced with <code><a class="el" href="../../dd/de6/universal_2include_2userver_2logging_2log_8hpp.html#a8afc2c936c61281a048ba2f386990604" title="Evaluates a message and logs it to the default logger if the log message does not occur too often and...">LOG_LIMITED_DEBUG()</a></code>, etc.</p>
<p>In this case, the log message is written only if the message index is a power of two. The counter is reset every second.</p>
<p>Typical <b>recommended</b> places to use limited logging:</p>
<ul>
<li><p class="startli"><b>resource unavailability</b></p>
<p class="startli">Examples: insufficient memory; another service is not responding.</p>
<p class="startli">Explanation: in case of a problem such errors are usually reported in thousands per second; their messages do not differ.</p>
</li>
<li><p class="startli"><b>incorrect use of a component or service</b></p>
<p class="startli">Examples: negative numbers are passed to your library in a method that accepts only positive ones; the requested functionality is not supported by a third-party microservice.</p>
<p class="startli">Explanation: Such errors should be caught at the testing stage. However, if a miracle suddenly happened and someone did not test the service, then the same errors are be reported in thousands per second</p>
</li>
</ul>
<p>Nuances:</p>
<ul>
<li>Each thread has separate counters, so in practice there may be a little more logs</li>
<li>If the <code>template</code> function logs via <code>LOG_LIMITED_X</code>, then each specialization of the function template has a separate counter</li>
<li>If the same function with logging via <code>LOG_LIMITED_X</code> is called in different places, then all its calls use the same counter</li>
</ul>
<h2><a class="anchor" id="autotoc_md372"></a>
Tags</h2>
<p>If you want to add tags to as single log record, then you can create an object of type <code><a class="el" href="../../d3/df8/classlogging_1_1LogExtra.html" title="Extra tskv fields storage.">logging::LogExtra</a></code>, add the necessary tags to it and output the <code>LogExtra</code> object to the log:</p>
<div class="fragment"><div class="line">    <a class="code hl_class" href="../../d3/df8/classlogging_1_1LogExtra.html" title="Extra tskv fields storage.">logging::LogExtra</a> log_extra;</div>
<div class="line">    log_extra.<a class="code hl_function" href="../../d3/df8/classlogging_1_1LogExtra.html#a9096585ca34496f56a977b1375e1976e" title="Adds a single key-value pair.">Extend</a>(<span class="stringliteral">&quot;key&quot;</span>, <span class="stringliteral">&quot;value&quot;</span>);</div>
<div class="line">    <a class="code hl_define" href="../../dd/de6/universal_2include_2userver_2logging_2log_8hpp.html#a87d766158e3857c6aedba65e63f24d05" title="Evaluates a message and logs it to the default logger if its level is below or equal to logging::Leve...">LOG_INFO</a>() &lt;&lt; log_extra &lt;&lt; <span class="stringliteral">&quot;message&quot;</span>;</div>
</div><!-- fragment --><p>If the same fields must be added to each log in a code block, it is recommended to use <code><a class="el" href="../../d7/d1a/classtracing_1_1Span.html" title="Measures the execution time of the current code block, links it with the parent tracing::Spans and st...">tracing::Span</a></code>, which implicitly adds tags to the log.</p>
<h2><a class="anchor" id="autotoc_md373"></a>
Stacktrace</h2>
<p>Sometimes it is useful to write a full stacktrace to the log. Typical use case is for logging a "never should happen happened" situation. Use <code><a class="el" href="../../d3/df8/classlogging_1_1LogExtra.html#ae5c0ac15a20cf227500b750d8995d9ab" title="Creates a LogExtra with current thread&#39;s stacktrace if the logger log level is less or equal to DEBUG...">logging::LogExtra::Stacktrace()</a></code> for such cases:</p>
<div class="fragment"></div><!-- fragment --><p>Important: getting a text representation of a stacktrace is an <b>expensive operation</b>. In addition, the stacktrace itself increases the log record size several times. Therefore, you do not need to use a stack trace for all errors. Use it only when it is 100% useful for diagnostics and other diagnostic tools are ineffective.</p>
<h2><a class="anchor" id="autotoc_md374"></a>
Additional loggers</h2>
<p>You can create any number of additional loggers. All you need is to add them to your <code>logging.loggers</code> section of the static config (see <a class="el" href="../../d4/da4/classcomponents_1_1Logging.html" title="Logging component">components::Logging</a> for an example)</p>
<p>After that, you can get a logger in the code like this:</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span>&amp; logging_component =</div>
<div class="line">      context.FindComponent&lt;<a class="code hl_class" href="../../d4/da4/classcomponents_1_1Logging.html" title="Logging component">::components::Logging</a>&gt;();</div>
<div class="line">logging::LoggerPtr my_logger = logging_component.<a class="code hl_function" href="../../d4/da4/classcomponents_1_1Logging.html#a122224571a07513cfcb9c97c46a09aa9" title="Returns a logger by its name.">GetLogger</a>(<span class="stringliteral">&quot;my_logger_name&quot;</span>);</div>
</div><!-- fragment --><p>To write to such a logger, it is convenient to use <code>LOG_XXX_TO</code>, for example:</p>
<div class="fragment"><div class="line"><a class="code hl_define" href="../../dd/de6/universal_2include_2userver_2logging_2log_8hpp.html#ab345e5b461f76a41066557aa101c7074" title="Evaluates a message and logs it to the logger if its level is below or equal to logging::Level::kInfo...">LOG_INFO_TO</a>(*my_logger) &lt;&lt; <span class="stringliteral">&quot;Look, I am a new logger!&quot;</span>;</div>
</div><!-- fragment --><p>Note: do not forget to configure the logrotate for your new log file!</p>
<h1><a class="anchor" id="autotoc_md375"></a>
Tracing</h1>
<p>The userver implements a request tracing mechanism that is compatible with the <a href="https://opentelemetry.io/docs/">opentelemetry</a> standard.</p>
<p>It allows you to save dependencies between tasks, between requests through several services, thereby building a trace of requests and interactions. It can be used to identify slow query stages, bottlenecks, sequential queries, etc.</p>
<p>See <a class="el" href="../../da/d25/classtracing_1_1DefaultTracingManagerLocator.html" title="Component that provides access to the actual TracingManager that is used in handlers and clients.">tracing::DefaultTracingManagerLocator</a> for more info.</p>
<h2><a class="anchor" id="autotoc_md376"></a>
tracing::Span</h2>
<p>When processing a request, you can create a <code>tracking::Span</code> object that measures the execution time of the current code block (technically, the time between its constructor and destructor) and stores the resulting time in the log:</p>
<p>Example log <code><a class="el" href="../../d7/d1a/classtracing_1_1Span.html" title="Measures the execution time of the current code block, links it with the parent tracing::Spans and st...">tracing::Span</a> span("cache_invalidate")</code>:</p>
<div class="fragment"><div class="line">tskv  timestamp=2018-12-04T14:00:35.303132  timezone=+03:00 level=INFO  module=~Impl ( userver/src/tracing/span.cpp:76 )  task_id=140572868354752 coro_id=140579682340544 text= trace_id=672a081c8004409ca79d5cc05cb5e580 span_id=12ff00c63bcc46599741bab62506881c  parent_id=7a7c1c6999094d2a8e3d22bc6ecf5d70  stopwatch_name=cache_invalidate start_timestamp=1543921235.301035 total_time=2.08675  span_ref_type=child stopwatch_units=ms</div>
</div><!-- fragment --><p>Log record example for some <code>POST /v1/upload</code> handle:</p>
<div class="fragment"><div class="line">tskv  timestamp=2020-08-13T15:30:52.507493  level=INFO  module=~Impl ( userver/core/src/tracing/span.cpp:139 )  task_id=7F110B765400  thread_id=0x00007F115BDEE700  text= stopwatch_name=http/handler-v1_upload-post  total_time=36.393694  span_ref_type=child stopwatch_units=ms  start_timestamp=1597321852.471086 meta_type=/v1/upload  _type=response  method=POST body={&quot;status&quot;:&quot;ok&quot;}  uri=/v1/upload?provider_id=driver-metrics http_handle_request_time=36.277501  http_serialize_response_data_time=0.003394  tags_cache_mapping_time=0.018781  find_service_time=21.702876 http_parse_request_data_time=0.053233 http_check_auth_time=0.029809 http_check_ratelimit_time=0.000118  entities_cache_mapping_time=0.01037 register_request_time=0.819509  log_to_yt_time=0.047565 save_request_result_time=1.523389 upload_queries_time=5.179371  commit_time=4.11817 link=48e0029fc25e460880529b9d300967df parent_link=b1377a1b20384fe292fd77cb96b30121  source_service=driver-metrics entity_type=udid  merge_policy=append provider_name=driver-metrics  tags_count_append=3 meta_code=200 trace_id=2f6bf12265934260876a236c373b37dc span_id=8f828566189db0d0  parent_id=fdae1985431a6a57</div>
</div><!-- fragment --><p><code><a class="el" href="../../d7/d1a/classtracing_1_1Span.html" title="Measures the execution time of the current code block, links it with the parent tracing::Spans and st...">tracing::Span</a></code> can only be created on stack. Currently, the ability to create <code><a class="el" href="../../d7/d1a/classtracing_1_1Span.html" title="Measures the execution time of the current code block, links it with the parent tracing::Spans and st...">tracing::Span</a></code> as a member of a class whose objects can be passed between tasks is not supported.</p>
<h2><a class="anchor" id="autotoc_md377"></a>
Tags</h2>
<p>In addition to <code>trace_id</code>, <code>span_id</code>, <code>parent_id</code> and other tags specific to opentracing, the <code><a class="el" href="../../d7/d1a/classtracing_1_1Span.html" title="Measures the execution time of the current code block, links it with the parent tracing::Spans and st...">tracing::Span</a></code> class can store arbitrary custom tags. To do this, Span implicitly contains LogExtra. You can add tags like this:</p>
<div class="fragment"><div class="line">        <a class="code hl_class" href="../../d7/d1a/classtracing_1_1Span.html" title="Measures the execution time of the current code block, links it with the parent tracing::Spans and st...">tracing::Span</a> span(<span class="stringliteral">&quot;big block&quot;</span>);</div>
<div class="line">        span.AddTag(<span class="stringliteral">&quot;tag&quot;</span>, <span class="stringliteral">&quot;simple tag that can be changed in subspan&quot;</span>);</div>
<div class="line">        span.AddTagFrozen(<span class="stringliteral">&quot;frozen&quot;</span>, <span class="stringliteral">&quot;it is not possible to change this tag value in subspan&quot;</span>);</div>
<div class="line">        span.AddNonInheritableTag(<span class="stringliteral">&quot;local&quot;</span>, <span class="stringliteral">&quot;this tag is not visible in subspans&quot;</span>);</div>
</div><!-- fragment --><p>Unlike simple <code>LogExtra</code>, tags from <code>Span</code> are automatically logged when using <code>LOG_XXX()</code>. If you create a <code>Span</code>, and you already have a <code>Span</code>, then <code>LogExtra</code> is copied from the old one to the new one (except for the tags added via <code>AddNonInheritableTag</code>).</p>
<h2><a class="anchor" id="autotoc_md378"></a>
Built-in tag semantics</h2>
<ul>
<li><code>TraceId</code> propagates both to sub-spans within a single service, and from client to server</li>
<li><code>Link</code> propagates within a single service, but not from client to server. A new link is generated for the "root" request handling task</li>
<li><code>SpanId</code> identifies a specific span. It does not propagate</li>
<li>For "root" request handling spans, there are additionally:<ul>
<li><code>ParentSpanId</code>, which is the inner-most <code>SpanId</code> of the client</li>
<li><code>ParentLink</code>, which is the <code>Link</code> of the client</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md379"></a>
Span hierarchy and logging</h2>
<p>All logs in the current task are implicitly linked to the current <code>Span</code> for the user, and tags of this <code>Span</code> are added to them (trace_id, span_id, etc.). All <code>Span</code> in the current task are implicitly stacked, and if there are several similar <code>Span</code>, the last created One (i.e., located at the top of the <code>Span</code> stack of the current task) will be used for logging.</p>
<div class="fragment"><div class="line">        <a class="code hl_class" href="../../d7/d1a/classtracing_1_1Span.html" title="Measures the execution time of the current code block, links it with the parent tracing::Spans and st...">tracing::Span</a> span(<span class="stringliteral">&quot;big block&quot;</span>);</div>
<div class="line">        span.AddTag(<span class="stringliteral">&quot;city&quot;</span>, <span class="stringliteral">&quot;moscow&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <a class="code hl_define" href="../../dd/de6/universal_2include_2userver_2logging_2log_8hpp.html#a87d766158e3857c6aedba65e63f24d05" title="Evaluates a message and logs it to the default logger if its level is below or equal to logging::Leve...">LOG_INFO</a>() &lt;&lt; <span class="stringliteral">&quot;User &quot;</span> &lt;&lt; user &lt;&lt; <span class="stringliteral">&quot; logged in&quot;</span>;  <span class="comment">// logs &quot;city&quot; tag</span></div>
<div class="line"> </div>
<div class="line">        {</div>
<div class="line">            <a class="code hl_class" href="../../d7/d1a/classtracing_1_1Span.html" title="Measures the execution time of the current code block, links it with the parent tracing::Spans and st...">tracing::Span</a> span_local(<span class="stringliteral">&quot;small block&quot;</span>);</div>
<div class="line">            span_local.AddTag(<span class="stringliteral">&quot;request_id&quot;</span>, 12345);</div>
<div class="line"> </div>
<div class="line">            <a class="code hl_define" href="../../dd/de6/universal_2include_2userver_2logging_2log_8hpp.html#a87d766158e3857c6aedba65e63f24d05" title="Evaluates a message and logs it to the default logger if its level is below or equal to logging::Leve...">LOG_INFO</a>() &lt;&lt; <span class="stringliteral">&quot;Making request&quot;</span>;  <span class="comment">// logs &quot;city&quot;, &quot;request_id&quot; tags</span></div>
<div class="line">        }</div>
<div class="line">        <a class="code hl_define" href="../../dd/de6/universal_2include_2userver_2logging_2log_8hpp.html#a87d766158e3857c6aedba65e63f24d05" title="Evaluates a message and logs it to the default logger if its level is below or equal to logging::Leve...">LOG_INFO</a>() &lt;&lt; <span class="stringliteral">&quot;After request&quot;</span>;  <span class="comment">// logs &quot;city&quot;, no &quot;request_id&quot;</span></div>
</div><!-- fragment --><p>If you want to get the current <code>Span</code> (for example, you want to write something to <code>LogExtra</code>, but do not want to create an additional <code>Span</code>), then you can use the following approach:</p>
<div class="fragment"><div class="line"> </div>
<div class="line">        <a class="code hl_function" href="../../d7/d1a/classtracing_1_1Span.html#aba13e9517b52eecb30cd30320f82b32d" title="Returns the Span of the current task.">tracing::Span::CurrentSpan</a>().<a class="code hl_function" href="../../d7/d1a/classtracing_1_1Span.html#a6fd6cdf27349f68ee5995b8db7e511bc">AddTag</a>(<span class="stringliteral">&quot;key&quot;</span>, <span class="stringliteral">&quot;value&quot;</span>);</div>
<div class="line"> </div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md380"></a>
Creating a Span</h2>
<p>A <code>Span</code> is automatically created for each request, handled by the <a class="el" href="../../d6/d36/classserver_1_1handlers_1_1HttpHandlerBase.html" title="Base class for all the Userver HTTP Handlers.">server::handlers::HttpHandlerBase</a> inherited handles. <code>trace_id</code>, <code>parent_id</code> and <code>link</code> are automatically populated for the request headers (if any).</p>
<p>Cache handlers do not have a parent Span, so a Span without a parent is automatically created for them, with a new <code>trace_id</code> for each update. The situation is similar for all <a class="el" href="../../d6/d10/classutils_1_1PeriodicTask.html" title="Task that periodically runs a user callback. Callback is started after the previous callback executio...">utils::PeriodicTask</a>.</p>
<p>When creating a new task via <code><a class="el" href="../../dc/db7/group__userver__concurrency.html#ga29b9a09eacda1ddf8b4440b3713f5e52" title="Starts an asynchronous task.">utils::Async</a></code>, a new <code>Span</code> is created and linked with the current <code>Span</code> of the current task.</p>
<p>DB drivers and the <a class="el" href="../../dd/d5a/classcomponents_1_1HttpClient.html" title="Component that manages clients::http::Client.">components::HttpClient</a> automatically create a Span for each request to trace them.</p>
<h2><a class="anchor" id="autotoc_md381"></a>
Linking service requests via X-YaRequestId, X-YaSpanId and X-YaTraceId</h2>
<p>The HTTP client sends the current link/span_id/trace_id values in each request to the server, they do not need to be specified.</p>
<p>When the HTTP server handles the request, it extracts data from the request headers and puts them in the Span.</p>
<p>Names of the headers varry depending on <a class="el" href="../../da/d25/classtracing_1_1DefaultTracingManagerLocator.html" title="Component that provides access to the actual TracingManager that is used in handlers and clients.">tracing::DefaultTracingManagerLocator</a> static configuration and on the chosen <a class="el" href="../../d2/de2/namespacetracing.html#a5ba2663318935bddc5a93c1e4fbbb10b">tracing::Format</a> value. For example, with <a class="el" href="../../d2/de2/namespacetracing.html#a5ba2663318935bddc5a93c1e4fbbb10ba3e513234ece4352e075a462b520a6f71">tracing::Format::kYandexTaxi</a> the following headers would be used:</p>
<div class="fragment"><div class="line">X-YaRequestId</div>
<div class="line">X-YaSpanId</div>
<div class="line">X-YaTraceId</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md382"></a>
Selectively disabling Span logging</h2>
<p>Using the server dynamic config <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html#USERVER_NO_LOG_SPANS">USERVER_NO_LOG_SPANS</a>, you can set names and prefixes of Span names that do not need to be logged. If the span is not logged, then the ScopeTime of this span and any custom tags attached to the span via the methods of the <code>Add*Tag*()</code> are not put into the logs.</p>
<p>For example, this is how you can disable logging of all Span for MongoDB (that is, all Span with <code>stopwatch_name</code> starting with <code>mongo</code>) and <code>Span</code> with <code>stopwatch_name=test</code>:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="stringliteral">&quot;names&quot;</span>: [</div>
<div class="line">      <span class="stringliteral">&quot;test&quot;</span></div>
<div class="line">  ],</div>
<div class="line">  <span class="stringliteral">&quot;prefixes&quot;</span>: [</div>
<div class="line">      <span class="stringliteral">&quot;mongo&quot;</span></div>
<div class="line">  ]</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="opentelemetry"></a></p>
<h1><a class="anchor" id="autotoc_md383"></a>
OpenTelemetry protocol</h1>
<p>It is possible to use OpenTelemetry protocol for logs and tracing exporting. To use it, register all prerequisites for gRPC client and register <code><a class="el" href="../../d3/d1e/classotlp_1_1LoggerComponent.html" title="Component to configure logging via OTLP collector.">otlp::LoggerComponent</a></code> in component list in your <code>main</code> function. The static config file should contain a component section with OTLP logger. Also remove <code>default</code> logger from <code>logging.loggers</code> as the default logger is handled by otlp component from now on.</p>
<p>The related part of static config:</p>
<div class="fragment"><div class="line">        otlp-logger:</div>
<div class="line">            endpoint: &#39;0.0.0.0:4317&#39;</div>
<div class="line">            service-name: otlp-example</div>
<div class="line">            log-level: debug</div>
<div class="line">            # How to rename attributes, if you really need to</div>
<div class="line">            attributes-mapping:</div>
<div class="line">                module: line</div>
</div><!-- fragment --><p><code>endpoint</code> contains OTLP collector host and port, <code>service-name</code> contains your service name, and <code>log-level</code> contains service log level.</p>
<p>After the service start you'll see the following in stderr:</p>
<div class="fragment"><div class="line">OTLP logger has started</div>
</div><!-- fragment --><p>It means the logger is successfully initialized and is ready to process the logs.</p>
<p>If somethings goes wrong (e.g. OTLP collector agent is not available), you'll see errors in stderr. The service buffers not-yet-sent logs and traces in memory, but drops them on overflow.</p>
<h2><a class="anchor" id="autotoc_md384"></a>
Separate Sinks for Logs and Tracing</h2>
<p>In certain environments, such as Kubernetes, applications typically write logs to stdout/stderr, while traces are sent efficiently through the 'push' model (via OTLP transport). Kubernetes stores the container's stdout/stderr in files on nodes, making logs available for log collectors using the 'pull' model. This approach ensures that logs remain accessible even if the application fails, capturing the most critical information.</p>
<p>To configure separate sinks for logs and traces, use the optional 'sinks' block in the 'otlp-logger' configuration:</p>
<div class="fragment"><div class="line">otlp-logger:</div>
<div class="line">    endpoint: $otlp-endpoint</div>
<div class="line">    service-name: $service-name</div>
<div class="line">    log-level: info    </div>
<div class="line">    sinks:</div>
<div class="line">        logs: default | otlp | both</div>
<div class="line">        tracing: default | otlp | both</div>
</div><!-- fragment --><p>If the 'sinks' block is not present in the 'otlp-logger' configuration, both logs and traces use the OTLP transport and are delivered to an OpenTelemetry-compatible collector by a background task in userver.</p>
<p>In the <code>sinks</code> block, you can set a value for each stream. See: <code><a class="el" href="../../d3/d1e/classotlp_1_1LoggerComponent.html" title="Component to configure logging via OTLP collector.">otlp::LoggerComponent</a></code>.</p>
<p>If you choose <code>otlp</code> for both streams, ensure that <code>logging.loggers</code> is empty:</p>
<div class="fragment"><div class="line">logging:</div>
<div class="line">    fs-task-processor: fs-task-processor</div>
<div class="line">    loggers: {}</div>
</div><!-- fragment --><p>Otherwise, add the <em>default</em> logger in the <code>logging</code> component's <code>loggers</code> field:</p>
<div class="fragment"><div class="line">logging:</div>
<div class="line">    fs-task-processor: fs-task-processor</div>
<div class="line">    loggers: </div>
<div class="line">        default:</div>
<div class="line">            file_path: $log-location </div>
<div class="line">            level: info</div>
<div class="line">            overflow_behavior: discard</div>
<div class="line">        my_rabbit_logger: # you can use additional loggers</div>
<div class="line">            file_path: $log-location                     </div>
<div class="line">            level: error</div>
<div class="line">            overflow_behavior: discard               </div>
</div><!-- fragment --><p><b>Note:</b> If you have additional loggers configured, they will function as usual, even if you're using the default logger for tracing only. But you can't redirect them to OTLP exporter.</p>
<hr  />
<p> <div class="bottom-nav">  ⇦ <a class="el" href="../../d8/d43/md_en_2userver_2chaotic.html">JSON schema codegen - the Chaotic</a> | <a class="el" href="../../db/d90/md_en_2userver_2task__processors__guide.html">Guide on TaskProcessor Usage</a> ⇨  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:55:59 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
