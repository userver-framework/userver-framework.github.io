<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: Redis</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dd/dde/md_en_2userver_2redis.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Redis</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md476"></a> <b>Quality:</b> <a class="el" href="../../db/d57/md_en_2userver_2development_2stability.html#QUALITY_TIERS">Platinum Tier</a>.</p>
<p>The redis asynchronous driver provides an interface to work with Redis standalone instances, as well as Redis Sentinels and Clusters.</p>
<p>Take note that Redis is not able to guarantee a strong consistency. It is possible for Redis to lose writes that were acknowledged, and vice versa.</p>
<h1><a class="anchor" id="autotoc_md477"></a>
Main features</h1>
<ul>
<li>Convenient methods for Redis commands returning proper C++ types</li>
<li>Support for bulk operations (MGET, MSET, etc). Driver splits data into smaller chunks if necessary to increase server responsiveness</li>
<li>Support for different strategies of choosing the most suitable Redis instance</li>
<li>Request timeouts management with transparent retries</li>
<li>TLS connections support</li>
<li><a class="el" href="../../d6/d64/md_en_2userver_2deadline__propagation.html">Deadline propagation</a></li>
<li>Cluster autotopology</li>
</ul>
<h1><a class="anchor" id="autotoc_md478"></a>
Redis Guarantees</h1>
<p>Redis is not a reliable database by design. In case of problems on the server side, partial or complete loss of data is possible. When a master migrates, the entire Redis cluster may become unavailable for several tens of seconds. The specific latency value should be determined for each Redis configuration separately (depending on the size of the database, server location, etc.).</p>
<p>Every command that is sent to the server has the potential to fail. Moreover, the client may receive error information (for example, a timeout), but the command on the server may succeed. Therefore, Redis commands should be idemponent. If this is not possible for some reason, then care should be taken to ensure that incomplete groups of commands/resent commands do not leave the database in an inconsistent state.</p>
<p>Redis command has a timeout, number of replays, and a global timeout. If a response is not received from the server within the timeout, then the same command is sent to another server in the cluster, and so on either until the limit on the number of repetitions is reached, or when the global timeout is reached. These settings can be changed via <a class="el" href="../../d2/ded/structredis_1_1CommandControl.html" title="Redis command execution options.">redis::CommandControl</a>.</p>
<dl class="section warning"><dt>Warning</dt><dd>For the above reasons, it is recommended to prefer PostgreSQL database over Redis. However it is fine to use Redis as a distributed cache.</dd></dl>
<h1><a class="anchor" id="autotoc_md479"></a>
Metrics</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Metric name   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">redis.instances_count   </td><td class="markdownTableBodyNone">current number of Redis instances    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">redis.last_ping_ms   </td><td class="markdownTableBodyNone">last measured ping value    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">redis.is_ready   </td><td class="markdownTableBodyNone">1 if connected and ready, 0 otherwise    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">redis.not_ready_ms   </td><td class="markdownTableBodyNone">milliseconds since last ready status    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">redis.reconnects   </td><td class="markdownTableBodyNone">reconnect counter    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">redis.session-time-ms   </td><td class="markdownTableBodyNone">milliseconds since connected to instance    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">redis.timings   </td><td class="markdownTableBodyNone">query timings    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">redis.errors   </td><td class="markdownTableBodyNone">counter of failed requests   </td></tr>
</table>
<p>See <a class="el" href="../../d9/dac/md_en_2userver_2service__monitor.html">Service Statistics and Metrics (Prometheus/Graphite/...)</a> for info on how to get the metrics.</p>
<h1><a class="anchor" id="autotoc_md480"></a>
Usage</h1>
<p>To use Redis you must add the component <a class="el" href="../../d6/dd0/classcomponents_1_1Redis.html" title="Redis client component.">components::Redis</a> and configure it according to the documentation. After that you can make requests via <a class="el" href="../../d4/da0/classstorages_1_1redis_1_1Client.html" title="Redis client.">storages::redis::Client</a>:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> RedisClientSampleUsage(<a class="code hl_class" href="../../d4/da0/classstorages_1_1redis_1_1Client.html" title="Redis client.">storages::redis::Client</a>&amp; client) {</div>
<div class="line">    client.Rpush(<span class="stringliteral">&quot;sample_list&quot;</span>, <span class="stringliteral">&quot;a&quot;</span>, {}).Get();</div>
<div class="line">    client.Rpush(<span class="stringliteral">&quot;sample_list&quot;</span>, <span class="stringliteral">&quot;b&quot;</span>, {}).Get();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> length = client.Llen(<span class="stringliteral">&quot;sample_list&quot;</span>, {}).Get();</div>
<div class="line"> </div>
<div class="line">    EXPECT_EQ(length, 2);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md481"></a>
Timeouts</h2>
<p>Request timeout can be set for a single request via <a class="el" href="../../d2/ded/structredis_1_1CommandControl.html" title="Redis command execution options.">redis::CommandControl</a> argument.</p>
<p>Dynamic option <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html#REDIS_DEFAULT_COMMAND_CONTROL">REDIS_DEFAULT_COMMAND_CONTROL</a> can be used to set default values.</p>
<p>To interrupt a request on the client side, you can use <a class="el" href="../../d8/d00/md_en_2userver_2intro.html#task_cancellation_intro">cancellation mechanism</a> to cancel the task that executes the Redis request:</p>
<div class="fragment"><div class="line">std::optional&lt;std::string&gt; RedisClientCancelRequest(<a class="code hl_class" href="../../d4/da0/classstorages_1_1redis_1_1Client.html" title="Redis client.">storages::redis::Client</a>&amp; client) {</div>
<div class="line">    <span class="keyword">auto</span> result = client.Get(<span class="stringliteral">&quot;foo&quot;</span>, {});</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="../../d2/d64/namespaceengine_1_1current__task.html#a122addf573e8582b0d8a84412eb34672" title="Return cancellation token for current coroutine.">engine::current_task::GetCancellationToken</a>().<a class="code hl_function" href="../../d0/db5/classengine_1_1TaskCancellationToken.html#a90e81f52d5405c03a346144850786cc5">RequestCancel</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Throws redis::RequestCancelledException if Redis was not</span></div>
<div class="line">    <span class="comment">// fast enough to answer</span></div>
<div class="line">    <span class="keywordflow">return</span> result.Get();</div>
<div class="line">}</div>
</div><!-- fragment --><p>Redis driver does not guarantee that the cancelled request was not executed by the server.</p>
<h2><a class="anchor" id="autotoc_md482"></a>
Redis Cluster Autotopology</h2>
<p>Cluster autotopology makes it possible to do resharding of the cluster without Secdist changes and service restart.</p>
<p>With this feature entries in the Secdist are now treated not as a list of all the cluster hosts, but only as input points through which the service discowers the configuration of the entire cluster. Therefore, it is not recommended to delete instances that are listed in secdist from the cluster.</p>
<p>The cluster configuration is checked</p><ul>
<li>at the start of the service</li>
<li>and periodically</li>
<li>and if a MOVED response is received from Redis</li>
</ul>
<p>If a change in the cluster topology was detected during the check (hashslot distribution change, master change, or new replicas discowered), then the internal representation of the topology is recreated, the new topology is gets ready (new connections may appear in it), and after that the active topology is replaced.</p>
<hr  />
<p> <div class="bottom-nav">  ⇦ <a class="el" href="../../d7/d65/md_en_2userver_2mongodb.html">MongoDB</a> | <a class="el" href="../../dd/ddb/clickhouse_driver.html">ClickHouse Driver</a> ⇨  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:56:00 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
