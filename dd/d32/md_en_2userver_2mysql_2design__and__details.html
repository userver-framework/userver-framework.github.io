<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: MySQL driver design and implementation details</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dd/d32/md_en_2userver_2mysql_2design__and__details.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">MySQL driver design and implementation details</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md407"></a> </p>
<h2><a class="anchor" id="autotoc_md408"></a>
Driver Architecture</h2>
<p>Like most drivers in üêô <b>userver</b> the uMySQL driver consists of three logically separate layers:</p><ol type="1">
<li>User-facing side - component, client interface, result types etc..</li>
<li>Driver infrastructure - topology, connections pools, some helpers/wrappers, configs/logging/metrics and so on</li>
<li>The communication layer, which is responsible for an actual interaction with a service a driver is built for (MySQL/MariaDB in our case)</li>
</ol>
<p>Briefly, all these layers are glued like this:</p><ol type="1">
<li>User-facing layer takes an input from the user, converts it into some internal representation and asks the infrastructure layers to execute a request.</li>
<li>Infrastructure layer finds an appropriate connection and executes a request on it.</li>
<li>The communication layer, to which a connection belongs, converts internal representation acquired at step 1. into native representation, executes a request and converts native response into internal representation.</li>
<li>After infrastructure layer executed a request and returned, user-facing layer converts internal representation of a response into whatever user requested.</li>
</ol>
<p>There actually isn't that much to tell about infrastructure layer - it's just a bunch of connections pools, defined by topology, where every pool maintains some lockfree storage of connections and rents them to user-facing layer.</p>
<p>Communication layer and user-facing layer, however, are a different story, since they have to do some magic to not only make user types work out of the box, but also make containers of user types work seamlessly as well.</p>
<h2><a class="anchor" id="autotoc_md409"></a>
Welcome MYSQL_BIND</h2>
<p><code>MYSQL_BIND</code> is a structure used by mariadbclient and mysqlclient for binding prepared statement parameters/result from/to <code>C</code> types. When a statement is executed for every parameter marker in it mariadbclient (we'll only talk about mariadbclient here, since that is what driver uses) feeds the data from corresponding <code>MYSQL_BIND</code> to a server, and when a statement execution results are fetched from the server mariadbclient populates <code>MYSQL_BIND</code> with data.</p>
<p>These processes are different, and we'll talk about input/output parts separately.</p>
<p>For input parameters binding <code>MYSQL_BIND</code> resembles to this: </p><div class="fragment"><div class="line">struct MYSQL_BIND {</div>
<div class="line">    enum_field_types buffer_type;</div>
<div class="line">    void* buffer;</div>
<div class="line">    unsigned long buffer_length;</div>
<div class="line">};</div>
</div><!-- fragment --><p> which is self-explanatory; <br  />
</p><ul>
<li>to bind a not engaged optional one should set <code>buffer_type</code> to <code>MYSQL_TYPE_NULL</code></li>
<li>to bind an <code>int a</code> one should set <code>buffer_type</code> to <code>MYSQL_TYPE_LONG</code> and <code>buffer</code> to <code>&amp;a</code>, <br  />
</li>
<li>to bind a <code>std::string str</code> one should set <code>buffer_type</code> to <code>MYSQL_TYPE_STRING</code> and <code>buffer/buffer_length</code> to <code>str.data()/str.size()</code> accordingly</li>
<li>...</li>
</ul>
<p>you get the idea. For types that have no corresponding counterpart (say, <code>std::chrono::...</code> or <code>userver::formats::json::Value</code>) one should first serialize them to something mariadbclient understands and bind that serialized representation.</p>
<p>This is cool and all, and it should be pretty straightforward by now how to specialize some templates for selected subset of types (ints, strings and so on) for binding, but how does one make it work with unknown upfront user-defined aggregates?</p>
<h2><a class="anchor" id="autotoc_md410"></a>
Welcome boost::pfr</h2>
<p>And this is <code>some magic</code> part. By none other than lead maintainer of userver Antony Polukhin himself, <code>boost::pfr</code> library is <code>std::tuple like methods for user defined types without any macro or boilerplate code</code>, which allows one to do this: </p><div class="fragment"><div class="line">struct MyAggregate final {</div>
<div class="line">   ...</div>
<div class="line">};</div>
<div class="line">constexpr auto fields_count = boost::pfr::tuple_size_v&lt;MyAggregate&gt;;</div>
<div class="line">boost::pfr::for_each_field(MyAggregate{}, [](auto&amp;&amp; field) {});</div>
</div><!-- fragment --><p> It has some limitations but in general "just works", and with it the driver can</p><ol type="1">
<li>Initialize an array of <code>MYSQL_BIND</code> of size needed</li>
<li>For every field <code>F</code> of an aggregate <code>T</code> find an appropriate bind function</li>
<li>Bind the value of <code>F</code> into corresponding MYSQL_BIND</li>
</ol>
<p>C++ templates are something else indeed.</p>
<h2><a class="anchor" id="autotoc_md411"></a>
Batched INSERT</h2>
<p>MariaDB 10.2.6+ supports batched inserts and mariadbclient also supports it (in general it supports an array or params in prepared statement), as one could expect.</p>
<p>The API is pretty straightforward:</p>
<p>Generate some binds, set <code>STMT_ATTR_ARRAY_SIZE</code> to specify amount of rows, set <code>STMT_ATTR_ROW_SIZE</code> to specify a row size, so mariadbclient can do its pointers arithmetic, and you are good to... Hold up.</p>
<p><code>Pointers arithmetic</code>, right, that's the catch. Mariadbclient being <code>C</code> library expects (and rightfully so) user data to be a <code>C</code> struct as well, and API expects an array of these structs to be contiguous in memory, so it can add <code>STMT_ATTR_ROW_SIZE</code> to <code>MYSQL_BIND.buffer</code> go get the field buffer of the next row.</p>
<p>We could generate a <code>std::vector</code> of tuples of conforming <code>C</code> types, but that is a potentially heavy allocations and a lot of difficult to understand metaprogramming, and turns out there is a better way: <code>STMT_ATTR_CB_PARAM</code>.</p>
<p>This is an undocumented feature (<a href="https://jira.mariadb.org/browse/CONC-348">https://jira.mariadb.org/browse/CONC-348</a>) and is used in only 2 repositories across all the github (guess where, <code>mariadb-connector-c++</code> and <code>mariadb-connector-python</code>), but it's there since Dec 3, 2018 therefore i consider it stable enough.<br  />
 Basically it allows one to specify a callback which will be called before mariadbclient copies data from MYSQL_BIND into its internals, and with it instead of transforming user container into <code>std::vector</code> we can maintain a mere iterator of that user container, and when prebind callback fires just populate the binds and advance the iterator. <br  />
 Voila, no heavy metaprogramming (to transform user type into tuple of <code>C</code> types), no intermediate allocations; a thing of beauty IMO.</p>
<h2><a class="anchor" id="autotoc_md412"></a>
Results extraction</h2>
<p>The part responsible for that <code>.AsVector&lt;T&gt;</code> API. Uses the same machinery with <code>boost::pfr</code>, but binding is done differently: you see, for input params we already know all the things necessary - whether an <code>std::optional</code> contains a value, what is the length of <code>std::string</code> we are binding etc. - but for output we don't before the data is actually fetched; luckily <code>MYSQL_BIND</code> has us covered.</p>
<p>For output fields <code>MYSQL_BIND</code> resembles to this: </p><div class="fragment"><div class="line">struct MYSQL_BIND {</div>
<div class="line">    enum_field_types buffer_type;</div>
<div class="line">    void* buffer;</div>
<div class="line">    unsigned long buffer_length;</div>
<div class="line">    unsigned long* length;</div>
<div class="line">    bool is_null_value;</div>
<div class="line">    bool* is_null;</div>
<div class="line">};</div>
</div><!-- fragment --><p> When initializing a bind for an output field one can set <code>length</code> to <code>&amp;buffer_length</code> and <code>is_null</code> to <code>&amp;is_null_value</code>, and then follow this process:</p><ol type="1">
<li>Try to fetch another row from the result (we buffer the whole result on a client in most cases, so that doesn't do any I/O).</li>
<li>If that returns <code>MYSQL_NO_DATA</code> we are done.</li>
<li>At this point mariadbclient updated the pointers we supplied into bind ( but didn't pull any data into it just yet) so we know whether a field is a NULL or not and of what length its buffer is, so we fix the bind and the user type associated with it accordingly: call <code>.resize</code> for strings, <code>.emplace</code> for optionals, allocate intermediate buffers if needed (there are some type, say, <code>userver::formats::json::Value</code> for which we can't just <code>.resize()</code>).</li>
<li>For every column we fetch the data into corresponding bind.</li>
<li>For every column that needs an intermediate buffer we deserialize the user type from that buffer.</li>
</ol>
<p>There is a funny catch tho - mariadbclient completely disregards <code>buffer</code> being nullptr for numeric types and just writes into it if a value is present in DB, so for optionals of numeric types we <code>.emplace()</code> them at bind stage and <code>.reset()</code> at fetch stage if null.</p>
<p>User types are created and stored in container in user-facing layer, which implements <code>AsContainer&lt;Container&gt;</code> like this:</p><ol type="1">
<li>Create a <code>Container::value_type{}</code>.</li>
<li>Bind that newly created instance into output binds via <code>boost::pfr</code>.</li>
<li>Try to fetch the next row of data, and stop if there aren't any.</li>
<li>Emplace the fetched <code>Container::value_type</code> instance into result <code>Container</code> and go to step 1.</li>
</ol>
<p>There are some optimizations implemented:</p><ul>
<li>we don't have to create a <code>T</code> on stack and then move it into vector, we can just <code>.emplace()</code> into vector and operate on its <code>.back()</code>; but since that doesn't work in general (say, <code>unordered_set</code>), we only do that for white-listed types.</li>
<li>we don't have to call <code>mysql_stmt_bind_result</code> for every new row - it copies all the binds supplied, which is 112 bytes per bind, and is a huge overhead, - we can just reuse the binds mariadbclient has copied after first call. There is no API to extract them (but a field is there and <code>C</code> structs aren't that private) so strictly speaking it might break one day... but likely won't. <a href="https://jira.mariadb.org/browse/CONC-620">https://jira.mariadb.org/browse/CONC-620</a></li>
<li>we don't have to fetch a column again if the initial row-wide fetch for that column succeeded.</li>
</ul>
<hr  />
<p> <div class="bottom-nav">  ‚á¶ <a class="el" href="../../d2/d0a/md_en_2userver_2mysql_2supported__types.html">MySQL supported types</a> | <a class="el" href="../../d0/db8/md_en_2userver_2kafka.html">Apache Kafka</a> ‚á®  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:55:59 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
