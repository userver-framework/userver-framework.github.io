<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: Custom Authorization/Authentication via PostgreSQL</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('da/d24/md_en_2userver_2tutorial_2auth__postgres.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Custom Authorization/Authentication via PostgreSQL</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md584"></a> </p>
<h1><a class="anchor" id="autotoc_md585"></a>
Before you start</h1>
<p>Make sure that you can compile and run core tests and read a basic example <a class="el" href="../../da/d16/md_en_2userver_2tutorial_2hello__service.html">Writing your first HTTP server</a>.</p>
<h1><a class="anchor" id="autotoc_md586"></a>
Step by step guide</h1>
<p>This tutorial shows how to create a custom authorization check by tokens with scopes for HTTP handlers. Required scopes are specified in static configuration file for each HTTP handler. In the tutorial the authorization data is cached in <a class="el" href="../../d2/d8d/classcomponents_1_1PostgreCache.html" title="Caching component for PostgreSQL. See Caching Component for PostgreSQL.">components::PostgreCache</a>, and information of an authorized user (it's name) is passed to the HTTP handler.</p>
<p>Creation of tokens and user registration is out of scope of this tutorial.</p>
<dl class="section warning"><dt>Warning</dt><dd>Authorization scheme from this sample is vulnerable to the MITM-attack unless you are using a secure connection (HTTPS).</dd></dl>
<h2><a class="anchor" id="autotoc_md587"></a>
PostgreSQL Cache</h2>
<p>Let's make a table to store users data:</p>
<div class="fragment"><div class="line">V001__create_db.sql</div>
<div class="line">V002__add_name.sql</div>
</div><!-- fragment --> <div class="fragment"><div class="line"><span class="keyword">DROP</span> SCHEMA <span class="keywordflow">IF</span> <span class="keyword">EXISTS</span> auth_schema CASCADE;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">CREATE</span> SCHEMA <span class="keywordflow">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> auth_schema;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keywordflow">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> auth_schema.tokens (</div>
<div class="line">    token TEXT <span class="keyword">PRIMARY</span> KEY <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">    user_id <span class="keywordtype">INTEGER</span> <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">    scopes TEXT[] <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">    updated TIMESTAMPTZ <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> <span class="keyword">DEFAULT</span> NOW()</div>
<div class="line">);</div>
</div><!-- fragment --> <div class="fragment"><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> auth_schema.tokens</div>
<div class="line">    <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> name TEXT <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>;</div>
</div><!-- fragment --><p>Authorization data is rarely changed and often queried. Caching it would improve response times:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../dc/df7/base__postgres__cache_8hpp.html" title="Caching component for PostgreSQL. See Caching Component for PostgreSQL.">userver/cache/base_postgres_cache.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../de/d55/algorithm_8hpp.html" title="Miscellaneous cryptographic routines.">userver/crypto/algorithm.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;userver/server/auth/user_auth_info.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d4/d90/array__types_8hpp.html" title="I/O support for arrays (std::array, std::set, std::unordered_set, std::vector)">userver/storages/postgres/io/array_types.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>samples::pg {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>UserDbInfo {</div>
<div class="line">    <a class="code hl_class" href="../../d4/d67/classutils_1_1StrongTypedef.html" title="Strong typedef for a type T.">server::auth::UserAuthInfo::Ticket</a> token;</div>
<div class="line">    std::int64_t user_id;</div>
<div class="line">    std::vector&lt;std::string&gt; scopes;</div>
<div class="line">    std::string name;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>AuthCachePolicy {</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> std::string_view kName = <span class="stringliteral">&quot;auth-pg-cache&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using </span>ValueType = UserDbInfo;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">auto</span> kKeyMember = &amp;UserDbInfo::token;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* kQuery = <span class="stringliteral">&quot;SELECT token, user_id, scopes, name FROM auth_schema.tokens&quot;</span>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* kUpdatedField = <span class="stringliteral">&quot;updated&quot;</span>;</div>
<div class="line">    <span class="keyword">using </span>UpdatedFieldType = <a class="code hl_struct" href="../../d7/dde/structstorages_1_1postgres_1_1TimePointTz.html" title="Corresponds to TIMESTAMP WITH TIME ZONE database type.">storages::postgres::TimePointTz</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Using crypto::algorithm::StringsEqualConstTimeComparator to avoid timing</span></div>
<div class="line">    <span class="comment">// attack at find(token).</span></div>
<div class="line">    <span class="keyword">using </span>CacheContainer = std::unordered_map&lt;</div>
<div class="line">        <a class="code hl_class" href="../../d4/d67/classutils_1_1StrongTypedef.html" title="Strong typedef for a type T.">server::auth::UserAuthInfo::Ticket</a>,</div>
<div class="line">        UserDbInfo,</div>
<div class="line">        std::hash&lt;server::auth::UserAuthInfo::Ticket&gt;,</div>
<div class="line">        <a class="code hl_struct" href="../../de/d55/structcrypto_1_1algorithm_1_1StringsEqualConstTimeComparator.html" title="Performs constant-time string comparison comparator.">crypto::algorithm::StringsEqualConstTimeComparator</a>&gt;;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">using </span>AuthCache = <a class="code hl_class" href="../../d2/d8d/classcomponents_1_1PostgreCache.html" title="Caching component for PostgreSQL. See Caching Component for PostgreSQL.">components::PostgreCache&lt;AuthCachePolicy&gt;</a>;</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace samples::pg</span></div>
</div><!-- fragment --><p>Cache configuration is straightforward:</p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        auth-database:</div>
<div class="line">            dbconnection: &#39;postgresql://testsuite@localhost:15433/postgres&#39;</div>
<div class="line">            blocking_task_processor: fs-task-processor</div>
<div class="line">            dns_resolver: async</div>
<div class="line"> </div>
<div class="line">        auth-pg-cache:</div>
<div class="line">            pgcomponent: auth-database</div>
<div class="line">            update-interval: 10s</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md588"></a>
Authorization Checker</h2>
<p>To implement an authorization checker derive from <a class="el" href="../../d6/db7/classserver_1_1handlers_1_1auth_1_1AuthCheckerBase.html">server::handlers::auth::AuthCheckerBase</a> and override the virtual functions:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;auth_bearer.hpp&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;user_info_cache.hpp&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;algorithm&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d8/d9f/common__headers_8hpp.html" title="Common HTTP header names.">userver/http/common_headers.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>samples::pg {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>AuthCheckerBearer final : <span class="keyword">public</span> <a class="code hl_class" href="../../d6/db7/classserver_1_1handlers_1_1auth_1_1AuthCheckerBase.html">server::handlers::auth::AuthCheckerBase</a> {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">using </span>AuthCheckResult = <a class="code hl_struct" href="../../dc/d67/structserver_1_1handlers_1_1auth_1_1AuthCheckResult.html">server::handlers::auth::AuthCheckResult</a>;</div>
<div class="line"> </div>
<div class="line">    AuthCheckerBearer(<span class="keyword">const</span> AuthCache&amp; auth_cache, std::vector&lt;server::auth::UserScope&gt; required_scopes)</div>
<div class="line">        : auth_cache_(auth_cache), required_scopes_(<a class="code hl_namespace" href="../../d8/dcc/namespacestd.html" title="STL namespace.">std</a>::move(required_scopes)) {}</div>
<div class="line"> </div>
<div class="line">    [[nodiscard]] AuthCheckResult CheckAuth(</div>
<div class="line">        <span class="keyword">const</span> <a class="code hl_class" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request,</div>
<div class="line">        <a class="code hl_class" href="../../de/df6/classserver_1_1request_1_1RequestContext.html" title="Stores request-specific data during request processing.">server::request::RequestContext</a>&amp; request_context</div>
<div class="line">    ) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">    [[nodiscard]] <span class="keywordtype">bool</span> SupportsUserAuth() const noexcept<span class="keyword"> override </span>{ <span class="keywordflow">return</span> <span class="keyword">true</span>; }</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">const</span> AuthCache&amp; auth_cache_;</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;server::auth::UserScope&gt; required_scopes_;</div>
<div class="line">};</div>
</div><!-- fragment --><p>The authorization should do the following steps:</p><ul>
<li>check for "Authorization" header, return 401 if it is missing; <div class="fragment"><div class="line">AuthCheckerBearer::AuthCheckResult AuthCheckerBearer::CheckAuth(</div>
<div class="line">    <span class="keyword">const</span> <a class="code hl_class" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request,</div>
<div class="line">    <a class="code hl_class" href="../../de/df6/classserver_1_1request_1_1RequestContext.html" title="Stores request-specific data during request processing.">server::request::RequestContext</a>&amp; request_context</div>
<div class="line">)<span class="keyword"> const </span>{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; auth_value = request.<a class="code hl_function" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#a1d035d2f00417e03b85dc75c3453f322">GetHeader</a>(http::headers::kAuthorization);</div>
<div class="line">    <span class="keywordflow">if</span> (auth_value.empty()) {</div>
<div class="line">        <span class="keywordflow">return</span> AuthCheckResult{</div>
<div class="line">            AuthCheckResult::Status::kTokenNotFound,</div>
<div class="line">            {},</div>
<div class="line">            <span class="stringliteral">&quot;Empty &#39;Authorization&#39; header&quot;</span>,</div>
<div class="line">            <a class="code hl_enumvalue" href="../../d2/d24/namespaceserver_1_1handlers.html#ab868a1e6cf573e2728f59d318078e265a33d340699b1cbd18c8c13a164502514a">server::handlers::HandlerErrorCode::kUnauthorized</a>};</div>
<div class="line">    }</div>
</div><!-- fragment --></li>
<li>check for "Authorization" header value to have <code>Bearer some-token</code> format, return 403 if it is not; <div class="fragment"><div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> bearer_sep_pos = auth_value.find(<span class="charliteral">&#39; &#39;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (bearer_sep_pos == std::string::npos || std::string_view{auth_value.data(), bearer_sep_pos} != <span class="stringliteral">&quot;Bearer&quot;</span>) {</div>
<div class="line">        <span class="keywordflow">return</span> AuthCheckResult{</div>
<div class="line">            AuthCheckResult::Status::kTokenNotFound,</div>
<div class="line">            {},</div>
<div class="line">            <span class="stringliteral">&quot;&#39;Authorization&#39; header should have &#39;Bearer some-token&#39; format&quot;</span>,</div>
<div class="line">            <a class="code hl_enumvalue" href="../../d2/d24/namespaceserver_1_1handlers.html#ab868a1e6cf573e2728f59d318078e265a33d340699b1cbd18c8c13a164502514a">server::handlers::HandlerErrorCode::kUnauthorized</a>};</div>
<div class="line">    }</div>
</div><!-- fragment --></li>
<li>check that the token is in the cache, return 403 if it is not; <div class="fragment"><div class="line">    <span class="keyword">const</span> <a class="code hl_class" href="../../d4/d67/classutils_1_1StrongTypedef.html" title="Strong typedef for a type T.">server::auth::UserAuthInfo::Ticket</a> token{auth_value.data() + bearer_sep_pos + 1};</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> cache_snapshot = auth_cache_.Get();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> it = cache_snapshot-&gt;find(token);</div>
<div class="line">    <span class="keywordflow">if</span> (it == cache_snapshot-&gt;end()) {</div>
<div class="line">        <span class="keywordflow">return</span> AuthCheckResult{AuthCheckResult::Status::kForbidden};</div>
<div class="line">    }</div>
</div><!-- fragment --></li>
<li>check that user has the required authorization scopes, return 403 if not; <div class="fragment"><div class="line">    <span class="keyword">const</span> UserDbInfo&amp; info = it-&gt;second;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; scope : required_scopes_) {</div>
<div class="line">        <span class="keywordflow">if</span> (std::find(info.scopes.begin(), info.scopes.end(), scope.GetValue()) == info.scopes.end()) {</div>
<div class="line">            <span class="keywordflow">return</span> AuthCheckResult{AuthCheckResult::Status::kForbidden, {}, <span class="stringliteral">&quot;No &#39;&quot;</span> + scope.GetValue() + <span class="stringliteral">&quot;&#39; permission&quot;</span>};</div>
<div class="line">        }</div>
<div class="line">    }</div>
</div><!-- fragment --></li>
<li>if everything is fine, then store user name in request context and proceed to HTTP handler logic. <div class="fragment"><div class="line">    request_context.<a class="code hl_function" href="../../de/df6/classserver_1_1request_1_1RequestContext.html#a9955afc9b9c100d5cb66dae5ac70b574" title="Stores the data with specified name if it was not previously stored in this.">SetData</a>(<span class="stringliteral">&quot;name&quot;</span>, info.name);</div>
<div class="line">    <span class="keywordflow">return</span> {};</div>
<div class="line">}</div>
</div><!-- fragment --></li>
</ul>
<dl class="section warning"><dt>Warning</dt><dd><code>CheckAuth</code> functions are invoked concurrently on the same instance of the class. In this sample the <code>AuthCheckerBearer</code> class only reads the class data. <a class="el" href="../../d6/d6c/md_en_2userver_2synchronization.html">synchronization primitives</a> should be used if data is mutated.</dd></dl>
<h2><a class="anchor" id="autotoc_md589"></a>
Authorization Factory</h2>
<p>Authorization checkers are produced by authorization factories derived from <a class="el" href="../../d1/d14/classserver_1_1handlers_1_1auth_1_1AuthCheckerFactoryBase.html" title="Base class for all the authorization factory checkers.">server::handlers::auth::AuthCheckerFactoryBase</a>:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../db/ddd/auth__checker__factory_8hpp.html" title="Authorization factory registration and base classes.">userver/server/handlers/auth/auth_checker_factory.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>samples::pg {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>CheckerFactory final : <span class="keyword">public</span> <a class="code hl_class" href="../../d1/d14/classserver_1_1handlers_1_1auth_1_1AuthCheckerFactoryBase.html" title="Base class for all the authorization factory checkers.">server::handlers::auth::AuthCheckerFactoryBase</a> {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    server::handlers::auth::AuthCheckerBasePtr</div>
<div class="line">    operator()(const ::components::ComponentContext&amp; context, <span class="keyword">const</span> <a class="code hl_class" href="../../d0/dd7/classserver_1_1handlers_1_1auth_1_1HandlerAuthConfig.html">server::handlers::auth::HandlerAuthConfig</a>&amp; auth_config, <span class="keyword">const</span> <a class="code hl_class" href="../../dd/d13/classserver_1_1handlers_1_1auth_1_1AuthCheckerSettings.html">server::handlers::auth::AuthCheckerSettings</a>&amp;)</div>
<div class="line">        <span class="keyword">const override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace samples::pg</span></div>
</div><!-- fragment --><p>Factories work with component system and parse handler-specific authorization configs:</p>
<div class="fragment"><div class="line">server::handlers::auth::AuthCheckerBasePtr CheckerFactory::</div>
<div class="line">operator()(const ::components::ComponentContext&amp; context, <span class="keyword">const</span> <a class="code hl_class" href="../../d0/dd7/classserver_1_1handlers_1_1auth_1_1HandlerAuthConfig.html">server::handlers::auth::HandlerAuthConfig</a>&amp; auth_config, <span class="keyword">const</span> <a class="code hl_class" href="../../dd/d13/classserver_1_1handlers_1_1auth_1_1AuthCheckerSettings.html">server::handlers::auth::AuthCheckerSettings</a>&amp;)<span class="keyword"></span></div>
<div class="line"><span class="keyword">    const </span>{</div>
<div class="line">    <span class="keyword">auto</span> scopes = auth_config[<span class="stringliteral">&quot;scopes&quot;</span>].<a class="code hl_function" href="../../d3/d6c/classyaml__config_1_1YamlConfig.html#a64c0d693118c8a737838bd9acb671069" title="Returns value of *this converted to T.">As</a>&lt;server::auth::UserScopes&gt;({});</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; auth_cache = context.FindComponent&lt;AuthCache&gt;();</div>
<div class="line">    <span class="keywordflow">return</span> std::make_shared&lt;AuthCheckerBearer&gt;(auth_cache, std::move(scopes));</div>
<div class="line">}</div>
</div><!-- fragment --><p>Each factory should be registered at the beginning of the <code>main()</code> function via <a class="el" href="../../db/ddd/auth__checker__factory_8hpp.html#a5f3f5ac8e60196eed6b151a6ef154e5d" title="Function to call from main() to register an authorization checker.">server::handlers::auth::RegisterAuthCheckerFactory</a> function call:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span>* <span class="keyword">const</span> argv[]) {</div>
<div class="line">    <a class="code hl_function" href="../../db/ddd/auth__checker__factory_8hpp.html#a5f3f5ac8e60196eed6b151a6ef154e5d" title="Function to call from main() to register an authorization checker.">server::handlers::auth::RegisterAuthCheckerFactory</a>(<span class="stringliteral">&quot;bearer&quot;</span>, std::make_unique&lt;samples::pg::CheckerFactory&gt;());</div>
</div><!-- fragment --><p>That factory is invoked on each HTTP handler with the matching authorization type:</p>
<div class="fragment"><div class="line">        # yaml</div>
<div class="line">        handler-hello:</div>
<div class="line">            path: /v1/hello</div>
<div class="line">            task_processor: main-task-processor</div>
<div class="line">            method: GET</div>
<div class="line">            auth:           # Authorization config for this handler</div>
<div class="line">                types:</div>
<div class="line">                  - bearer  # Authorization type that was specified in main()</div>
<div class="line">                scopes:     # Required user scopes for that handler</div>
<div class="line">                  - read</div>
<div class="line">                  - hello</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md590"></a>
Request Context</h2>
<p>Data that was set by authorization checker could be retrieved by handler from <a class="el" href="../../de/df6/classserver_1_1request_1_1RequestContext.html" title="Stores request-specific data during request processing.">server::request::RequestContext</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>Hello final : <span class="keyword">public</span> <a class="code hl_class" href="../../d6/d36/classserver_1_1handlers_1_1HttpHandlerBase.html" title="Base class for all the Userver HTTP Handlers.">server::handlers::HttpHandlerBase</a> {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> std::string_view kName = <span class="stringliteral">&quot;handler-hello&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using </span>HttpHandlerBase::HttpHandlerBase;</div>
<div class="line"> </div>
<div class="line">    std::string HandleRequestThrow(<span class="keyword">const</span> <a class="code hl_class" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request, <a class="code hl_class" href="../../de/df6/classserver_1_1request_1_1RequestContext.html" title="Stores request-specific data during request processing.">server::request::RequestContext</a>&amp; ctx)<span class="keyword"></span></div>
<div class="line"><span class="keyword">        const override </span>{</div>
<div class="line">        request.<a class="code hl_function" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#a2434ed4270f909f1b74224fbc4196aed" title="Returns a container that should be filled with response data to this request.">GetHttpResponse</a>().<a class="code hl_function" href="../../da/da4/classserver_1_1http_1_1HttpResponse.html#a65a1797ad369c166546a22ffaaab0d53" title="Add or rewrite the Content-Type header.">SetContentType</a>(http::content_type::kTextPlain);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;Hello world, &quot;</span> + ctx.<a class="code hl_function" href="../../de/df6/classserver_1_1request_1_1RequestContext.html#ad0398002747ed1431274599be93123d2">GetData</a>&lt;std::string&gt;(<span class="stringliteral">&quot;name&quot;</span>) + <span class="stringliteral">&quot;!\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md591"></a>
int main()</h2>
<p>Aside from calling <a class="el" href="../../db/ddd/auth__checker__factory_8hpp.html#a5f3f5ac8e60196eed6b151a6ef154e5d" title="Function to call from main() to register an authorization checker.">server::handlers::auth::RegisterAuthCheckerFactory</a> for authorization factory registration, the <code>main()</code> function should also construct the component list and start the daemon:</p>
<div class="fragment"><div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> component_list = <a class="code hl_function" href="../../dd/d1c/group__userver__components.html#ga44510c5120b67bd36f0ff9f845c68280" title="Returns a list of components to start a basic HTTP server.">components::MinimalServerComponentList</a>()</div>
<div class="line">                                    .<a class="code hl_function" href="../../dc/df0/classcomponents_1_1ComponentList.html#aac1091016f393791732a7da6aaf27f48" title="Appends a component with default component name Component::kName.">Append</a>&lt;samples::pg::AuthCache&gt;()</div>
<div class="line">                                    .Append&lt;components::Postgres&gt;(<span class="stringliteral">&quot;auth-database&quot;</span>)</div>
<div class="line">                                    .<a class="code hl_function" href="../../dc/df0/classcomponents_1_1ComponentList.html#aac1091016f393791732a7da6aaf27f48" title="Appends a component with default component name Component::kName.">Append</a>&lt;samples::pg::Hello&gt;()</div>
<div class="line">                                    .Append&lt;components::TestsuiteSupport&gt;()</div>
<div class="line">                                    .<a class="code hl_function" href="../../dc/df0/classcomponents_1_1ComponentList.html#aac1091016f393791732a7da6aaf27f48" title="Appends a component with default component name Component::kName.">Append</a>&lt;<a class="code hl_class" href="../../d0/d1e/classclients_1_1dns_1_1Component.html" title="Caching DNS resolver component.">clients::dns::Component</a>&gt;();</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_function" href="../../d6/d84/namespaceutils.html#a5047c1275f53e699e26869c045ad3697">utils::DaemonMain</a>(argc, argv, component_list);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md592"></a>
Build and Run</h2>
<p>To build the sample, execute the following build steps at the userver root directory: </p><div class="fragment"><div class="line">mkdir build_release</div>
<div class="line">cd build_release</div>
<div class="line">cmake -DCMAKE_BUILD_TYPE=Release ..</div>
<div class="line">make userver-samples-postgres_auth</div>
</div><!-- fragment --><p>The sample could be started by running <code>make start-userver-samples-postgres_auth</code>. The command would invoke <a class="el" href="../../df/d07/md_en_2userver_2functional__testing.html">testsuite start target</a> that sets proper paths in the configuration files, prepares and starts the DB, and starts the service.</p>
<p>To start the service manually start the DB server and run <code>./samples/postgres_service/userver-samples-postgres_auth -c &lt;/path/to/static_config.yaml&gt;</code>.</p>
<p>Now you can send a request to your service from another terminal: </p><div class="fragment"><div class="line">bash</div>
<div class="line">$ curl &#39;localhost:8080/v1/hello&#39; -i</div>
<div class="line">HTTP/1.1 401 Unauthorized</div>
<div class="line">Date: Wed, 21 Dec 2022 13:04:17 UTC</div>
<div class="line">Content-Type: text/html</div>
<div class="line">X-YaRequestId: dbc9dbaa3fc04ce8a86b27a1aa582cd6</div>
<div class="line">X-YaSpanId: aa573144f2312714</div>
<div class="line">X-YaTraceId: 4dfb9e852e07473c9d57a8eb520e7965</div>
<div class="line">Server: userver/2.0 (20221221124812; rv:unknown)</div>
<div class="line">Connection: keep-alive</div>
<div class="line">Content-Length: 28</div>
<div class="line"> </div>
<div class="line">Empty &#39;Authorization&#39; header</div>
<div class="line"> </div>
<div class="line">$ curl -H &#39;Authorization: Bearer SOME_WRONG_USER_TOKEN&#39; &#39;localhost:8080/v1/hello&#39; -i</div>
<div class="line">HTTP/1.1 403 Forbidden</div>
<div class="line">Date: Wed, 21 Dec 2022 13:06:06 UTC</div>
<div class="line">Content-Type: text/html</div>
<div class="line">X-YaRequestId: 6e39f3bf27324aa3acb01a30b9653b2d</div>
<div class="line">X-YaTraceId: e5d38ab53b3f495a9b97279a731f5fde</div>
<div class="line">X-YaSpanId: e64b939c37035d88</div>
<div class="line">Server: userver/2.0 (20221221124812; rv:unknown)</div>
<div class="line">Connection: keep-alive</div>
<div class="line">Content-Length: 0</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md593"></a>
Functional testing</h2>
<p><a class="el" href="../../df/d07/md_en_2userver_2functional__testing.html">Functional tests</a> for the service could be implemented using the testsuite. To do that you have to:</p>
<ul>
<li>Provide PostgreSQL schema to start the database: <a class="el" href="../../d8/d7f/samples_2postgres_auth_2schemas_2postgresql_2auth_2migrations_8txt-example.html">samples/postgres_auth/schemas/postgresql/auth/migrations.txt</a> <a class="el" href="../../da/d9c/samples_2postgres_auth_2schemas_2postgresql_2auth_2migrations_2V001__create_db_8sql-example.html">samples/postgres_auth/schemas/postgresql/auth/migrations/V001__create_db.sql</a> <a class="el" href="../../df/d32/samples_2postgres_auth_2schemas_2postgresql_2auth_2migrations_2V002__add_name_8sql-example.html">samples/postgres_auth/schemas/postgresql/auth/migrations/V002__add_name.sql</a></li>
<li>Tell the testsuite to start the PostgreSQL database by adjusting the <a class="el" href="../../d5/df7/samples_2postgres_auth_2tests_2conftest_8py-example.html">samples/postgres_auth/tests/conftest.py</a></li>
<li>Prepare the DB test data <a class="el" href="../../d9/d58/samples_2postgres_auth_2tests_2static_2test_data_8sql-example.html">samples/postgres_auth/tests/static/test_data.sql</a></li>
<li>Write the test: <div class="fragment"><div class="line"><span class="keyword">import</span> pytest</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">@pytest.mark.pgsql(&#39;auth&#39;, files=[&#39;test_data.sql&#39;])</span></div>
<div class="line"><span class="keyword">async def </span>test_postgres(service_client):</div>
<div class="line">    response = await service_client.get(<span class="stringliteral">&#39;/v1/hello&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 401</div>
<div class="line">    <span class="keyword">assert</span> response.text == <span class="stringliteral">&quot;Empty &#39;Authorization&#39; header&quot;</span></div>
<div class="line"> </div>
<div class="line">    response = await service_client.get(</div>
<div class="line">        <span class="stringliteral">&#39;/v1/hello&#39;</span>, headers={<span class="stringliteral">&#39;Authorization&#39;</span>: <span class="stringliteral">&#39;Bearer THE_USER_TOKEN&#39;</span>},</div>
<div class="line">    )</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line">    <span class="keyword">assert</span> <span class="stringliteral">&#39;text/plain&#39;</span> <span class="keywordflow">in</span> response.headers[<span class="stringliteral">&#39;Content-Type&#39;</span>]</div>
<div class="line">    <span class="keyword">assert</span> response.text == <span class="stringliteral">&#39;Hello world, Dear User!\n&#39;</span></div>
</div><!-- fragment --></li>
</ul>
<h1><a class="anchor" id="autotoc_md594"></a>
Full sources</h1>
<p>See the full example:</p><ul>
<li><a class="el" href="../../da/d58/samples_2postgres_auth_2user_info_cache_8hpp-example.html">samples/postgres_auth/user_info_cache.hpp</a></li>
<li><a class="el" href="../../d3/d5c/samples_2postgres_auth_2auth_bearer_8hpp-example.html">samples/postgres_auth/auth_bearer.hpp</a></li>
<li><a class="el" href="../../d6/da6/samples_2postgres_auth_2auth_bearer_8cpp-example.html">samples/postgres_auth/auth_bearer.cpp</a></li>
<li><a class="el" href="../../d6/d35/samples_2postgres_auth_2postgres_service_8cpp-example.html">samples/postgres_auth/postgres_service.cpp</a></li>
<li><a class="el" href="../../da/dc5/samples_2postgres_auth_2static_config_8yaml-example.html">samples/postgres_auth/static_config.yaml</a></li>
<li><a class="el" href="../../d4/d12/samples_2postgres_auth_2CMakeLists_8txt-example.html">samples/postgres_auth/CMakeLists.txt</a></li>
<li><a class="el" href="../../d8/d7f/samples_2postgres_auth_2schemas_2postgresql_2auth_2migrations_8txt-example.html">samples/postgres_auth/schemas/postgresql/auth/migrations.txt</a></li>
<li><a class="el" href="../../da/d9c/samples_2postgres_auth_2schemas_2postgresql_2auth_2migrations_2V001__create_db_8sql-example.html">samples/postgres_auth/schemas/postgresql/auth/migrations/V001__create_db.sql</a></li>
<li><a class="el" href="../../df/d32/samples_2postgres_auth_2schemas_2postgresql_2auth_2migrations_2V002__add_name_8sql-example.html">samples/postgres_auth/schemas/postgresql/auth/migrations/V002__add_name.sql</a></li>
<li><a class="el" href="../../d5/df7/samples_2postgres_auth_2tests_2conftest_8py-example.html">samples/postgres_auth/tests/conftest.py</a></li>
<li><a class="el" href="../../df/d7f/samples_2postgres_auth_2tests_2test_postgres_8py-example.html">samples/postgres_auth/tests/test_postgres.py</a></li>
<li><a class="el" href="../../d9/d58/samples_2postgres_auth_2tests_2static_2test_data_8sql-example.html">samples/postgres_auth/tests/static/test_data.sql</a></li>
</ul>
<hr  />
<p> <div class="bottom-nav">  ⇦ <a class="el" href="../../d9/d1c/md_en_2userver_2tutorial_2kafka__service.html">Kafka service</a> | <a class="el" href="../../d2/dfc/md_en_2userver_2tutorial_2json__to__yaml.html">Non-Coroutine Console Tool</a> ⇨  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:56:00 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
