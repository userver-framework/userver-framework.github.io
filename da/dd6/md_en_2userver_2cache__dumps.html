<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: Local cache dumps</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('da/dd6/md_en_2userver_2cache__dumps.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Local cache dumps</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md88"></a> Cache components derived from <a class="el" href="../../df/dd1/classcomponents_1_1CachingComponentBase.html" title="Base class for caching components.">components::CachingComponentBase</a> support cache dumps. If enabled, the cache periodically writes a snapshot of the data to a dump file. When a cache component starts and a suitable dump exists, the cache reads a dump and skips the synchronous <code>Update</code>.</p>
<p>Advantages:</p><ul>
<li>Faster service start: the service no longer waits for the first synchronous <code>Update</code> that may query a database or make some other network requests.</li>
<li>Better fault tolerance: the service now boots successfully even if the first update fails.</li>
</ul>
<p>Disadvantages:</p><ul>
<li>CPU time is spent on periodic serialization of data and writing to the dump file.</li>
<li>Disk accesses consume the IO quota, which can negatively affect other disk users (for example, logging or other caches).</li>
</ul>
<h1><a class="anchor" id="autotoc_md89"></a>
How to set up cache dumps</h1>
<p>0. Make a caching component, for example as in <a class="el" href="../../dc/d8a/md_en_2userver_2tutorial_2http__caching.html">Pre-caching data from HTTP remote</a>.</p><ol type="1">
<li>Ensure that your data type is dumpable. To do that, add a static_assert into the header file of your caching component or near your type declaration: <div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cstdint&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d9/d0d/core_2include_2userver_2dump_2meta_8hpp.html" title="Provides dump::kIsDumpable and includes userver/dump/fwd.hpp.">userver/dump/meta.hpp</a>&gt;</span>  <span class="comment">// for forward declarations and kIsDumpable</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>dummy {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>SampleType {</div>
<div class="line">    std::vector&lt;std::string&gt; foo;</div>
<div class="line">    std::int64_t bar{};</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_variable" href="../../d8/d72/namespacedump.html#a5f96e08f526a282e9551222924d78d4c" title="std::variant serialization support">Write</a>(<a class="code hl_class" href="../../df/d09/classdump_1_1Writer.html" title="A general interface for binary data output.">dump::Writer</a>&amp; writer, <span class="keyword">const</span> SampleType&amp; value);</div>
<div class="line"> </div>
<div class="line">SampleType <a class="code hl_variable" href="../../d8/d72/namespacedump.html#a4e716f14d656cc8477c74be35431c869" title="std::variant deserialization support">Read</a>(<a class="code hl_class" href="../../d2/d03/classdump_1_1Reader.html" title="A general interface for binary data input.">dump::Reader</a>&amp; reader, <a class="code hl_struct" href="../../dc/d52/structdump_1_1To.html" title="A marker type used in ADL-found Read">dump::To&lt;SampleType&gt;</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static_assert</span>(dump::CheckDumpable&lt;SampleType&gt;());</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace dummy</span></div>
</div><!-- fragment --></li>
<li>If the assertion fails:<ul>
<li><a class="el" href="#dump_serialization_guide">Implement serialization</a></li>
<li><a class="el" href="#dump_testing_guide">Write unit tests for it</a></li>
</ul>
</li>
<li>Enable dumps in the static configuration of your service: <div class="fragment"><div class="line">yaml</div>
<div class="line">components_manager:</div>
<div class="line">  components:</div>
<div class="line">    simple-dumped-cache:</div>
<div class="line">      update-types: only-full</div>
<div class="line">      update-interval: 1m</div>
<div class="line">      # that&#39;s how we turn it on</div>
<div class="line">      dump:</div>
<div class="line">        enable: true</div>
<div class="line">        world-readable: false</div>
<div class="line">        format-version: 0</div>
<div class="line">        first-update-mode: required</div>
<div class="line">        first-update-type: full</div>
</div><!-- fragment --></li>
</ol>
<p><a class="anchor" id="dump_serialization_guide"></a></p>
<h1><a class="anchor" id="autotoc_md90"></a>
Implementing serialization (Write / Read)</h1>
<p>In order for a data type to be serialized for cache dumps the <code>Write</code> and <code>Read</code> functions must be implemented in the namespace of the type or in <code>namespace dump</code>:</p>
<ul>
<li>Basic types already have the required functions defined in <a class="el" href="../../d2/db0/group__userver__dump__read__write.html">various headers</a>:<ul>
<li>Integers, floats, doubles, strings, <code>std::chrono</code>, <code>enum</code>, <code>uuid</code> in <code>&lt;<a class="el" href="../../d8/d6b/core_2include_2userver_2dump_2common_8hpp.html" title="Serialization and deserialization of integral, floating point, string, std::chrono,...">userver/dump/common.hpp</a>&gt;</code></li>
<li>C++ Standard Library and Boost containers, <code>std::optional</code>, <code><a class="el" href="../../d4/d67/classutils_1_1StrongTypedef.html" title="Strong typedef for a type T.">utils::StrongTypedef</a></code>, <code>std::{unique,shared}_ptr</code> in <code>&lt;<a class="el" href="../../df/d8a/core_2include_2userver_2dump_2common__containers_8hpp.html" title="Dump support for C++ Standard Library and Boost containers, std::optional, utils::StrongTypedef,...">userver/dump/common_containers.hpp</a>&gt;</code></li>
<li>Trivial structures (aggregates) in <code>&lt;<a class="el" href="../../d8/deb/aggregates_8hpp.html" title="Dumping support for aggregates.">userver/dump/aggregates.hpp</a>&gt;</code>, but you will have to enable dumps manually: <div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cstdint&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d8/deb/aggregates_8hpp.html" title="Dumping support for aggregates.">userver/dump/aggregates.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>some_namespace {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>MyStruct {</div>
<div class="line">    std::int16_t some_field;</div>
<div class="line">    std::string some_other_field;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace some_namespace</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Enable dumping of the aggregate</span></div>
<div class="line"><span class="keyword">template</span> &lt;&gt;</div>
<div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="../../d2/d4c/structdump_1_1IsDumpedAggregate.html">dump::IsDumpedAggregate</a>&lt;some_namespace::MyStruct&gt;;</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>For more complex user types it is recommended to place only declarations in the header file to avoid unnecessary includes leaking into all the translation units that use the type: <div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cstdint&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d9/d0d/core_2include_2userver_2dump_2meta_8hpp.html" title="Provides dump::kIsDumpable and includes userver/dump/fwd.hpp.">userver/dump/meta.hpp</a>&gt;</span>  <span class="comment">// for forward declarations and kIsDumpable</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>dummy {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>SampleType {</div>
<div class="line">    std::vector&lt;std::string&gt; foo;</div>
<div class="line">    std::int64_t bar{};</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_variable" href="../../d8/d72/namespacedump.html#a5f96e08f526a282e9551222924d78d4c" title="std::variant serialization support">Write</a>(<a class="code hl_class" href="../../df/d09/classdump_1_1Writer.html" title="A general interface for binary data output.">dump::Writer</a>&amp; writer, <span class="keyword">const</span> SampleType&amp; value);</div>
<div class="line"> </div>
<div class="line">SampleType <a class="code hl_variable" href="../../d8/d72/namespacedump.html#a4e716f14d656cc8477c74be35431c869" title="std::variant deserialization support">Read</a>(<a class="code hl_class" href="../../d2/d03/classdump_1_1Reader.html" title="A general interface for binary data input.">dump::Reader</a>&amp; reader, <a class="code hl_struct" href="../../dc/d52/structdump_1_1To.html" title="A marker type used in ADL-found Read">dump::To&lt;SampleType&gt;</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static_assert</span>(dump::CheckDumpable&lt;SampleType&gt;());</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace dummy</span></div>
</div><!-- fragment --> Actual definitions should go to the source file: <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;class_serialization_sample_test.hpp&quot;</span>  <span class="comment">// for dummy::SampleType</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d8/d6b/core_2include_2userver_2dump_2common_8hpp.html" title="Serialization and deserialization of integral, floating point, string, std::chrono,...">userver/dump/common.hpp</a>&gt;</span>             <span class="comment">// for int, string dump</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../df/d8a/core_2include_2userver_2dump_2common__containers_8hpp.html" title="Dump support for C++ Standard Library and Boost containers, std::optional, utils::StrongTypedef,...">userver/dump/common_containers.hpp</a>&gt;</span>  <span class="comment">// for vector dump</span></div>
<div class="line"><span class="preprocessor">#include &lt;userver/dump/operations.hpp&gt;</span>         <span class="comment">// for Writer/Reader</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>dummy {</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_variable" href="../../d8/d72/namespacedump.html#a5f96e08f526a282e9551222924d78d4c" title="std::variant serialization support">Write</a>(<a class="code hl_class" href="../../df/d09/classdump_1_1Writer.html" title="A general interface for binary data output.">dump::Writer</a>&amp; writer, <span class="keyword">const</span> SampleType&amp; value) {</div>
<div class="line">    writer.<a class="code hl_function" href="../../df/d09/classdump_1_1Writer.html#aeeb74bbbca334d00f396c6865f79fd82" title="Writes binary data.">Write</a>(value.foo);</div>
<div class="line">    writer.<a class="code hl_function" href="../../df/d09/classdump_1_1Writer.html#aeeb74bbbca334d00f396c6865f79fd82" title="Writes binary data.">Write</a>(value.bar);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">SampleType <a class="code hl_variable" href="../../d8/d72/namespacedump.html#a4e716f14d656cc8477c74be35431c869" title="std::variant deserialization support">Read</a>(<a class="code hl_class" href="../../d2/d03/classdump_1_1Reader.html" title="A general interface for binary data input.">dump::Reader</a>&amp; reader, <a class="code hl_struct" href="../../dc/d52/structdump_1_1To.html" title="A marker type used in ADL-found Read">dump::To&lt;SampleType&gt;</a>) {</div>
<div class="line">    SampleType value;</div>
<div class="line">    value.foo = reader.<a class="code hl_function" href="../../d2/d03/classdump_1_1Reader.html#aa50754192ec845b898e1b92827f51c2f" title="Reads binary data.">Read</a>&lt;std::vector&lt;std::string&gt;&gt;();</div>
<div class="line">    value.bar = reader.<a class="code hl_function" href="../../d2/d03/classdump_1_1Reader.html#aa50754192ec845b898e1b92827f51c2f" title="Reads binary data.">Read</a>&lt;std::int64_t&gt;();</div>
<div class="line">    <span class="keywordflow">return</span> value;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace dummy</span></div>
</div><!-- fragment --></li>
<li>If JSON, protobuf or flatbuffers serialization is already implemented for the structure, you can use it in <code>Write</code>/<code>Read</code> if it suites your requirements.</li>
</ul>
<h2><a class="anchor" id="autotoc_md91"></a>
Recommendations</h2>
<ol type="1">
<li>Place <code>Write</code>/<code>Read</code> function declarations for your own types:<ul>
<li>in the <code>namespace</code> of the type, not into <code>namespace dump</code></li>
<li>in the same header, next to the type definition</li>
</ul>
</li>
<li>Place serialization of third party types:<ul>
<li>in <code>namespace dump</code></li>
<li>if serialization may be useful to others and does not add source dependencies, it is worth making a PR into userver</li>
</ul>
</li>
<li>When implementing serialization for multiple types, place functions in the order <code>Write1, Read1, Write2, Read2, ...</code></li>
<li>Avoid using <code>Write/Read</code> functions by ADL (argument dependent lookup), prefer calling <code>writer.Write(value)</code> or <code>reader.Read&lt;T&gt;()</code>.</li>
</ol>
<p><a class="anchor" id="dump_testing_guide"></a></p>
<h1><a class="anchor" id="autotoc_md92"></a>
Testing serialization</h1>
<p>If you have written your own <code>Write/Read</code> functions, write <code>utest</code> tests for them using <code>&lt;<a class="el" href="../../d5/d46/utest_2include_2userver_2dump_2test__helpers_8hpp_source.html">userver/dump/test_helpers.hpp</a>&gt;</code>. If the data type supports <code>operator==</code>, it is sufficient to use <a class="el" href="../../d8/d72/namespacedump.html#a7c12be26fdae1224e898a87d9db9945e">dump::TestWriteReadCycle</a>.</p>
<h1><a class="anchor" id="autotoc_md93"></a>
Encryption of the dump file</h1>
<p>By default, the data in the file is stored using an insecure format (binary or JSON). A user with access to the dump file can restore its contents. If the dump file is compromised, a malicious user can gain access to the data. This may be undesirable in the case of caches that store personal or other private data. For such caches, you can enable encryption of the dump file. Dump encryption is disabled by default.</p>
<p>The <a class="el" href="../../df/dd1/classcomponents_1_1CachingComponentBase.html" title="Base class for caching components.">components::CachingComponentBase</a> uses the AES-GCM-256 encryption algorithm if the encryption is enabled. To enable encryption, do the following:</p><ol type="1">
<li>In the static configuration for the cache, set <code>dump.encrypted=true</code>: <div class="fragment"><div class="line">yaml</div>
<div class="line">components_manager:</div>
<div class="line">  components:</div>
<div class="line">    your-caching-component:</div>
<div class="line">      dump:</div>
<div class="line">        encrypted: true</div>
</div><!-- fragment --></li>
<li>Place a secret for encoding and decoding into <code>CACHE_DUMP_SECRET_KEYS</code> section of the <a class="el" href="../../da/dc7/classcomponents_1_1Secdist.html" title="Component that stores security related data (keys, passwords, ...).">components::Secdist</a> file. Use the name of your cache component as a JSON key and the secret as a JSON value: <div class="fragment"><div class="line">json</div>
<div class="line">{</div>
<div class="line">  &quot;CACHE_DUMP_SECRET_KEYS&quot;: {</div>
<div class="line">      &quot;you-cache-component-name&quot;: &quot;your-base64encoded-secret-key&quot;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
</ol>
<h1><a class="anchor" id="autotoc_md94"></a>
Dump Settings</h1>
<p>Static settings for dumps are set in the <code>dump</code> subsection of the cache component. All the <code>dump</code> options are described in the <a class="el" href="../../d8/d4c/classdump_1_1Dumper.html" title="Manages dumps of a cache-like component.">dump::Dumper</a>.</p>
<p>An example with all the options:</p>
<div class="fragment"><div class="line">yaml</div>
<div class="line">components_manager:</div>
<div class="line">  components:</div>
<div class="line">  simple-dumped-cache:</div>
<div class="line">    update-types: only-incremental</div>
<div class="line">    update-interval: 1m</div>
<div class="line">    dump:</div>
<div class="line">      enable: true</div>
<div class="line">      world-readable: false</div>
<div class="line">      format-version: 4</div>
<div class="line">      first-update-mode: skip</div>
<div class="line">      first-update-type: incremental</div>
<div class="line">      max-age: 60m</div>
<div class="line">      max-count: 1</div>
<div class="line">      min-interval: 3m</div>
<div class="line">      fs-task-processor: my-task-processor</div>
<div class="line">      wait-for-first-update: true</div>
<div class="line">      encrypted: false</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md95"></a>
Dynamic configuration of dumps</h1>
<p>A subset of dump settings could be overridden by the dynamic configuration <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html#USERVER_DUMPS">USERVER_DUMPS</a>.</p>
<p>If you omit setting the dynamic configuration (or do not describe some cache in <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html#USERVER_DUMPS">USERVER_DUMPS</a>), the value from the static configuration is used. To reset to the default value, you need to specify <code>null</code> in the dynamic configuration.</p>
<p>Example:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="stringliteral">&quot;your-cache-component&quot;</span>: {</div>
<div class="line">    <span class="stringliteral">&quot;dumps-enabled&quot;</span>: <span class="keyword">true</span>,</div>
<div class="line">    <span class="stringliteral">&quot;min-dump-interval-ms&quot;</span>: 600000</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md96"></a>
Implementation details</h1>
<h2><a class="anchor" id="autotoc_md97"></a>
IO</h2>
<ul>
<li>Disk operations are performed asynchronously with <code>Update</code> in a separate <code>fs-task-processor</code>. <code>Write</code> and <code>Read</code> are also called in that task processor.</li>
<li>No more than one dump could be written at the same time. If after an <code>Update</code> the previous write to the dump has not completed, the new write operation is skipped.</li>
<li>While writing the dump <a class="el" href="../../de/d7a/classdump_1_1FileWriter.html" title="A handle to a dump file. File operations block the thread.">dump::FileWriter</a> periodically calls to <a class="el" href="../../dc/d3f/namespaceengine.html#a142b0ca27e383ae38f52cac01692a8d0" title="Suspends execution for a brief period of time, possibly allowing other tasks to execute.">engine::Yield</a> to avoid blocking the thread for a long time</li>
<li>For each cache, a subdirectory with the name of the cache is created</li>
<li>The dump name contains UTC time with microsecond precision and <code>format-version</code>, for example <code>2020-10-28T174608.907090Z-v0</code></li>
<li>Dump is updated atomically. A new <code>.tmp</code> file is created, flushed on the disk and atomically renamed.</li>
<li>Permissions for all the created directories are <code>0755</code></li>
<li>Permissions for the dump files are either <code>0400</code> or <code>0444</code>, depending on the <code>world-readable</code> setting.</li>
</ul>
<h2><a class="anchor" id="autotoc_md98"></a>
Data format</h2>
<ul>
<li>The dump data format is a binary stream of fixed-size structures and strings in the "size, data" format.</li>
<li>Sizes and other integers are compressed. <code>0</code> and other small numbers occupy 1 byte. Large and negative numbers take up to 9 bytes</li>
<li>Empty <code>std::string</code>, <code>std::optional</code>, containers occupy 1 byte</li>
<li>Optimization of default values is not performed</li>
<li>Format of the dump is platform-independent</li>
</ul>
<h1><a class="anchor" id="autotoc_md99"></a>
Nuances and pitfalls</h1>
<ul>
<li>If an empty value is stored in the cache (for example, due to calling CachingComponentBase::Clear()), the cache will gladly replace the old dump with a new empty dump. You can deal with this in the following ways:<ul>
<li>Do not use Clear(). The cache expects that if there is no data, it is <code>nullptr</code> that lies there. To prevent this from causing an exception, you will have to redefine <code>void MayReturnNull() override { return true; }</code> and <code>first-update-fail-ok: true</code></li>
</ul>
</li>
<li>Redefine <code>Write</code>/<code>Read</code> for your data type to throw <code><a class="el" href="../../d9/d52/classcache_1_1EmptyCacheError.html">cache::EmptyCacheError</a></code> when the cache value is empty. If there is a standard datatype in the cache, you will have to wrap it in a <code>struct</code> to define a custom <code>Write</code>/<code>Read</code>.</li>
<li>If multiple <code>std::shared_ptr</code>s for the same object are stored in the same cache snapshot, they will point to separate copies of this object after the dump is loaded.</li>
<li>In order not to copy a large string when deserializing JSON, flatbuffers, etc., you can use <code>&lt;<a class="el" href="../../dd/d0b/unsafe_8hpp_source.html">userver/dump/unsafe.hpp</a>&gt;</code></li>
</ul>
<hr  />
<p> <div class="bottom-nav">  ⇦ <a class="el" href="../../d5/d2d/md_en_2userver_2caches.html">Basics of Caches</a> | <a class="el" href="../../d9/dde/pg_cache.html">Caching Component for PostgreSQL</a> ⇨  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:55:58 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
