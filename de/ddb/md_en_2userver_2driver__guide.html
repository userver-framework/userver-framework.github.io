<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: Driver Writing Guide</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('de/ddb/md_en_2userver_2driver__guide.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Driver Writing Guide</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md209"></a> Do you want to write a new driver for the server? This work is noble, but difficult.</p>
<p>There are multiple ways to write a driver.</p>
<h2><a class="anchor" id="autotoc_md210"></a>
Easy to write, poor performance</h2>
<p>Create a separate <code>TaskProcessor</code> for the driver and put all the blocking interactions of the native library into it:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span>... Args&gt;</div>
<div class="line"><span class="keyword">auto</span> UserverSide::DoStuff(Args&amp;&amp;... args) { </div>
<div class="line">  <span class="keywordflow">return</span> <a class="code hl_function" href="../../dc/db7/group__userver__concurrency.html#ga29b9a09eacda1ddf8b4440b3713f5e52" title="Starts an asynchronous task.">utils::Async</a>(driver_task_processor, <span class="stringliteral">&quot;driver-action&quot;</span>, [&amp;]() {</div>
<div class="line">    <span class="keywordflow">return</span> native_do_stuff(std::forward&lt;Args&gt;(args));</div>
<div class="line">  }).Get();</div>
<div class="line">}</div>
</div><!-- fragment --><p>This approach has a problem. userver discourages performing CPU-bound work outside of the <code>main-task-processor</code> and prohibits blocking system calls in the <code>main-task-processor</code>.</p>
<p>While the threads of the <code>{driver}-task-processor</code> are blocked on I/O, there are no problems. But as soon as they start parsing data the invariant above breaks, which leads lead to degradation of the service.</p>
<p>This approach is discouraged.</p>
<h2><a class="anchor" id="autotoc_md211"></a>
Not too easy to write, good performance</h2>
<p>If the native driver provides some kind of notification mechanism for asynchronous completions, then you can notify userver from the completion queue using asynchronous server primitives (<a class="el" href="../../d8/d67/classengine_1_1Future.html" title="std::future replacement for asynchronous tasks that works in pair with engine::Promise">engine::Future</a> or <a class="el" href="../../d8/d87/classengine_1_1SingleConsumerEvent.html" title="A multiple-producers, single-consumer event.">engine::SingleConsumerEvent</a>). This approach was used to write the gRPC driver in userver.</p>
<p>Otherwise, if the native driver is written in C++ and is not too big, then it may be possible to patch it to use userver IO primitives (<a class="el" href="../../dd/dcf/classengine_1_1io_1_1Socket.html" title="Socket representation.">engine::io::Socket</a>, for example) and cleaning out other blocking primitives in favor of userver ones (<a class="el" href="../../d0/da4/classengine_1_1Mutex.html" title="std::mutex replacement for asynchronous tasks.">engine::Mutex</a>, <a class="el" href="../../d3/d5d/classengine_1_1ConditionVariable.html" title="std::condition_variable replacement for asynchronous tasks">engine::ConditionVariable</a>). This approach was used to write the Clickhouse driver in userver.</p>
<p>In both approaches there is a downside. The native library must be integrated into CMake scripts and additional libraries should be added to userver dependencies. In some rare cases this might be non-trivial.</p>
<h2><a class="anchor" id="autotoc_md212"></a>
Hard to write, good performance</h2>
<p>Implement the protocol yourself (probably reusing a subset of the native library functionality). This approach was used to write the PostgreSQL driver in userver - it creates a connection in a separate <code>TaskProcessor</code> via native functions, and then subscribes to the socket via <a class="el" href="../../dd/dcf/classengine_1_1io_1_1Socket.html" title="Socket representation.">engine::io::Socket</a>, parses the protocol in the main <code>TaskProcessor</code>.</p>
<p>Such an approach may open the door for further optimizations. If no native library is reused, then there's no need in dealing with CMake scripts to integrate it.</p>
<h1><a class="anchor" id="autotoc_md213"></a>
Recommendations</h1>
<p>Your driver should be well integrated into the userver framework. Write logs, a lot of logs, write them in all places where something is happening. It's always better to have extra logs (which can then be removed) than to have errors without logs.</p>
<p>Write metrics - about connections, about queries, about query timings - in general, about everything that happens inside the driver.</p>
<p>Write tests - unit and functional ones. If possible, write benchmarks. For full-fledged testing, you will need to set up an instance of what you are writing a driver for in the testsuite. This may not be trivial...</p>
<p>Docs and samples should be provided.</p>
<p>Note: PR for new drivers are welcome! If you started the work, the driver already does something useful but you're feeling exhausted, then we may help you to deal with the remaining parts.</p>
<hr  />
<p> <div class="bottom-nav">  ⇦ <a class="el" href="../../db/d57/md_en_2userver_2development_2stability.html">API and ABI stability, versioning</a> | <a class="el" href="../../da/de1/md_en_2userver_2tutorial_2build__userver.html">Build instructions for userver</a> ⇨  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:55:59 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
