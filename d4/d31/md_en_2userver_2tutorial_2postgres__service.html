<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.10.0"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: PostgreSQL service</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.topOffset = 180;
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d4/d31/md_en_2userver_2tutorial_2postgres__service.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">PostgreSQL service</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md768"></a> </p>
<h1><a class="anchor" id="autotoc_md769"></a>
Before you start</h1>
<p>Make sure that you can compile and run core tests and read a basic example <a class="el" href="../../da/d16/md_en_2userver_2tutorial_2hello__service.html">Writing your first HTTP server</a>.</p>
<p>Note that there is a ready to use opensource <a href="https://github.com/userver-framework/pg_service_template">pg service template</a> to ease the development of your userver based services that use PostgreSQL database. The template already has a preconfigured CI, build and install scripts, testsuite and unit-tests setups.</p>
<h1><a class="anchor" id="autotoc_md770"></a>
Step by step guide</h1>
<p>Microservices that have state often work with database to store their data and replicate that state across instances of the microservice. In this tutorial we will write a service that is a simple key-value storage on top of PostgreSQL database. The service would have the following Rest API:</p><ul>
<li>HTTP POST by path '/v1/key-value' with query parameters 'key' and 'value' stores the provided key and value or return an existing value for the key</li>
<li>HTTP GET by path '/v1/key-value' with query parameter 'key' returns the value if it exists</li>
<li>HTTP DELETE by path '/v1/key-value' with query parameter 'key' deletes the key if it exists and returns number of deleted keys</li>
</ul>
<h2><a class="anchor" id="autotoc_md771"></a>
HTTP handler component</h2>
<p>Like in <a class="el" href="../../da/d16/md_en_2userver_2tutorial_2hello__service.html">Writing your first HTTP server</a> we create a component for handling HTTP requests:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d8/d2e/core_2include_2userver_2components_2component_8hpp.html" title="Convenience header that provides all the types for component implementation (components::ComponentCon...">userver/components/component.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../db/dbf/minimal__server__component__list_8hpp.html" title="Returns a list of components to start a basic HTTP server.">userver/components/minimal_server_component_list.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d4/df6/http__handler__base_8hpp.html" title="Base class for all the Userver HTTP Handlers.">userver/server/handlers/http_handler_base.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d7/de0/daemon__run_8hpp.html" title="Functions to start a daemon with specified components list.">userver/utils/daemon_run.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../de/dd3/postgresql_2include_2userver_2storages_2postgres_2cluster_8hpp.html" title="Interface for executing queries on a cluster of PostgreSQL servers.">userver/storages/postgres/cluster.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../df/d08/postgresql_2include_2userver_2storages_2postgres_2component_8hpp.html" title="PosgreSQL client component.">userver/storages/postgres/component.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>samples::pg {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>KeyValue final : <span class="keyword">public</span> <a class="code hl_class" href="../../d6/d36/classserver_1_1handlers_1_1HttpHandlerBase.html" title="Base class for all the Userver HTTP Handlers.">server::handlers::HttpHandlerBase</a> {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">constexpr</span> std::string_view kName = <span class="stringliteral">&quot;handler-key-value&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    KeyValue(<span class="keyword">const</span> <a class="code hl_class" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a>&amp; config, <span class="keyword">const</span> <a class="code hl_class" href="../../da/db1/classcomponents_1_1ComponentContext.html" title="Class to retrieve other components.">components::ComponentContext</a>&amp; context);</div>
<div class="line"> </div>
<div class="line">    std::string HandleRequestThrow(<span class="keyword">const</span> <a class="code hl_class" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request, <a class="code hl_class" href="../../de/df6/classserver_1_1request_1_1RequestContext.html" title="Stores request-specific data during request processing.">server::request::RequestContext</a>&amp;)</div>
<div class="line">        <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    std::string GetValue(std::string_view key, <span class="keyword">const</span> <a class="code hl_class" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request) <span class="keyword">const</span>;</div>
<div class="line">    std::string PostValue(std::string_view key, <span class="keyword">const</span> <a class="code hl_class" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request) <span class="keyword">const</span>;</div>
<div class="line">    std::string DeleteValue(std::string_view key) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_typedef" href="../../de/d6d/namespacestorages_1_1postgres.html#a09b8b5e9edbf31944f667780538d2328" title="Smart pointer to the storages::postgres::Cluster.">storages::postgres::ClusterPtr</a> pg_cluster_;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace samples::pg</span></div>
</div><!-- fragment --><p>Note that the component holds a <a class="el" href="../../de/d6d/namespacestorages_1_1postgres.html#a09b8b5e9edbf31944f667780538d2328" title="Smart pointer to the storages::postgres::Cluster.">storages::postgres::ClusterPtr</a> - a client to the PostgreSQL DB. That client is thread safe, you can use it concurrently from different threads and tasks.</p>
<h2><a class="anchor" id="autotoc_md772"></a>
Initializing the database</h2>
<p>To access the database from our new component we need to find the PostgreSQL component and request a client to the DB. After that we may create the required tables.</p>
<div class="fragment"><div class="line">KeyValue::KeyValue(<span class="keyword">const</span> <a class="code hl_class" href="../../db/dff/classcomponents_1_1ComponentConfig.html">components::ComponentConfig</a>&amp; config, <span class="keyword">const</span> <a class="code hl_class" href="../../da/db1/classcomponents_1_1ComponentContext.html" title="Class to retrieve other components.">components::ComponentContext</a>&amp; context)</div>
<div class="line">    : HttpHandlerBase(config, context),</div>
<div class="line">      pg_cluster_(context.FindComponent&lt;<a class="code hl_namespace" href="../../d0/d1f/namespacecomponents.html" title="Contains functions and types to start a userver based service/tool.">components</a>::Postgres&gt;(<span class="stringliteral">&quot;key-value-database&quot;</span>).GetCluster()) {</div>
<div class="line">    <span class="keyword">constexpr</span> <span class="keyword">auto</span> kCreateTable = R<span class="stringliteral">&quot;~(</span></div>
<div class="line"><span class="stringliteral">      CREATE TABLE IF NOT EXISTS key_value_table (</span></div>
<div class="line"><span class="stringliteral">        key VARCHAR PRIMARY KEY,</span></div>
<div class="line"><span class="stringliteral">        value VARCHAR</span></div>
<div class="line"><span class="stringliteral">      )</span></div>
<div class="line"><span class="stringliteral">    )~&quot;;</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">    </span><span class="keyword">using </span><a class="code hl_enumeration" href="../../de/d6d/namespacestorages_1_1postgres.html#a112991762e57633e6213c2cbbce7d62f">storages::postgres::ClusterHostType</a>;</div>
<div class="line">    pg_cluster_-&gt;Execute(ClusterHostType::kMaster, kCreateTable);</div>
<div class="line">}</div>
</div><!-- fragment --><p>To create a table we just execute an SQL statement, mentioning that it should go to the master instance. After that, our component is ready to process incoming requests in the KeyValue::HandleRequestThrow function.</p>
<h2><a class="anchor" id="autotoc_md773"></a>
KeyValue::HandleRequestThrow</h2>
<p>In this sample we use a single handler to deal with all the HTTP methods. The KeyValue::HandleRequestThrow member function mostly dispatches the request to one of the member functions that actually implement the key-value storage logic:</p>
<div class="fragment"><div class="line">std::string KeyValue::HandleRequestThrow(<span class="keyword">const</span> <a class="code hl_class" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request, <a class="code hl_class" href="../../de/df6/classserver_1_1request_1_1RequestContext.html" title="Stores request-specific data during request processing.">server::request::RequestContext</a>&amp;)<span class="keyword"></span></div>
<div class="line"><span class="keyword">    const </span>{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; key = request.<a class="code hl_function" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#aea82de2fbb3e8ed97ba400b38cc706bb">GetArg</a>(<span class="stringliteral">&quot;key&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (key.empty()) {</div>
<div class="line">        <span class="keywordflow">throw</span> <a class="code hl_class" href="../../db/d63/classserver_1_1handlers_1_1ClientError.html">server::handlers::ClientError</a>(<a class="code hl_struct" href="../../d7/da5/structserver_1_1handlers_1_1ExternalBody.html">server::handlers::ExternalBody</a>{<span class="stringliteral">&quot;No &#39;key&#39; query argument&quot;</span>});</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    request.<a class="code hl_function" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#a2434ed4270f909f1b74224fbc4196aed" title="Returns a container that should be filled with response data to this request.">GetHttpResponse</a>().<a class="code hl_function" href="../../da/da4/classserver_1_1http_1_1HttpResponse.html#a65a1797ad369c166546a22ffaaab0d53" title="Add or rewrite the Content-Type header.">SetContentType</a>(http::content_type::kTextPlain);</div>
<div class="line">    <span class="keywordflow">switch</span> (request.GetMethod()) {</div>
<div class="line">        <span class="keywordflow">case</span> server::http::HttpMethod::kGet:</div>
<div class="line">            <span class="keywordflow">return</span> GetValue(key, request);</div>
<div class="line">        <span class="keywordflow">case</span> server::http::HttpMethod::kPost:</div>
<div class="line">            <span class="keywordflow">return</span> PostValue(key, request);</div>
<div class="line">        <span class="keywordflow">case</span> server::http::HttpMethod::kDelete:</div>
<div class="line">            <span class="keywordflow">return</span> DeleteValue(key);</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">throw</span> <a class="code hl_class" href="../../db/d63/classserver_1_1handlers_1_1ClientError.html">server::handlers::ClientError</a>(<a class="code hl_struct" href="../../d7/da5/structserver_1_1handlers_1_1ExternalBody.html">server::handlers::ExternalBody</a>{</div>
<div class="line">                fmt::format(<span class="stringliteral">&quot;Unsupported method {}&quot;</span>, request.GetMethod())});</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section warning"><dt>Warning</dt><dd><code>Handle*</code> functions are invoked concurrently on the same instance of the handler class. In this sample the KeyValue component only uses the thread safe DB client. In more complex cases <a class="el" href="../../d6/d6c/md_en_2userver_2synchronization.html">synchronization primitives</a> should be used or data must not be mutated.</dd></dl>
<h2><a class="anchor" id="autotoc_md774"></a>
KeyValue::GetValue</h2>
<p>Postgres driver in userver implicitly works with prepared statements. For the first time you execute the query a prepared statement is created. Executing the query next time would result in only sending the arguments for the already created prepared statement.</p>
<p>You could pass strings as queries, just like we done in constructor of KeyValue. Also queries could be stored in variables along with query names and reused across the functions. Name of the query could be used in dynamic configs to set the execution timeouts (see <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html#POSTGRES_QUERIES_COMMAND_CONTROL">POSTGRES_QUERIES_COMMAND_CONTROL</a>).</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code hl_class" href="../../de/d0c/classstorages_1_1Query.html" title="Holds a query, its name and logging mode.">storages::postgres::Query</a> kSelectValue{</div>
<div class="line">    <span class="stringliteral">&quot;SELECT value FROM key_value_table WHERE key=$1&quot;</span>,</div>
<div class="line">    <a class="code hl_class" href="../../d4/d67/classutils_1_1StrongTypedef.html" title="Strong typedef for a type T.">storages::postgres::Query::Name</a>{<span class="stringliteral">&quot;sample_select_value&quot;</span>},</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">std::string KeyValue::GetValue(std::string_view key, <span class="keyword">const</span> <a class="code hl_class" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request)<span class="keyword"> const </span>{</div>
<div class="line">    <a class="code hl_class" href="../../d0/d5b/classstorages_1_1postgres_1_1ResultSet.html" title="PostgreSQL result set.">storages::postgres::ResultSet</a> res =</div>
<div class="line">        pg_cluster_-&gt;Execute(<a class="code hl_enumvalue" href="../../de/d6d/namespacestorages_1_1postgres.html#a112991762e57633e6213c2cbbce7d62fa711876d1003646469de6eb5a7811927b">storages::postgres::ClusterHostType::kSlave</a>, kSelectValue, key);</div>
<div class="line">    <span class="keywordflow">if</span> (res.IsEmpty()) {</div>
<div class="line">        request.<a class="code hl_function" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#a3e4903d158a34e717668af618e56af92" title="Set the response status code.">SetResponseStatus</a>(server::http::HttpStatus::kNotFound);</div>
<div class="line">        <span class="keywordflow">return</span> {};</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> res.<a class="code hl_function" href="../../d0/d5b/classstorages_1_1postgres_1_1ResultSet.html#af396fa72f7e8dae52bc627d3955295c4" title="Extract first row into user type. A single row result set is expected, will throw an exception when r...">AsSingleRow</a>&lt;std::string&gt;();</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md775"></a>
KeyValue::PostValue</h2>
<p>You can start a transaction by calling <a class="el" href="../../dd/d69/classstorages_1_1postgres_1_1Cluster.html#a03bd02e2c9d945b75d12745465c9a871">storages::postgres::Cluster::Begin()</a>. Transactions are automatically rolled back, if you do not commit them. To execute a query in transaction, just call Execute member function of a transaction. Just like with non-transactional Execute, you can pass string or storages::postgres::Query, you could reuse the same query in different functions. Transactions also could be named, and those names could be used in <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html#POSTGRES_QUERIES_COMMAND_CONTROL">POSTGRES_QUERIES_COMMAND_CONTROL</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code hl_class" href="../../de/d0c/classstorages_1_1Query.html" title="Holds a query, its name and logging mode.">storages::postgres::Query</a> kInsertValue{</div>
<div class="line">    <span class="stringliteral">&quot;INSERT INTO key_value_table (key, value) &quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;VALUES ($1, $2) &quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;ON CONFLICT DO NOTHING&quot;</span>,</div>
<div class="line">    <a class="code hl_class" href="../../d4/d67/classutils_1_1StrongTypedef.html" title="Strong typedef for a type T.">storages::postgres::Query::Name</a>{<span class="stringliteral">&quot;sample_insert_value&quot;</span>},</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">std::string KeyValue::PostValue(std::string_view key, <span class="keyword">const</span> <a class="code hl_class" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html" title="HTTP Request data.">server::http::HttpRequest</a>&amp; request)<span class="keyword"> const </span>{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; value = request.<a class="code hl_function" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#aea82de2fbb3e8ed97ba400b38cc706bb">GetArg</a>(<span class="stringliteral">&quot;value&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_class" href="../../d1/dc2/classstorages_1_1postgres_1_1Transaction.html" title="PostgreSQL transaction.">storages::postgres::Transaction</a> transaction =</div>
<div class="line">        pg_cluster_-&gt;Begin(<span class="stringliteral">&quot;sample_transaction_insert_key_value&quot;</span>, <a class="code hl_enumvalue" href="../../de/d6d/namespacestorages_1_1postgres.html#a112991762e57633e6213c2cbbce7d62fad4720c3695455d7cf5bce1b2c7bcecdf">storages::postgres::ClusterHostType::kMaster</a>, {});</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> res = transaction.Execute(kInsertValue, key, value);</div>
<div class="line">    <span class="keywordflow">if</span> (res.RowsAffected()) {</div>
<div class="line">        transaction.<a class="code hl_function" href="../../d1/dc2/classstorages_1_1postgres_1_1Transaction.html#a78f89d3766bfff77e3390db9cddc6d66">Commit</a>();</div>
<div class="line">        request.<a class="code hl_function" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#a3e4903d158a34e717668af618e56af92" title="Set the response status code.">SetResponseStatus</a>(server::http::HttpStatus::kCreated);</div>
<div class="line">        <span class="keywordflow">return</span> std::string{value};</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    res = transaction.Execute(kSelectValue, key);</div>
<div class="line">    transaction.<a class="code hl_function" href="../../d1/dc2/classstorages_1_1postgres_1_1Transaction.html#a221a27c28748ec5236d2113355486a1c">Rollback</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> result = res.<a class="code hl_function" href="../../d0/d5b/classstorages_1_1postgres_1_1ResultSet.html#af396fa72f7e8dae52bc627d3955295c4" title="Extract first row into user type. A single row result set is expected, will throw an exception when r...">AsSingleRow</a>&lt;std::string&gt;();</div>
<div class="line">    <span class="keywordflow">if</span> (result != value) {</div>
<div class="line">        request.<a class="code hl_function" href="../../d3/d44/classserver_1_1http_1_1HttpRequest.html#a3e4903d158a34e717668af618e56af92" title="Set the response status code.">SetResponseStatus</a>(server::http::HttpStatus::kConflict);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> res.<a class="code hl_function" href="../../d0/d5b/classstorages_1_1postgres_1_1ResultSet.html#af396fa72f7e8dae52bc627d3955295c4" title="Extract first row into user type. A single row result set is expected, will throw an exception when r...">AsSingleRow</a>&lt;std::string&gt;();</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md776"></a>
KeyValue::DeleteValue</h2>
<p>Note that mutating queries should be executed on a master instance.</p>
<div class="fragment"><div class="line">std::string KeyValue::DeleteValue(std::string_view key)<span class="keyword"> const </span>{</div>
<div class="line">    <span class="keyword">auto</span> res = pg_cluster_-&gt;Execute(</div>
<div class="line">        <a class="code hl_enumvalue" href="../../de/d6d/namespacestorages_1_1postgres.html#a112991762e57633e6213c2cbbce7d62fad4720c3695455d7cf5bce1b2c7bcecdf">storages::postgres::ClusterHostType::kMaster</a>, <span class="stringliteral">&quot;DELETE FROM key_value_table WHERE key=$1&quot;</span>, key</div>
<div class="line">    );</div>
<div class="line">    <span class="keywordflow">return</span> std::to_string(res.RowsAffected());</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md777"></a>
Static config</h2>
<p>Static configuration of service is quite close to the configuration from <a class="el" href="../../da/d16/md_en_2userver_2tutorial_2hello__service.html">Writing your first HTTP server</a> except for the handler and DB:</p>
<div class="fragment"><div class="line"># yaml</div>
<div class="line">components_manager:</div>
<div class="line">    components:                       # Configuring components that were registered via component_list</div>
<div class="line">        handler-key-value:</div>
<div class="line">            path: /v1/key-value                  # Registering handler by URL &#39;/v1/key-value&#39;.</div>
<div class="line">            task_processor: main-task-processor  # Run it on CPU bound task processor</div>
<div class="line">            method: GET,DELETE,POST</div>
<div class="line"> </div>
<div class="line">        key-value-database:</div>
<div class="line">            dbconnection: &#39;postgresql://testsuite@localhost:15433/postgres&#39;</div>
<div class="line">            blocking_task_processor: fs-task-processor</div>
<div class="line">            dns_resolver: async</div>
<div class="line"> </div>
<div class="line">        dynamic-config:                      # Dynamic config storage options</div>
<div class="line">            defaults:</div>
<div class="line">                POSTGRES_CONNECTION_POOL_SETTINGS:</div>
<div class="line">                    key-value-database:</div>
<div class="line">                        max_pool_size: 15</div>
<div class="line">                        max_queue_size: 200</div>
<div class="line">                        min_pool_size: 8</div>
<div class="line">                POSTGRES_HANDLERS_COMMAND_CONTROL:</div>
<div class="line">                    /v1/key-value:</div>
<div class="line">                        DELETE:</div>
<div class="line">                            network_timeout_ms: 500</div>
<div class="line">                            statement_timeout_ms: 250</div>
<div class="line">                POSTGRES_QUERIES_COMMAND_CONTROL:</div>
<div class="line">                    sample_select_value:</div>
<div class="line">                        network_timeout_ms: 70</div>
<div class="line">                        statement_timeout_ms: 40</div>
<div class="line">                    sample_transaction_insert_key_value:</div>
<div class="line">                        network_timeout_ms: 200</div>
<div class="line">                        statement_timeout_ms: 150</div>
<div class="line">                POSTGRES_STATEMENT_METRICS_SETTINGS:</div>
<div class="line">                    key-value-database:</div>
<div class="line">                        max_statement_metrics: 5</div>
<div class="line"> </div>
<div class="line">        server:</div>
<div class="line">            # ...</div>
</div><!-- fragment --><p>Note the <code>dynamic-config.defaults</code> usage. In <a class="el" href="../../db/d69/md_en_2userver_2tutorial_2production__service.html">production ready service</a> those values are usually retrieved from remote server, so that they could be changed at runtime without any need to restart the service. See <a class="el" href="../../de/d10/md_en_2schemas_2dynamic__configs.html">Dynamic config schemas</a> for more info.</p>
<h2><a class="anchor" id="autotoc_md778"></a>
int main()</h2>
<p>Finally, we add our component to the <a class="el" href="../../dd/d1c/group__userver__components.html#ga44510c5120b67bd36f0ff9f845c68280" title="Returns a list of components to start a basic HTTP server.">components::MinimalServerComponentList()</a>, and start the server with static config <code>kStaticConfig</code>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> component_list = <a class="code hl_function" href="../../dd/d1c/group__userver__components.html#ga44510c5120b67bd36f0ff9f845c68280" title="Returns a list of components to start a basic HTTP server.">components::MinimalServerComponentList</a>()</div>
<div class="line">                                    .<a class="code hl_function" href="../../dc/df0/classcomponents_1_1ComponentList.html#aac1091016f393791732a7da6aaf27f48" title="Appends a component with default component name Component::kName.">Append</a>&lt;samples::pg::KeyValue&gt;()</div>
<div class="line">                                    .Append&lt;components::Postgres&gt;(<span class="stringliteral">&quot;key-value-database&quot;</span>)</div>
<div class="line">                                    .<a class="code hl_function" href="../../dc/df0/classcomponents_1_1ComponentList.html#aac1091016f393791732a7da6aaf27f48" title="Appends a component with default component name Component::kName.">Append</a>&lt;<a class="code hl_class" href="../../d9/de2/classcomponents_1_1TestsuiteSupport.html" title="Testsuite support component.">components::TestsuiteSupport</a>&gt;()</div>
<div class="line">                                    .Append&lt;clients::dns::Component&gt;();</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_function" href="../../d6/d84/namespaceutils.html#a5047c1275f53e699e26869c045ad3697">utils::DaemonMain</a>(argc, argv, component_list);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md779"></a>
Build and Run</h2>
<p>To build the sample, execute the following build steps at the userver root directory: </p><div class="fragment"><div class="line">mkdir build_release</div>
<div class="line">cd build_release</div>
<div class="line">cmake -DCMAKE_BUILD_TYPE=Release ..</div>
<div class="line">make userver-samples-postgres_service</div>
</div><!-- fragment --><p>The sample could be started by running <code>make start-userver-samples-postgres_service</code>. The command would invoke <a class="el" href="../../df/d07/md_en_2userver_2functional__testing.html">testsuite start target</a> that sets proper paths in the configuration files, prepares and starts the DB, and starts the service.</p>
<p>To start the service manually start the DB server and run <code>./samples/postgres_service/userver-samples-postgres_service -c &lt;/path/to/static_config.yaml&gt;</code>.</p>
<p>Now you can send a request to your service from another terminal: </p><div class="fragment"><div class="line">bash</div>
<div class="line">$ curl -X POST &#39;localhost:8085/v1/key-value?key=hello&amp;value=world&#39; -i</div>
<div class="line">HTTP/1.1 201 Created</div>
<div class="line">Date: Wed, 27 Oct 2021 16:45:13 UTC</div>
<div class="line">Content-Type: text/html</div>
<div class="line">X-YaSpanId: 015fb0becd2926ef</div>
<div class="line">X-YaRequestId: 7830671d7dd2462ba9043db532c2b82a</div>
<div class="line">Server: userver/2.0 (20211027123413; rv:c1879aa03)</div>
<div class="line">X-YaTraceId: d7422d7bcdc9493997fc687f8be24883</div>
<div class="line">Connection: keep-alive</div>
<div class="line">Content-Length: 5</div>
<div class="line"> </div>
<div class="line">world</div>
<div class="line">$ curl -X POST &#39;localhost:8085/v1/key-value?key=hello&amp;value=nope&#39; -i</div>
<div class="line">HTTP/1.1 409 Conflict</div>
<div class="line">Date: Wed, 27 Oct 2021 16:45:56 UTC</div>
<div class="line">Content-Type: text/html</div>
<div class="line">X-YaSpanId: e1e2702b87ceeede</div>
<div class="line">X-YaRequestId: 4f677a7cd405418ea412fd4ec540676a</div>
<div class="line">Server: userver/2.0 (20211027123413; rv:c1879aa03)</div>
<div class="line">X-YaTraceId: 203870322f704b308c4322bd44b354ed</div>
<div class="line">Connection: keep-alive</div>
<div class="line">Content-Length: 5</div>
<div class="line"> </div>
<div class="line">world</div>
<div class="line">$ curl -X DELETE &#39;localhost:8085/v1/key-value?key=hello&amp;value=world&#39; -i</div>
<div class="line">HTTP/1.1 200 OK</div>
<div class="line">Date: Wed, 27 Oct 2021 16:46:35 UTC</div>
<div class="line">Content-Type: text/html</div>
<div class="line">X-YaSpanId: e83698e2ef8cc729</div>
<div class="line">X-YaRequestId: ffbaacae38e64bb588affa10b928b759</div>
<div class="line">Server: userver/2.0 (20211027123413; rv:c1879aa03)</div>
<div class="line">X-YaTraceId: cd3e6acc299742739bb22c795b6ef3a7</div>
<div class="line">Connection: keep-alive</div>
<div class="line">Content-Length: 1</div>
<div class="line"> </div>
<div class="line">1</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md780"></a>
Functional testing</h2>
<p><a class="el" href="../../df/d07/md_en_2userver_2functional__testing.html">Functional tests</a> for the service could be implemented using the testsuite. To do that you have to:</p>
<ul>
<li>Turn on the <a class="el" href="../../df/d1c/namespacepytest__userver_1_1plugins_1_1postgresql.html" title="Plugin that imports the required fixtures to start the database and adjusts the PostgreSQL &quot;dbconnect...">pytest_userver.plugins.postgresql</a> plugin and provide PostgreSQL schema to start the database: <div class="fragment"><div class="line"><span class="keyword">import</span> pytest</div>
<div class="line"> </div>
<div class="line"><span class="keyword">from</span> testsuite.databases.pgsql <span class="keyword">import</span> discover</div>
<div class="line"> </div>
<div class="line">pytest_plugins = [<span class="stringliteral">&#39;pytest_userver.plugins.postgresql&#39;</span>]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">@pytest.fixture(scope=&#39;session&#39;)</span></div>
<div class="line"><span class="keyword">def </span>pgsql_local(service_source_dir, pgsql_local_create):</div>
<div class="line">    databases = discover.find_schemas(</div>
<div class="line">        <span class="stringliteral">&#39;admin&#39;</span>, [service_source_dir.joinpath(<span class="stringliteral">&#39;schemas/postgresql&#39;</span>)],</div>
<div class="line">    )</div>
<div class="line">    <span class="keywordflow">return</span> pgsql_local_create(list(databases.values()))</div>
</div><!-- fragment --> The <a class="el" href="../../dc/db7/group__userver__testsuite__fixtures.html#gae69bdc9e879f4e45233fba123d7b699f">auto_client_deps</a> fixture already knows about the pgsql fixture, so there's no need to override the <a class="el" href="../../dc/db7/group__userver__testsuite__fixtures.html#ga7fc327f52c588f33b3a66fcacb6b8783">extra_client_deps</a> fixture.</li>
<li>Write the test: <div class="fragment"><div class="line"><span class="keyword">async def </span>test_postgres(service_client):</div>
<div class="line">    response = await service_client.delete(<span class="stringliteral">&#39;/v1/key-value?key=hello&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line"> </div>
<div class="line">    response = await service_client.post(<span class="stringliteral">&#39;/v1/key-value?key=hello&amp;value=world&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 201</div>
<div class="line">    <span class="keyword">assert</span> <span class="stringliteral">&#39;text/plain&#39;</span> <span class="keywordflow">in</span> response.headers[<span class="stringliteral">&#39;Content-Type&#39;</span>]</div>
<div class="line">    <span class="keyword">assert</span> response.text == <span class="stringliteral">&#39;world&#39;</span></div>
<div class="line"> </div>
<div class="line">    response = await service_client.get(<span class="stringliteral">&#39;/v1/key-value?key=hello&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line">    <span class="keyword">assert</span> <span class="stringliteral">&#39;text/plain&#39;</span> <span class="keywordflow">in</span> response.headers[<span class="stringliteral">&#39;Content-Type&#39;</span>]</div>
<div class="line">    <span class="keyword">assert</span> response.text == <span class="stringliteral">&#39;world&#39;</span></div>
<div class="line"> </div>
<div class="line">    response = await service_client.delete(<span class="stringliteral">&#39;/v1/key-value?key=hello&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 200</div>
<div class="line"> </div>
<div class="line">    response = await service_client.post(<span class="stringliteral">&#39;/v1/key-value?key=hello&amp;value=there&#39;</span>)</div>
<div class="line">    <span class="keyword">assert</span> response.status == 201</div>
<div class="line">    <span class="keyword">assert</span> <span class="stringliteral">&#39;text/plain&#39;</span> <span class="keywordflow">in</span> response.headers[<span class="stringliteral">&#39;Content-Type&#39;</span>]</div>
<div class="line">    <span class="keyword">assert</span> response.text == <span class="stringliteral">&#39;there&#39;</span></div>
</div><!-- fragment --></li>
</ul>
<h1><a class="anchor" id="autotoc_md781"></a>
Full sources</h1>
<p>See the full example:</p><ul>
<li><a class="el" href="../../dd/dd2/samples_2postgres_service_2postgres_service_8cpp-example.html">samples/postgres_service/postgres_service.cpp</a></li>
<li><a class="el" href="../../da/daa/samples_2postgres_service_2static_config_8yaml-example.html">samples/postgres_service/static_config.yaml</a></li>
<li><a class="el" href="../../d5/dbe/samples_2postgres_service_2CMakeLists_8txt-example.html">samples/postgres_service/CMakeLists.txt</a></li>
<li><a class="el" href="../../d2/d55/samples_2postgres_service_2tests_2conftest_8py-example.html">samples/postgres_service/tests/conftest.py</a></li>
<li><a class="el" href="../../d4/d59/samples_2postgres_service_2tests_2test_postgres_8py-example.html">samples/postgres_service/tests/test_postgres.py</a></li>
</ul>
<hr  />
<p> <div class="bottom-nav">  ⇦ <a class="el" href="../../d5/db9/md_en_2userver_2tutorial_2grpc__middleware__service.html">gRPC middleware</a> | <a class="el" href="../../d5/d81/md_en_2userver_2tutorial_2mongo__service.html">MongoDB service</a> ⇨  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Oct 21 2024 13:56:00 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.10.0</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" id='github_header' rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/>
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink generic_tg_link">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_search_hotkey();
      init_header();
      addLinks();
      changeTelegramChannelLanguageForRussianSpeakingUser();
      document.getElementById("side-nav").style.display = "none";
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons();
    }, 0);
    });
  });
</script>
<script type="module" src="../../toc.js"></script>
</body>
</html>
